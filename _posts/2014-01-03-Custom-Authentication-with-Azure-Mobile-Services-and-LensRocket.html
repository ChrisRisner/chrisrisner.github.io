---
layout: post
title: "Custom Authentication with Azure Mobile Services and LensRocket"
date: Fri Jan 03 2014 09:33:00 GMT-0800 (PST)
comments: true
status: publish
type: post
published: true
categories: [Azure, Javascript, Mobile Services]
excerpt: "This article covers how custom authentication was implemented for the LensRocket application using Azure Mobile Services custom API and shared scripts capability."
logoUrl: null
keywords: Mobile Services,LensRocket,Azure,Azure Mobile,auth,custom auth,authentication,scripts,javascript,node,shared script
filepath: 2014-01-03-Custom-Authentication-with-Azure-Mobile-Services-and-LensRocket.html
disqus_identifier: Custom-Authentication-with-Azure-Mobile-Services-and-LensRocket
redirect_from: 
  - /Custom-Authentication-with-Azure-Mobile-Services-and-PikShare.html
  - /Custom-Authentication-with-Azure-Mobile-Services-and-PikShare/
---
<p><img title="SplashScreen for LensRocket" style="float: right; margin: 0px 0px 5px 5px; display: inline" alt="SplashScreen for LensRocket" src="https://crcomcstorage.blob.core.windows.net/images/lensrocket-splashscreen.png" width="233" align="right" height="462" />
<strong>Update 4/22/2014: Version 1 JWTs have been deprecated.  Make sure you <a href="http://chrisrisner.com/Version-1-of-the-Mobile-Services-JWT-token-has-been-deprecated" title="Update to JWT Creation">check out this post</a> to see how the script for JWT creation needs to be changed.</strong>
<br/><br/>
<strong>Update 2/20/2014: Due to a few issues, the app formally known as PikShare has been renamed LensRocket. Everything except some names remains the exact same as the originally released source code and application.</strong>
<br /><br />
With the app I recently released, <a title="LensRocket" href="http://chrisrisner.com/LensRocket--A-Photo-and-Video-Sharing-App-Built-with-Windows-Azure">LensRocket</a>, I wanted to implement custom authentication.&#160; I had already setup <a title="Custom Auth with Azure Mobile Services" href="http://chrisrisner.com/Authentication-with-Windows-Azure-Mobile-Services">custom authentication with Mobile Services</a> last year, however, Mobile Services has launched a few different new features which makes doing custom auth a bit easier / make more sense.&#160; The previous method was based off an <a title="Custom identity with Mobile Services" href="http://www.thejoyofcode.com/Exploring_custom_identity_in_Mobile_Services_Day_12_.aspx">early demonstration of doing custom auth</a> which was created by Josh Twist and made use of a table based script to handle both user account registration as well as authenticating and logging users in.&#160; This works fine but now that Mobile Services has Custom APIs which allow you to define functionality for different HTTP methods for a custom endpoint, it seems like this would be a good place to put this functionality.&#160; That’s easy enough, but there is a lot of code for generating a JSON Web Token, creating a HASH, and making a SALT.&#160; Since this code is used in both the login and register functionality, we need to have this code accessible in both places.&#160; Another feature of Mobile Services, shared scripts, helps solve this problem.&#160; Let’s look at that in a bit more detail how we can make authentication a bit easier using these newer capabilities.</p>  <p><strong>Creating a shared script</strong></p>  <p>Turning on script source control is a very easy process once you have a Mobile Service.&#160; Go to the <strong>Dashboard</strong> tab for your Mobile Service and after a few seconds, you’ll see a link to <strong>Set up source control</strong> on the right side under <strong>quick glance</strong>:</p>  <p align="center"><img title="Setting up script source control" alt="Setting up script source control" src="https://crcomcstorage.blob.core.windows.net/images/wa-portal-setup-script-source.jpg" /></p>  <p>Once you’ve done that, you’ll be taken to the <strong>Configure </strong>tab where you can see the URL for your Mobile Service’s GIT repository as well as a URL you can use to trigger a deployment (just go to the URL in the browser).&#160; Once you’ve cloned the GIT repository locally, you can then edit all of your scripts (table, custom api, and scheduler scripts) as well as create and modify shared scripts.&#160; These shared scripts allow you to define functionality which you can then pull into any of your other scripts.&#160; In this case, we’re going to take the <strong>createSalt</strong>, <strong>hash</strong>, <strong>zumoJwt</strong>, and <strong>slowEquals</strong> methods and put them all into a shared script file (called <strong>jwthelper.js</strong> for LensRocket).&#160; Not all of these methods are used in both the login and register methods but it’s a good place to put all this similar code:</p>  <p><script src="https://gist.github.com/ChrisRisner/8141068.js?file=jwthelper.js"></script></p>  <p>Note that we’re going to pass the master key into this script when it’s needed.&#160; If we wanted to we could also pull the master key value directly into this script by requiring the mobileservice-config module and using that to access the masterKey property.&#160; One difference I had to make in the midst of working on LensRocket was the addition of an expiration in the JWT creation method.&#160; Expiration is now required.&#160; I didn’t want the users to be kicked out unless they actively logged out so I’m setting the expiration to be sometime in the future (like ten years in the future).&#160; If you wanted users to be more regularly forced to log in, you would just need to alter the expiration to be a (much) smaller value.&#160; Now that I’ve added that file, I can make use of all of those methods from any of my other scripts.</p>  <p><strong>Simplifying our Login and Register</strong></p>  <p>Now that we’ve moved that code to our shared script, our login and register custom APIs become all about the logic and not about the cruft of creating the underlying JWT stuff.&#160; First up is our register API:</p>  <p><script src="https://gist.github.com/ChrisRisner/8141068.js?file=register.js"></script></p>  <p>The first thing we have is our <strong>require</strong> line which pulls in our shared script.&#160; From there, we get to our actual Register method.&#160; We first check that the length of the password is at least 7 characters and then that the email address used doesn’t already exist.&#160; You could do any other sort of password validation (i.e. at least X different types of characters) here.&#160; Once we know everything is good we can generate a JWT, save our account data, and send it back to the calling application.&#160; For logging in, pull out the record that matches the username / email address sent in and then compare the password hash against the one saved.&#160; Finally we create a JWT and hand it back:</p>  <p><script src="https://gist.github.com/ChrisRisner/8141068.js?file=login.js"></script></p>  <p><strong>Summary</strong></p>  <p>Today we saw how shared scripts help simplify the functionality in our Mobile Service scripts.&#160; We also saw how we can use Custom APIs to simplify the design of our backend and avoid using table scripts as virtual endpoints.&#160; As more features are added to Mobile Services you’ll see even more elegant solutions to problems like Custom Auth.&#160; You can check out both the <a title="LensRocket Source Code" href="http://aka.ms/androidlensrocket">Android client code and the server side scripts for LensRocket</a> here.</p>