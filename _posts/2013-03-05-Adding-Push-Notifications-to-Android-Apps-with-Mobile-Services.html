---
layout: post
title: "Adding Push Notifications to Android Apps with Mobile Services"
date: Mon Mar 04 2013 21:33:00 GMT-0800 (PST)
comments: true
status: publish
type: post
published: true
categories: [Android, Azure, Java, Mobile Services]
excerpt: "This post walks through adding push notification support to the Android quick start application for Mobile Services.  It will demonstrate how to create a project in Google's API console and tie your Mobile Service to it as well as how to push to your application using GCM."
logoUrl: null
keywords: Android,Mobile Services,Windows Azure,Azure,BAAS,push notifications,push,gcm,google,google cloud messaging
filepath: 2013-03-05-Adding-Push-Notifications-to-Android-Apps-with-Mobile-Services.html
disqus_identifier: Adding-Push-Notifications-to-Android-Apps-with-Mobile-Services
---
<p><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 5px 5px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Windows Azure Mobile Services" border="0" alt="Windows Azure Mobile Services" align="right" src="http://storage.chrisrisner.com/images/wams-logo-android.jpg" width="165" height="244" />With today’s release of the <a href="http://chrisrisner.com/Announcing-Android-Support-for-Mobile-Services">Android SDK</a> for <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Windows Azure Mobile Services</a>, I thought it would be a good idea to post a walkthrough of adding some features into the quick start application.&#160; The quick start, which you can download after spinning up a new Mobile Service, is a ToDo list.&#160; It’s a rather simple application which already makes use of the structured data storage capabilities of Mobile Services to save, update, and read todo items.&#160; In this post, we’ll look at how to push a notification out to each user whenever a todo item is added.&#160; On it’s own, this may not be very desirable behavior in an application (unless everyone else running it will do my todos for me), but you can combine the concepts from this post with others (like authentication) to push to a specific user if you want to.&#160; There are a number of steps we need to take once we have the todo list quick start application, but let’s start with that.</p>  

<p><strong>Update: Android SDK Version Support</strong></p> <p>
Since a few people have asked or thought differently, I wanted to clear up what versions of Android are supported by the Mobile Services SDK.  The short answer is 2.2 (or level 8) and up.  The Mobile Services SDK will build and run with any device running 2.2 or greater.  The reason why the quick start application requires 4.2 (level 17) is that it has it's <strong>targetSdkVersion</strong> in it's manifest file set to 4.2.  That's all.  The app will still run on 2.2, it's just set to build against 4.2.
</p>

<p><strong>Creating a Mobile Service and getting the quick start app</strong></p>  <p>Since I’ve covered this aspect of getting started with Mobile Services on <a title="Getting Started with Mobile Services" href="http://chrisrisner.com/Adding-Auth-and-Logging-out-of-an-iOS-Windows-Azure-Mobile-Services-App">several occasions</a> (and it’s very straight forward) I’m going to glaze over some of the details.&#160; If you don’t already have a Windows Azure account, you can <a title="Free Windows Azure Trial" href="https://www.windowsazure.com/en-us/pricing/free-trial/">sign up for one for free here</a>.&#160; Once you’ve done that, you’ll have access to create 10 free Mobile Services.&#160; Next, you can <a title="Getting started with Android and Mobile Services" href="http://channel9.msdn.com/Series/Windows-Azure-Mobile-Services/Android-Support-in-Windows-Azure-Mobile-Services">watch this video</a> to step through how to create your first Mobile Service and download the Android quick start application.&#160; If you don’t feel like watching the video, I’ll summarize the steps you need to take after logging into the portal.</p>  <p>Start by clicking the <strong>+ NEW</strong> button in the bottom left.&#160; Select <strong>COMPUTE</strong> then <strong>MOBILE SERVICE</strong> and click <strong>CREATE</strong>.&#160; Enter a unique name for your Mobile Service (this is how your Mobile Service will be labeled in the portal and part of the URL that will point at your service), choose if you want to create a new or use an existing database (if you have any) and pick a <strong>REGION</strong> (data center) before proceeding.&#160; On the next screen, either choose to create a new server and enter admin credentials for it or pick an existing server / database and enter the creds for it.&#160; Click the check mark and your Mobile Service will start being created.&#160; After a little bit (it usually takes about twenty to thirty seconds) you can click on your Mobile Service and you’ll first be taken to the quick start page.&#160; Here, under <strong>CHOOSE PLATFORM</strong> select <strong>ANDROID</strong> and then follow the guide under <strong>Create a new Android app</strong>.&#160; Note that the first step isn’t necessary if you already have an IDE (we’ll assume Eclipse) with the Android SDK (at least 4.2) and ADT installed.&#160; Once you’ve created the <strong>TodoItem Table</strong> you can download your project.&#160; Next in Eclipse, go to <strong>Import</strong> under the <strong>File</strong> menu and choose <strong>Existing Projects into Workspace</strong>.&#160; Navigate to your project and select it and it should be imported into Eclipse and show up in the <strong>Package Explorer</strong>.&#160; If you want to, you can run the project now to see what the Todo list app looks like, but we’ll proceed on with adding authentication.</p>  <p><strong>Getting set up in the Google API Console</strong></p>  <p>The first step to getting ready to do push notifications requires us to go to the <a title="Google API Console" href="https://code.google.com/apis/console">Google API Console</a>.&#160; If you’ve never been to the API console before, you should be easily directed to create a new project.&#160; If not, open the drop down in the top left and go to <strong>Create</strong> under <strong>Other Projects</strong> (assuming you haven’t already created the project you want to use).&#160; Name your project whatever you want (the name will only be used to identify it in the API console).&#160; After creating or navigating to your project, the first screen you should see is the <strong>Services </strong>page.&#160; If not, click on the <strong>Services</strong> link in the top left of the console.&#160; You want to go down the list of services and find <strong>Google Cloud Messaging for Android</strong> and click the <strong>OFF </strong>toggle so it turns to <strong>ON</strong>:</p>  <p align="center"><img title="Turning on GCM" alt="Turning on GCM" src="http://storage.chrisrisner.com/images/wams-android-turn-on-gcm.jpg" /></p>  <p>Next, click the <strong>API Access </strong>link in the top left of the page.&#160; On the next page, you’ll see a <strong>Create new Server key… </strong>button, click that:</p>  <p align="center"><img title="Creating a server key for GCM" alt="Creating a server key for GCM" src="http://storage.chrisrisner.com/images/wams-gcm-servery-key.jpg" /></p>  <p>In the modal that appears, you could restrict IP addresses that would be allowed to make requests to GCM with this key, however, we’ll leave this blank since we don’t want to lock ourselves down.&#160; Click the <strong>Create</strong> button:</p>  <p align="center"><img title="Creating the GCM Server Key" alt="Creating the GCM Server Key" src="http://storage.chrisrisner.com/images/wams-gcm-create-server-key.jpg" width="410" height="254" /></p>  <p>After that, you’ll have a new <strong>API key</strong> that will be valid for<strong> </strong>any IP:</p>  <p align="center"><img title="GCM Server key with IP unlocked" alt="GCM Server key with IP unlocked" src="http://storage.chrisrisner.com/images/gcm-server-key-ip-unlocked.jpg" /></p>  <p>Copy the API key value and return to the Windows Azure Portal.&#160; Once there, navigate to the <strong>PUSH </strong>tab for your Mobile Service.&#160; At the bottom of the <strong>PUSH</strong> page, you’ll be able to copy the <strong>API key </strong>in under <strong>google cloud messaging settings</strong>:</p>  <p align="center"><img title="GCM Settings in WA Portal" alt="GCM Settings in WA Portal" src="http://storage.chrisrisner.com/images/wams-gcm-settings.jpg" /></p>  <p>After that, go ahead and click the save button.&#160; </p>  <p><strong>Installing the GCM Android Library</strong></p>  <p>If you haven’t done so already, open up the <strong>Android SDK Manager</strong>.&#160; In Eclipse, you can do this by going to the <strong>Window</strong> menu and selecting <strong>Android SDK Manager</strong> or you can click the little Android button with the down arrow (it’s the one on the left in this image):</p>  <p align="center"><img title="Android buttons in Eclipse" alt="Android buttons in Eclipse" src="http://storage.chrisrisner.com/images/eclipse-android-buttons.jpg" /></p>  <p>In the window that pops up, find the <strong>Extras</strong> folder and locate <strong>Google Cloud Messaging for Android Library</strong>.&#160; Check the box next to it (if it’s showing up with a <strong>Status</strong> of <strong>Not installed</strong>) and click the <strong>Install </strong>button in the bottom right:</p>  <p align="center"><img title="Android SDK Manager" alt="Android SDK Manager" src="http://storage.chrisrisner.com/images/eclipse-install-gcm-library.jpg" width="546" height="389" /></p>  <p>Next, browse to the SDK path (in the image above it’s <strong>/Users/chrisner/code/android-sdk/macosx)</strong> and then go to the <strong>/extras/google/gcm/gcm-client/dist</strong> folder.&#160; Copy the <strong>gcm.jar</strong> from this folder into the <strong>libs </strong>folder of your project.&#160; This is the library that will enable you to hook into <strong>Google Cloud Messaging</strong> from your Android application.&#160; </p>  <p><strong>Setting up your manifest</strong></p>  <p>The next step is to return to Eclipse and open your <strong>AndroidManifest.xml</strong> file.&#160; Switch to xml view by clicking the <strong>AndroidManifest.xml</strong> tab at the bottom of the editor window.&#160; You should already see the <strong>android.permission.INTERNET</strong>, go ahead and paste this code beneath it:</p>  <p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=permissions.xml"></script></p>  <p>One thing to point out is that here, I’ve put my own application’s package <strong>com.example.chrisandroid</strong> into the xml.&#160; Make sure you replace this with your own app package (which you can find at the top of the manifest xml).&#160; Next, find the <strong>&lt;/application&gt;</strong> tag and paste this xml in above it:</p>  <p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=receiver.xml"></script></p>  <p>Again, make sure you replace the <strong>com.example.chrisandroid</strong> with whatever your package is.</p>  <p><strong>Adding a class to handle registration IDs</strong></p>  <p>When our app registers with GCM, we’re going to get back a registration ID that identifies our device and app to the GCM servers.&#160; We’re going to save this data to a separate table in Mobile Services so we need to add a new data object to handle that.&#160; In Eclipse, right click on your project’s package and go to <strong>New</strong> and <strong>Class</strong>.&#160; We’ll name this class <strong>Registration</strong>.&#160; We’ll add the default <strong>id</strong> property to this object as well as a property to handle storing the <strong>Registration ID</strong>:</p>  <p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=registration.java"></script></p>  <p>Now let’s work on getting the registration ID.</p>  <p><strong>Registering with GCM</strong></p>  <p>Open up your <strong>ToDoActivity.java </strong>class and add this <strong>import</strong> statement to the top of the file:</p>  <blockquote>   <pre><code>import com.google.android.gcm.GCMRegistrar;</code></pre>
</blockquote>

<p>Now that you’re importing <strong>GCMRegistrar</strong>, we can proceed by adding these two private variables to the class:</p>

<p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=privateVars.java"></script></p>

<p>Make sure your <strong>SENDER_ID</strong> matches up with the ID of your project in the <strong>Google API Console</strong>.&#160; For example, if I return to where we left off in the console, my URL is showing up as https://code.google.com/apis/console/b/0/#project:794994939600:access.&#160; Now go ahead and add the following code after you instantiate your <strong>MobileServiceClient</strong>:</p>

<p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=register.java"></script></p>

<p>This code will essentially start the registration process if you haven’t already registered.&#160; Now we need to add a class to handle both getting the registration message back and receiving messages from the GCM server.</p>

<p><strong>Inheriting GCMBaseIntentService</strong></p>

<p>Right click on your package in Eclipse again and go to <strong>New </strong>and choose <strong>Class</strong>.&#160; Name your class <strong>GCMIntentService</strong> and set it’s superclass to <strong>com.google.android.gcm.GCMBaseIntentService</strong>.&#160; Start by dropping these <strong>import </strong>statements into the top of your file:</p>

<p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=intentServiceImports.java"></script></p>

<p>These libraries will be used to trigger a notification when a message is received.&#160; Now add the following constructor into your class:</p>

<p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=isConstructor.java"></script></p>

<p>This will handle calling the super constructor with the project ID you set in <strong>ToDoActivity.java</strong>.&#160; By default a number of methods were added to the class because of the base class you inherited from:&#160; <strong>onError</strong>, <strong>onMessage</strong>, <strong>onRegistered</strong>, and <strong>onUnregistered</strong>.&#160; We’re only going to implement two of these methods but we’ll talk about the other two later on.&#160; Let’s implement <strong>onMessage</strong> first:</p>

<p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=onMessage.java"></script></p>

<p>Here we’re using <strong>NotificationCompat</strong>, which is part of the compatibility library, to build a notification.&#160; We then use <strong>NotificationManager</strong> to send the notification.&#160; This means it will show up in the notification drop down you see when you drag down from the top of the device.&#160; Next, we’ll implement the <strong>onRegistered</strong> method.&#160; I’m going to preface this by saying that this is <strong>NOT THE IDEAL WAY TO HANDLE THIS</strong> (I’ll explain more in a minute):</p>

<p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=onRegistered.java"></script></p>

<p>Here we’re creating a <strong>MobileServiceClient</strong> again.&#160; If I were building a real app, I would probably abstract my MobileServiceClient away so that I only create one instance of it and don’t have to repeat the URL or key (make sure you replace those with your own values before using this code by the way).&#160; However, since we’re trying to keep this brief, I’ve recreated it here.&#160; Next we get a <strong>MobileServiceTable</strong> for our <strong>Registration </strong>class and create a new instance of <strong>Registration </strong>and set it’s registration ID to the value returned from the GCM server.&#160; Last, we insert that into our table and log whether it was successful or not.&#160; We’re almost ready to run our app.</p>

<p><strong>Handling things in the portal</strong></p>

<p>Before we can run things, we need to go back to the portal.&#160; Go to the <strong>DATA</strong> tab and create a new table named <strong>Registration</strong>.&#160; You can leave the permissions as the default.&#160; Lastly, go to the TodoItem table and open it’s <strong>SCRIPT </strong>tab.&#160; Go to it’s <strong>Insert</strong> script and replace it with this:</p>

<p><script src="https://gist.github.com/ChrisRisner/5036154.js?file=insertTodo.js"></script></p>

<p>This script handles inserting the todo item and then doing a push using GCM.&#160; It does this by reading the <strong>Registration </strong>table and sending a push through the <strong>push</strong> module’s <strong>gcm</strong> method to each <strong>Registration ID</strong> in the table.&#160; Now you can run your app.</p>

<p><strong>Running the app</strong></p>

<p>Go ahead and run your app (you need to make sure it’s either an emulator running on Google APIs (so it supports GCM) or a device that supports it (i.e. not one from Amazon)).&#160; After your app starts, you should be able to go to the portal and open the <strong>Registration </strong>table and see that a registration has been saved:</p>

<p align="center"><img title="Android Registration ID" alt="Android Registration ID" src="http://storage.chrisrisner.com/images/wams-android-registration.jpg" /></p>

<p>Go ahead and add a todo item.&#160; The first thing you should see after saving it is that an icon appears in the top left of your emulator or device:</p>

<p align="center"><img title="Push in status bar" alt="Push in status bar" src="http://storage.chrisrisner.com/images/wams-android-push-in-bar.jpg" width="468" height="315" /></p>

<p>This icon signifies that we’ve received a notification that is showing up in our Notification Manager.&#160; Now if you drag down from the top of the screen, you’ll see your notification:</p>

<p align="center"><img title="GCM Push Received" alt="GCM Push Received" src="http://storage.chrisrisner.com/images/wams-gcm-push-received.jpg" width="457" height="279" /></p>

<p>Congratulations.&#160; With that you’ve received your first push notification from GCM using Mobile Services.&#160; </p>

<p><strong>Conclusion</strong></p>

<p>Today we walked through the steps necessary to add push notifications to your applications using Google Cloud Messaging and Windows Azure Mobile Services.&#160; There were a few methods we didn’t implement in the intent service including <strong>onError</strong> and <strong>onUnregistered</strong>.&#160; In a real application you would want to do something in these method so you would understand what was going on.&#160; For example, if you receive a message to <strong>onRegistered</strong>, you should let your server know to no longer send push notifications to that registration Id.&#160; Additionally, in <strong>ToDoActivity.java</strong> we were checking to see if <strong>GCMRegistrar.getRegistrationid(…)</strong> was set or not.&#160; If it is, you may want to check to see if you have already saved it to the server and if not, save it.&#160; Lastly, you’ll probably also want some way of making sure you don’t insert the same registration ID multiple times on the server (by deduping in the insert script for the <strong>Registration</strong> table).&#160; There are many improvements you could make over this sample but it should get you started with pushing information to your Android applications.&#160; You can <a title="GCM Push Sample" href="http://storage.chrisrisner.com/codesamples/wams-gcm-push.zip">access the completed source code for this application here</a>.&#160; Remember that you’ll need to set your URL and app key in both the <strong>ToDoActivity</strong> and <strong>GCMIntentService</strong> classes in addition to getting things set up on the server (create the tables and set the insert script for <strong>TodoItem</strong>).&#160; Good luck with Mobile Services and let me know if you build anything with it.</p>