---
layout: post
title: "Android, Push Notifications, and Azure"
date: Fri Sep 05 2014 09:35:00 GMT-0700 (PDT)
comments: true
status: publish
type: post
published: true
categories: [Android, Azure, Java, Javascript]
excerpt: "This post walks through using Azure Push Notifications to perform broadcast and targeted push notifications as well as how template based push can ease pushing to different platforms at the same time."
logoUrl: null
keywords: Azure,android,push notifications,notification hubs,azure notification hubs,push,cross-platform,template,tag,broadcast,gcm
filepath: 2014-09-05-Android,-Push-Notifications,-and-Azure.html
disqus_identifier: Android,-Push-Notifications,-and-Azure
---
{% include special/mobile_services_to_apps.html %}

<p><img style="margin: 0px 0px 5px 5px; display: inline" src="http://storage.chrisrisner.com/images/logo_notification_hubs.jpg" width="171" align="right" height="168" />A while back (a year ago counts as awhile back, right?), I <a title="GA of Notification Hubs" href="http://chrisrisner.com/Announcing-Notification-Hubs-General-Availability">posted</a> about the General Availability of <a title="Azure Notification Hubs" href="http://azure.microsoft.com/en-us/documentation/services/notification-hubs/">Azure Notification Hubs</a>.&#160; Since then, I’ve given a few presentations at different conferences (TechEd, AnDevCon, CocoaConf, 360iDev, etc) on how you can make use of Notification Hubs to power your push notifications.&#160; However, I haven’t really posted about it or released sample code demonstrating how it works on the different platforms.&#160; Technically, I did release a very comprehensive app, named <a title="LensRocket for Android" href="http://chrisrisner.com/LensRocket--A-Photo-and-Video-Sharing-App-Built-with-Windows-Azure">LensRocket</a>, that uses Notification Hubs, however, that is a huge sample so if you’re just looking for “how do i do push?” it might be confusing.&#160; Today I’m going to start fixing that by releasing a fairly comprehensive explanation of push focusing on Android clients.&#160; I actually just posted the same <a title="Notification Hubs and iOS" href="http://chrisrisner.com/iOS,-Push-Notifications,-and-Azure">walkthrough for iOS</a> a few days ago.&#160; For clarity sake, and so you don’t have to hop between the two posts, I’m going to reexplain all of the things which both Android and iOS have in common here.&#160; Note that if you want to pull down the completed app, you can access all of the <a title="Android and Notification Hubs Source Code" href="https://github.com/ChrisRisner/Android-Push-Azure-NotificationHubs">source code here in GitHub</a>.</p>  <p><strong>Push Notifications</strong></p>  <p>For those who may not already know, I’ll give a quick overview of what Azure Notification Hubs are and why they exist.&#160; When building client applications (whether they’re iPhone, Android, WinPhone, or WinStore apps) one of the capabilities apps have is to receive Push Notifications.&#160; Push Notifications are a way of delivering information to your app without your app having to go out and request it.&#160; These pushes could inform the user / app of many many different things and just a few examples of them include: you’ve received an email (including increasing a badge number), play a sound, display a message, download some data from a server.&#160; What’s really key here is that you can send this information down to a device without your app needing to request it first, or without your app even running!&#160; This means that push notifications end up being used a LOT.&#160; Fortunately, when you’re building an app (regardless of the platform) it’s pretty simple for you to take advantage of push notifications.&#160; </p>  <p>For each client platform, there is a Push Notification Service (PNS) provided by the vendor primarily responsible for the OS.&#160; So:</p>  <ul>   <li>iOS has Apple Push Notification Service (APNS) </li>    <li>Android has Google Cloud Messaging (GCM) and Amazon Device Messaging (ADM) for Google Android and Amazon Android, respectively </li>    <li>WinPhone has Microsoft Push Notification Service (MPNS) </li>    <li>Windows Store has Windows Notification Service (WNS) </li>    <li>Other OSes provide their own services but are more bit players </li> </ul>  <p>Each of these PNS will provide to your application some identifier that identifies your app and device to the PNS.&#160; Once you get this identifier, you can then use it to talk to the PNS and ask it to deliver a push notification to the device / app.&#160; While you COULD request a push from the same device that you’re running the app on, what is common practice is to have a backend somewhere that you send the identifier to.&#160; This backend can then talk to the PNS and request a push.&#160; This backend could be a website running somewhere, a web service, a virtual machine, a client application, or really anything else capable of making an HTTP request to the PNS.&#160; </p>  <p><strong>Notification Hubs</strong></p>  <p>So far we have a client app, we have a PNS, and we have a backend.&#160; Let’s talk about how Notification Hubs fits into this.&#160; Notification Hubs is basically built to be a pseudo backend / service that will handle talking with the PNSes.&#160; That’s a pretty big simplification though because there is a lot behind that.&#160; First, when your backend asks a PNS to deliver a push notification, every request has to be signed with either an API key or a certificate (depending on which PNS it is).&#160; So not only does NH need to be able to handle taking in the keys / certs and using them for each request, it needs to be capable of updating to new versions as the certs do expire!&#160; While that’s more of administrative details, NH also enables easy targeting of push notifications using Tags (more on this below) as well as enabling single line of code cross-platform push via templates (more on this also below).&#160; Let’s start seeing some code so we understand how this works.</p>  <p><strong>Setting up GCM and Starting on the Client</strong></p>  <p>Today we’re going to be focusing on using GCM to push to Google Android devices.&#160; On the client side, setting up your app for push notifications is probably more complicated for Android than any of the other platforms.&#160; The first step you need to follow is to go to the Google API Console and generate a new project, enable the Google Cloud Messaging API, and then create a Public API Access key.&#160; You can follow along with step by step instructions for doing so <a title="Instructions for Google API Console" href="http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-android-get-started/">here</a>.&#160; Once you’ve done that, you’re ready to proceed with client changes.&#160; Before we edit any files, we need to put the Notification Hubs jar into our <strong>libs </strong>folder.&#160; You can <a href="https://go.microsoft.com/fwLink/?LinkID=280126&amp;clcid=0x409">download the libraries from here</a>.&#160; Make sure to copy over the <strong>notification-hubs-X.jar</strong> and the <strong>notifications-X.jar</strong> into your <strong>libs </strong>folder and then refresh that folder in your IDE.</p>  <p>Next, open the <strong>AndroidManifest.xml </strong>file in your Android project.&#160; We first need to add the necessary permissions inside the <strong>manifest </strong>element:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=ManifestPermissions.xml"></script></p>  <p>Make sure you replace the <strong>PACKAGE</strong> in the bottom two lines with the package of your actual application.&#160; The last step in our manifest is to specify the receiver:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=ManifestReceiver.xml"></script></p>  <p>Again here we need to replace <strong>PACKAGE</strong> with the package of the application.&#160; The <strong>com.microsoft.windowsazure.notifications.NotificationsBroadcastReceiver</strong> is a helper we get from the Notification Hubs library.&#160; Up next we’ll set up our Notification Hub on the server side before we switch back to the client.</p>  <p><strong>Setting up Notification Hubs and your Project</strong></p>  <p>Head over to the Azure Portal and create a new Notification Hub.&#160; If you haven’t done that before, it’s <a title="Setting up the notification Hub" href="http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-android-get-started/">documented here</a>.&#160; Once you’re done with that, go to your Hub in the portal and go to the <strong>CONFIGURE</strong> tab.&#160; Find the area for <strong>google cloud messaging settings</strong>.&#160; Copy the server API Key you got from the Google API Console into this and save the changes.&#160; Next, go to the<strong> DASHBOARD</strong> tab for your service and click on the <strong>CONNECTION INFORMATION </strong>button at the bottom.&#160; You’ll want to copy the Listen and Full Shared Access Signature’s for later.&#160; Now we can head back to the client.</p>  <p><strong>Registering with GCM</strong></p>  <p>We’ll do two things now.&#160; First we’ll handle getting an instance of a GoogleCloudMessaging object and then we’ll set up our Notification Hub for later:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=onCreateCode.java"></script></p>  <p>In the demo app, this code is in my fragment’s <strong>onCreateView </strong>method but you may want it elsewhere.&#160; You’ll need to replace the <strong>NotificationHubName </strong>and <strong>NotificationHubListenSharedAccessSignature</strong> with the values from your Notification Hub (that you just got a second ago).&#160; Next we’ll add a method that will go out to GCM and register.&#160; In the demo app, I’m triggering this from a button tap, but you might want to do it right after you create the GCM object above:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=registerWithGcm.java"></script></p>  <p>Here we’re starting a background async task (to not block the main thread) and telling it to go and register with GCM.&#160; We’re passing in a <strong>SENDER_ID</strong> which should be the Project Number of your project in the Google API Console (note that this is the <strong>Project Number </strong>and NOT the Project ID).&#160; The last thing we need to do before moving on to talking with our Hub is create something to handle receiving push notifications.</p>  <p><strong>The NotificationsHandler</strong></p>  <p>If you’re adding the code to your own project (as opposed to using the referenced demo code), you’ll want to add a new class to your project named <strong>MyHandler </strong>which inherits from <strong>NotificationsHandler</strong>.&#160; Here’s the code for our class:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=MyHandler.java"></script></p>  <p>The <strong>NotificationsHandler</strong> base already handles a few things for us .&#160; All we need to do is override the <strong>onReceive</strong> method and dictate what we want to happen when we receive a notification.&#160; Here we’re calling into a <strong>sendNotification </strong>method which will first use the <strong>NotificiationManager</strong> to display a notification in the status bar at the top of the device.&#160; Then it will also display a toast on the screen of the app.&#160; Now that we’re able to display our notifications when we receive them, we’re ready to start registering with our hub and then sending out push notifications.</p>  <p><strong>Broadcast Push</strong></p>  <p>Broadcast push is a way of doing untargeted push notifications.&#160; In other words, push to all of the Androiddevices that have registered with my hub.&#160; Let’s look at the client side code first:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=registerWithNoTags.java"></script></p>  <p>Here we’re calling <strong>register </strong>on the hub we created earlier and we’re just passing in the registration ID we received from GCM.&#160; When this runs it will contact our hub and basically say “I’m an Android device that is registered with GCM, here’s my registration ID.”&#160; Now let’s look at the server side code to trigger a push.</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=broadcastPush.js"></script></p>  <p>Here you’ll replace the strings in call to <strong>createNotificationHubService</strong> with your hub’s name and the <strong>FULL Access Signature</strong>.&#160; We then use the <strong>notificationHubService</strong> object to call <strong>gcm.send</strong> where we specify the payload we want to send.&#160; Running this script will trigger our hub to push that payload to any Android / GCM device that has connected to the hub.&#160; One other thing to note is that these scripts were created to be run as Mobile Service Custom APIs in order to ease testing out (with the permissions set to Everyone, I can trigger this script by going to the endpoint for it in a browser).&#160; I’ll talk more about connecting to Notification Hubs to trigger pushes later, but for now just know that this same Node.JS Script could run anywhere you can run Node.&#160; You’d just need to pull down the Azure Node Package.</p>  <p><strong>Pushing to Tags</strong></p>  <p>Up next we’ll talk about targeted pushes.&#160; So instead of “Broadcast to everyone” we’ll be able to say “Push to user X” or “Push to this group of users”.&#160; The first step in doing this is registering from the client:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=registerWithTags.java"></script></p>  <p>This is identical to the code we had on our client before except now we’re passing in additional parameters which are tags.&#160; In this case, my array has three tags: <strong>MyTag, AllUsers, </strong>and <strong>AndroidUser</strong>.&#160; When we run this it basically says, “I’m an Android device that is registered with GCM, here’s my push token.&#160; Also, tie it to these three tags.”&#160; What’s great about this is then from our backend, we can tell our hub to only push to devices that are tied to a specific tag, like this:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=targetedPush.js"></script></p>  <p>Here we’re doing the same thing on the server, EXCEPT we’re passing in a first parameter (previously it was null).&#160; In this case we’re passing in the tag <strong>MyTag</strong> so only devices registered with my hub, with GCM, will receive the push notification. </p>  <p><strong>Tag Expressions</strong></p>  <p>Pushing based off of tags is pretty cool.&#160; You could use tags for lots of different things (sports teams, stock ticker labels, zipcode (i.e. geopush), etc).&#160; You could even set the user’s username (if they were logged in) as a tag and then you’d have the ability to say “push to all of Chris’ devices” if you wanted.&#160; Another powerful feature of hubs is called Tag Expressions.&#160; This basically enables you to trigger pushes based off logical expressions of tags.&#160; So for example, if I was registering with the username and a group I’m in, I could say “Push to GROUPNAME except ME”.&#160; So push to everyone in the group I’m in but not my devices.&#160; The actual tag string I would use would probably look something like this “Group:ID &amp;&amp; !User:ID” where the tags I register with might be “Group:ID” and “User:ID”.</p>  <p><strong>Templates</strong></p>  <p>So far we’ve looked at broadcast and targeted based push.&#160; However, all of the pushing we’ve done has been constrained to GCM devices.&#160; If I’m building a cross-platform app, I need to be able to handle pushing to other platforms as well.&#160; Now I could have the same code to do a push to iOS and WinPhone and WinStore right after my <strong>gcm.send</strong> code everywhere I want to do a push, but that’s a decent amount of code.&#160; Especially if I am pushing in many different places.&#160; The alternative to that is using Templates.&#160; When you register with your hub, in addition to sending the push identifier and the tags you want to be tied to, you can also specify a template that indicates the format of the payload you want to receive.&#160; Let’s take a look:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=registerWithTemplate.java"></script></p>  <p>Here we’re creating a template string that contains the <strong>data JSON </strong>format that we previously saw in our server script.&#160; Inside of that payload is the important bit <strong>$(message)</strong>.&#160; From the server side, when we push, it will use that <strong>message </strong>bit to figure out how to format the payload with the data we want to inject.&#160; The other difference here is that we’re now calling <strong>registerTemplateWithDeviceToken</strong>.&#160; Let’s take a look at the Node script to push to our client now:</p>  <p><script src="https://gist.github.com/ChrisRisner/0bb1f83917cdf4c35dea.js?file=templatePush.js"></script></p>  <p>Now we’re creating a <strong>payload</strong> object which is a JSON object with a <strong>message</strong> field in it.&#160; We can then use <strong>notificationHubService.send</strong> (notice there is no <strong>gcm </strong>in the middle anymore) and set the payload as the second parameter (we’re not using a tag to do a targeted push here but we could).&#160; When this runs, it will cause the hub to find any device registration that has a payload with the <strong>message</strong> field in it and format the payload with the data from the payload we’re sending in.&#160; So effectively, when we send to our Android device, we’ll use the <strong>gcm </strong>payload format specified on the client.&#160; If i was doing something for iOS, we’d send it in the iOS specific format, and so on.&#160; So we now have a single line that is capable of handling pushing to any device type!</p>  <p><strong>Talking to Notification Hubs from Your Backend</strong></p>  <p>The idea here is that Notification Hubs can effectively handle all the aspects of Push Notifications for you.&#160; I can have a backend (website or web service) running somewhere, whether its on Azure or not or it’s in .NET or not doesn’t matter at all, and just talk to my Notification Hub whenever I need to trigger a push.&#160; Now in the samples above, I’m trigger my pushes from Node.js scripts which make use of the <a href="https://github.com/Azure/azure-sdk-for-node">Node.js Azure module</a>.&#160; These could be running anywhere but to make things easy, I usually run them from Azure Mobile Services (super quick to get them up and running).&#160; You can also use the <a href="http://azure.microsoft.com/en-us/documentation/articles/mobile-services-javascript-backend-ios-get-started-push/">.NET SDK</a> for triggering push notifications, and their are guides for doing so <a title="Notification Hubs from Java" href="http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-java-backend-how-to/">from Java</a> as well as <a title="Notification Hubs from PHP" href="http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-php-backend-how-to/">from PHP</a>.&#160; Everything in Notification Hubs is also <a title="Notification Hubs REST API" href="http://msdn.microsoft.com/en-us/library/dn223264.aspx">exposed over a REST API</a> so even if there isn’t an SDK or a guide for talking to your hub from your platform of choice to trigger pushes, you can always fall back on the REST API. </p>  <p><strong>Summary</strong></p>  <p>I hope this post proves helpful for anyone looking at using Notification Hubs to handle Android push notifications.&#160; If you also look at the <a title="iOS and Push Notifications" href="http://chrisrisner.com/iOS,-Push-Notifications,-and-Azure">iOS walkthrough</a>, you’ll see that the majority of the code is either the same or very similar.&#160; Notification Hubs are a super easy way to get into doing push notifications for your apps and make it super simple to make them working on different platforms.&#160; Add to all these features the fact that you get <a title="Azure Notification Hubs Pricing" href="http://azure.microsoft.com/en-us/pricing/details/notification-hubs/">1 million push notifications for FREE every month (as of Sept. 1, 2014)</a> and it’s a pretty sweet deal!&#160; You can grab both the <a title="Client and Server Source code for iOS Push Notifications with Notification Hubs" href="https://github.com/ChrisRisner/iOS-Push-Azure-NotificationHubs">client and server source code for the app seen above here</a>.</p>