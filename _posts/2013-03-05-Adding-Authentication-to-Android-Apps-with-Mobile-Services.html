---
layout: post
title: "Adding Authentication to Android Apps with Mobile Services"
date: Mon Mar 04 2013 21:32:10 GMT-0800 (PST)
comments: true
status: publish
type: post
published: true
categories: [Android, Azure, Java, Mobile Services]
excerpt: "This post walks through adding authentication with Google accounts to the Mobile Services quick start application for Android.  It will demonstrate how to create a project in Google's API console and tie your Mobile Service to it."
logoUrl: null
keywords: Android,Mobile Services,Windows Azure,Azure,BAAS,auth,authentication,google account,google auth
filepath: 2013-03-05-Adding-Authentication-to-Android-Apps-with-Mobile-Services.html
disqus_identifier: Adding-Authentication-to-Android-Apps-with-Mobile-Services
---
<p><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 5px 5px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Windows Azure Mobile Services" border="0" alt="Windows Azure Mobile Services" align="right" src="http://storage.chrisrisner.com/images/wams-logo-android.jpg" width="165" height="244" />With today’s release of the <a href="http://chrisrisner.com/Announcing-Android-Support-for-Mobile-Services">Android SDK</a> for <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Windows Azure Mobile Services</a>, I thought it would be a good idea to post a walkthrough of adding some features into the quick start application.&#160; The quick start, which you can download after spinning up a new Mobile Service, is a ToDo list.&#160; It’s a rather simple application which already makes use of the structured data storage capabilities of Mobile Services to save, update, and read todo items.&#160; In this post, we’ll look at how to make this todo list application an individualized application, meaning that each user has their own todo list and can’t see anyone else's data.&#160; We’ll accomplish this by first requiring the user to log in.&#160; Once that’s done, we can save each todo item so it’s tied to the logged in user and then make sure when we read the todo items back to the client application, we’re only getting the todo items for the logged in user.</p>  

<p><strong>Update: Android SDK Version Support</strong></p> <p>
Since a few people have asked or thought differently, I wanted to clear up what versions of Android are supported by the Mobile Services SDK.  The short answer is 2.2 (or level 8) and up.  The Mobile Services SDK will build and run with any device running 2.2 or greater.  The reason why the quick start application requires 4.2 (level 17) is that it has it's <strong>targetSdkVersion</strong> in it's manifest file set to 4.2.  That's all.  The app will still run on 2.2, it's just set to build against 4.2.
</p>

<p><strong>Creating a Mobile Service and getting the quick start app</strong></p>  <p>Since I’ve covered this aspect of getting started with Mobile Services on <a title="Getting Started with Mobile Services" href="http://chrisrisner.com/Adding-Auth-and-Logging-out-of-an-iOS-Windows-Azure-Mobile-Services-App">several occasions</a> (and it’s very straight forward) I’m going to glaze over some of the details.&#160; If you don’t already have a Windows Azure account, you can <a title="Free Windows Azure Trial" href="https://www.windowsazure.com/en-us/pricing/free-trial/">sign up for one for free here</a>.&#160; Once you’ve done that, you’ll have access to create 10 free Mobile Services.&#160; Next, you can <a title="Getting started with Android and Mobile Services" href="http://channel9.msdn.com/Series/Windows-Azure-Mobile-Services/Android-Support-in-Windows-Azure-Mobile-Services">watch this video</a> to step through how to create your first Mobile Service and download the Android quick start application.&#160; If you don’t feel like watching the video, I’ll summarize the steps you need to take after logging into the portal.</p>  <p>Start by clicking the <strong>+ NEW</strong> button in the bottom left.&#160; Select <strong>COMPUTE</strong> then <strong>MOBILE SERVICE</strong> and click <strong>CREATE</strong>.&#160; Enter a unique name for your Mobile Service (this is how your Mobile Service will be labeled in the portal and part of the URL that will point at your service), choose if you want to create a new or use an existing database (if you have any) and pick a <strong>REGION</strong> (data center) before proceeding.&#160; On the next screen, either choose to create a new server and enter admin credentials for it or pick an existing server / database and enter the creds for it.&#160; Click the check mark and your Mobile Service will start being created.&#160; After a little bit (it usually takes about twenty to thirty seconds) you can click on your Mobile Service and you’ll first be taken to the quick start page.&#160; Here, under <strong>CHOOSE PLATFORM</strong> select <strong>ANDROID</strong> and then follow the guide under <strong>Create a new Android app</strong>.&#160; Note that the first step isn’t necessary if you already have an IDE (we’ll assume Eclipse) with the Android SDK (at least 4.2) and ADT installed.&#160; Once you’ve created the <strong>TodoItem Table</strong> you can download your project.&#160; Next in Eclipse, go to <strong>Import</strong> under the <strong>File</strong> menu and choose <strong>Existing Projects into Workspace</strong>.&#160; Navigate to your project and select it and it should be imported into Eclipse and show up in the <strong>Package Explorer</strong>.&#160; If you want to, you can run the project now to see what the Todo list app looks like, but we’ll proceed on with adding authentication.</p>  <p><strong>Setting up Google auth</strong></p>  <p>Today we’re going to add in Google auth to our application.&#160; We start this by going to the <a title="Google API Console" href="https://code.google.com/apis/console">Google API Console</a>.&#160; Just like any of the other auth providers that Mobile Services supports (Facebook, Google, Microsoft, Twitter), the provider has to have some information about your application before you can get some information to do authentication.&#160; If you’ve never been to the API console before, you should be easily directed to create a new project.&#160; If not, open the drop down in the top left and go to <strong>Create</strong> under <strong>Other Projects</strong> (assuming you haven’t already created the project you want to use).&#160; Name your project whatever you want (the name will only be used to identify it in the API console).&#160; After creating or navigating to your project, go to the <strong>API Access</strong> link in the top left.&#160; In the next screen you’ll be able to create an OAuth 2.0 client:</p>  <p align="center"><img title="Google API Console API Access" alt="Google API Console API Access" src="http://storage.chrisrisner.com/images/google-auth-api-access.jpg" /></p>  <p>Click that button and you’ll be able to enter some information about your app:</p>  <p align="center"><img title="Create Client ID" alt="Create Client ID" src="http://storage.chrisrisner.com/images/google-create-client-id.jpg" width="450" height="314" /></p>  <p>Here just enter the information you want.&#160; It’s not necessary for the Home Page URL to match your Mobile Service URL.&#160; Once you’re done, click <strong>Next</strong>.&#160; In the next screen, select <strong>Web application</strong> for the type.&#160; In the <strong>Your site or hostname</strong> box, you’ll put the URL of your Mobile Service (visible in the portal <strong>Dashboard</strong> tab on the right side).&#160; However, you’ll need to enter it with <strong>/login/google</strong> at the end:</p>  <p align="center"><img title="Site or hostname for Google Auth" alt="Site or hostname for Google Auth" src="http://storage.chrisrisner.com/images/google-auth-url.jpg" width="468" height="357" /></p>  <p>Once you tab out or leave that box, the <strong>/login/google </strong>will get hacked off and it will show up in the <strong>Redirect URI</strong>.&#160; It’s really important to make sure this is right or your Google auth won’t work.&#160; Once that’s correct, click the <strong>Create client ID</strong> button.&#160; In the next screen, you’ll be able to see your project’s <strong>Client ID</strong> and <strong>Client secret</strong>:</p>  <p align="center"><img title="google client id and secret" alt="google client id and secret" src="http://storage.chrisrisner.com/images/google-auth-id-secret.jpg" /></p>  <p>These two values need to be copied and placed into the portal.&#160; Return to the Windows Azure portal and go to the Identity tab.&#160; Locate the <strong>google settings</strong> on this page and copy those values over:</p>  <p align="center"><img title="Google Auth in Portal" alt="Google Auth in Portal" src="http://storage.chrisrisner.com/images/google-auth-in-portal.jpg" /></p>  <p>Once that’s done, click save.&#160; Now before you can add auth to your app, you have one more step to take.&#160; Go to the <strong>DATA</strong> tab, click the <strong>TodoItem</strong> table and go to the <strong>PERMISSIONS </strong>tab.&#160; Change the permissions for each operation on the table to <strong>Only Authenticated Users</strong>:</p>  <p align="center"><img title="Only Authenticated Users Permission" alt="Only Authenticated Users Permission" src="http://storage.chrisrisner.com/images/wams-table-permissions-only-auth.jpg" width="307" height="272" /></p>  <p>Click save and now we can move on to the app.</p>  <p><strong>Adding authentication to your Android app</strong></p>  <p>If you run the quick start application right now, you’ll have an error pop up after a few seconds.&#160; This is because it’s unable to load the todo items because you aren’t passing a valid user object over (and we just restricted the table to require that).&#160; If you look in <strong>Logcat</strong> you might even see this warning:</p>  <blockquote>   <p>Authentication error: Unable to respond to any of these challenges: {}</p> </blockquote>  <p>Let’s fix that.&#160; Open up <strong>ToDoActivity.java</strong> and start by adding these <strong>import </strong>statements to that class:</p>  <p><script src="https://gist.github.com/ChrisRisner/5027956.js?file=ToDoActivityAuth.java"></script></p>  <p>Once that is done drop the following method into the <strong>ToDoActivity</strong> class:</p>  <p><script src="https://gist.github.com/ChrisRisner/5027956.js?file=authenticate.java"></script></p>  <p>The first thing we’re doing in this method is calling the <strong>login</strong> method on our <strong>MobileServicesClient</strong> object.&#160; We pass into this the auth provider type we want to authenticate with (<strong>Google </strong>in this case) and a <strong>UserAuthenticationCallback</strong>.&#160; The callback has a method, <strong>onCompleted</strong>, that will be called whenever a response is returned from trying to authenticate (or if the user cancels).&#160; Inside that callback, we’re showing a dialog to let the user if they were authenticated successfully or not and will call a new method, <strong>createTable</strong>, if it was a success.&#160; Next go back to the <strong>onCreate </strong>method and remove all of the code inside the <strong>try catch</strong> block after you instantiate the <strong>MobileServiceClient</strong> and replace it with a call to <strong>authenticate()</strong>.&#160; The last thing we need to do is add the <strong>createTable</strong> method:</p>  <p><script src="https://gist.github.com/ChrisRisner/5027956.js?file=createTable.java"></script></p>  <p>This method performs all of the code that we just removed from <strong>onCreate</strong>.&#160; Now, run your application again.</p>  <p><strong>Authenticating</strong></p>  <p>Now when we run our application, the first thing we’ll get is a login view for <strong>Google</strong>:</p>  <p align="center"><img title="Google Auth for WAMS" alt="Google Auth for WAMS" src="http://storage.chrisrisner.com/images/wams-google-auth-login.jpg" width="272" height="399" /></p>  <p>After you sign in and allow access, you’ll get a popup that says you’re logged in and you’ll then see all of the todo items that you’ve saved:</p>  <p align="center"><img title="Todo Items after logging in" alt="Todo Items after logging in" src="http://storage.chrisrisner.com/images/wams-android-todo-items.jpg" width="254" height="374" /></p>  <p>Now we just need to make the todo list personal.</p>  <p><strong>Connecting saved items to users</strong></p>  <p>The first thing we need to do to make these lists our own is to save the User ID whenever we save a todo item.&#160; To do this, we’ll go to the portal and go to the <strong>DATA</strong> tab.&#160; Open the <strong>TodoItem</strong> table and go to the <strong>SCRIPT</strong> tab.&#160; Inside the <strong>Insert </strong>script, we’re going to add the <strong>userId</strong> to the <strong>item</strong> before we execute the request:</p>  <p><script src="https://gist.github.com/ChrisRisner/5027956.js?file=insert.js"></script></p>  <p>Now when you save a todo item if you browse the data on the portal, you’ll see a user ID has been saved for the latest item:</p>  <p align="center"><img title="saved user ID" alt="saved user ID" src="http://storage.chrisrisner.com/images/wams-android-saving-user-ids.jpg" /></p>  <p>Now we just need to filter so that we only see our own items.</p>  <p><strong>Filtering todo items by user</strong></p>  <p>We could handle this in two ways.&#160; We could do a where clause from the client and ask for only items that match my user ID.&#160; However, when doing mobile app development, you never want to trust the client.&#160; So instead, we’ll go the second route and do this on the server.&#160; Return to the portal and go back to the <strong>SCRIPT </strong>tab for the <strong>TodoItem</strong> table and go to the <strong>Read</strong> script.&#160; Before we execute the request, we’re going to add a new <strong>where</strong> clause to the <strong>query</strong>:</p>  <p><script src="https://gist.github.com/ChrisRisner/5027956.js?file=read.js"></script></p>  <p>Now when we restart our application, we should only see the one todo item we’ve saved with the user ID:</p>  <p align="center"><img title="Filtered Todo Items" alt="Filtered Todo Items" src="http://storage.chrisrisner.com/images/wams-android-filtered-read.jpg" width="241" height="358" /></p>  <p><strong>Conclusion</strong></p>  <p>Today we looked at how you can enhance the Android Mobile Services quick start application by adding authentication.&#160; Furthermore, we looked at how we can take any application and make it a personal experience by saving and filtering information for the current user.&#160; This just scratches the surface of what you can do with Windows Azure Mobile Services and your Android applications.&#160; I’ll be posting more about the Android SDK and how you can really make your Android applications fly with Mobile Services in the future.</p>