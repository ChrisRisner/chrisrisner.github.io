---
layout: post
title: "Windows Azure Mobile Services and Android"
date: Fri Aug 31 2012 09:25:00 GMT-0700 (PDT)
comments: true
status: publish
type: post
published: true
categories: [Android, Azure, Java, Mobile, Mobile Services]
excerpt: "This article covers how to connect an Android client to the new Windows Azure Mobile Services.  We'll walk through how to sign up for Mobile Services and create a new Mobile Service using the Windows Azure portal.  Finally, we'll walk through creating a new Android client that stores and retrieves todos in Mobile Services."
logoUrl: null
keywords: Windows Azure Mobile Services,Windows Azure,Mobile Services,Android,Android and Mobile Services,Todo app example,Java,Eclipse
filepath: 2012-08-31-Windows-Azure-Mobile-Services-and-Android.html
disqus_identifier: Windows-Azure-Mobile-Services-and-Android
---
{% include special/mobile_services_to_apps.html %}

<p><img style="margin: 0px 0px 5px 5px; display: inline; float: right" align="right" src="http://chrisrisner.com/upload/mobile-service-logo-3.png" />
<strong>Since this was posted, Microsoft has released the official Android SDK and support for Mobile Services.  You can read more about the release and how to use the <a href="http://chrisrisner.com/Announcing-Android-Support-for-Mobile-Services">Android SDK here</a>.</strong><br /><br />
After posting yesterday about connecting <a title="Windows Azure Mobile Services and iOS" href="http://chrisrisner.com/Windows-Azure-Mobile-Services-and-iOS">Windows Azure Mobile Services and iOS</a>, I had to follow it up with Android!&#160; Today, I’m happy to release this walkthrough for connecting Android to Mobile Services.&#160; If you read my <a title="Windows Azure Mobile Services" href="http://chrisrisner.com/Announcing-Windows-Azure-Mobile-Services">post from earlier this week</a> on Mobile Services, you’d know that official support for iOS, Android, and Windows Phone 8 is coming.&#160; This means that if you want to download and install pre-built REST helper methods for your non-Windows 8 operating system, you’ll have to wait.&#160; However, since all of the calls to Mobile Services are being done over HTTP and are REST based, it’s pretty easy to see what each call sends over the wire.&#160; This means that we can take that information and write our own code that will run on Android and iOS and hit Mobile Services.&#160; </p>  <p>Today, I’ll continue showing you how to do just that.&#160; In this article, we’ll walk through creating a new Mobile Service and then connecting an Android client to it.&#160; We’ll only use some basic data capabilities provided by Mobile Services but in the coming weeks, I’ll show you how to watch the HTTP calls made by a Windows 8 app (so you can figure out what’s going across the wire) and then how to reproduce some of the more advanced things in both iOS and Android.&#160; By the end of this walkthrough, we’ll have reproduced in an Android client, all of the capabilities of the initial Todos Windows 8 Mobile Services demo. You’ll be able to add new todos, list those todos, and mark todos complete.&#160; Let’s get started.&#160; </p> <p>If you want to dive into the source code without going through the whole tutorial, you can <a href="https://github.com/WindowsAzure-Samples/MobileServices-Android-Client">access the source code on GitHub</a>.</p>  <p>&#160;</p>  <p><strong>Creating a new Mobile Service</strong></p>  <p>In order to create a Mobile Service, you first need to have a Windows Azure account.&#160; You can sign for a <a title="Free Windows Azure Trial" href="http://aka.ms/MobileServicesAndAndroid">free trial here</a>.&#160; This free trial is good for three months of access.&#160; Once you’ve done that, log into your account, and go to the <a title="Windows Azure Account Center" href="https://account.windowsazure.com/PreviewFeatures">Account Center</a>.&#160; From there, access the preview features area of the site.&#160; There you’ll see a button to “try it now”.&#160; </p>  <p><img style="display: block; float: none; margin-left: auto; margin-right: auto" title="Try Mobile Services Now" alt="Try Mobile Services Now" src="http://chrisrisner.com/upload/wa-account-preview.png" /></p>  <p>Go ahead and request access to that and you should be granted access within a short period. Once that is done, go to the portal at <a href="http://manage.windowsazure.com">http://manage.windowsazure.com</a>.&#160; Once you’re logged in to the (awesome HTML5) portal, you’ll see a list of available offerings on the left side.&#160; We’re specifically interested in Mobile Services:</p>  <p><img style="display: block; float: none; margin-left: auto; margin-right: auto" title="Mobile Services in Portal" alt="Mobile Services in Portal" src="http://chrisrisner.com/upload/wa-portal-mobile-services.jpg" /></p>  <p>At the bottom left of the site, you’ll see a big Plus with “New” next to it.&#160; Click on that and go to Mobile Services and then Create:</p>  <p><img style="display: block; float: none; margin-left: auto; margin-right: auto" title="New Mobile Service" alt="New Mobile Service" src="http://chrisrisner.com/upload/wa-portal-new-mobile-service.jpg" /></p>  <p>You’ll then be able to specify the subdomain of your site and choose whether you want to use an existing SQL database or create a new one.&#160; You also get to select a region, but for now only the East US is enabled:</p>  <p><img style="display: block; float: none; margin-left: auto; margin-right: auto" title="Create Mobile Service" alt="Create Mobile Service" src="http://chrisrisner.com/upload/wa-portal-create-mobile-service.jpg" width="451" height="338" /></p>  <p>You’ll then be able to specify database settings.&#160; If you’ve already created one mobile service and a SQL Database Server, you won’t be able to create a new one.&#160; You can create a new SQL database but you will be limited to a single server (under the free preview mode at least).&#160; So if this is your first time through this, create a new SQL Database server, and if not, either use your existing database, or create a new SQL database.</p>  <p align="center"><img title="New DB Settings" alt="New DB Settings" src="http://chrisrisner.com/upload/wa-portal-mobser-new-db.jpg" width="458" height="331" /></p>  <p>One other note about this screen.&#160; When you create a SQL Database Server for the first time, <strong>REMEMBER YOUR USERNAME AND PASSWORD</strong>.&#160; Write it down somewhere or store it in a password program.&#160; If you want to add a new database to your server, you’ll need the credentials you first used to create the server.&#160; When that’s done, click the checkmark and your new mobile service will be added to your list and will show itself as being created:</p>  <p align="center"><img title="Creating the Site" alt="Creating the Site" src="http://chrisrisner.com/upload/wa-portal-site-creating.jpg" /></p>  <p>After a few moments, you should see the site switch over to running:</p>  <p align="center"><img title="Site Running" alt="Site Running" src="http://chrisrisner.com/upload/wa-portal-site-created.jpg" /></p>  <p>Now, if you tap on the URL on the right side, you’ll be taken to the default placeholder page:</p>  <p align="center"><img title="Mobile Service HomePage" alt="Mobile Service HomePage" src="http://chrisrisner.com/upload/wa-mobile-service-homepage.jpg" /></p>  <p>Now, you can’t change that page but remember that the mobile service endpoint is just an endpoint.&#160; It’s not meant to also serve up a web page that you can change.&#160; Going back to the portal, click on the site (where it says “mymobileservice” in the image above the web page) and you’ll go to the dashboard for your service.&#160; The dashboard will let you know that your site is created and give you some instructions to get started.</p>  <p align="center"><img title="Mobile Service Dash" alt="Mobile Service Dash" src="http://chrisrisner.com/upload/wa-mobile-service-dashboard.jpg" width="585" height="396" /></p>  <p>Today, we’re not going to have anything to do with Windows 8.&#160; Let’s go directly to the DATA tab in the links at the top.&#160; When you do, you’ll be told you have no tables.&#160; Click “Add a Table” to create a new one.&#160; We’re going to name this table “TodoItem&quot; and leave all the permissions as the default:</p>  <p align="center"><img title="new mobile service table" alt="new mobile service table" src="http://chrisrisner.com/upload/wa-mobile-service-new-table.png" /></p>  <p>When that’s done, click the checkmark and the table should show up under your list of tables.&#160; We only have one thing left to do and that is get our app key.&#160; In the links at the top of the portal, go to “Dashboard”.&#160; At the bottom, you’ll see a button to “Manage Keys”.&#160; Go ahead and click on that.</p>  <p align="center"><img title="Manage Keys" alt="Manage Keys" src="http://chrisrisner.com/upload/wa-mob-manage-keys.jpg" /></p>  <p>In the modal that pops open, you’ll see the “Application Key”.&#160; Copy that value down for later.</p>  <p align="center"><img title="access keys" alt="access keys" src="http://chrisrisner.com/upload/wa-mob-keys.jpg" /></p>  <p>That’s all you need to do on the server side.&#160; Now we can start working on the good stuff!</p>  <p><strong></strong></p>  <p><strong></strong></p>  <p><strong>The Windows 8 Client?</strong></p>  <p>If you have a computer running Windows 8 as well, I would suggest following the instructions for creating “a new Windows 8 application” seen above.&#160; We’ve already created the table, but following those steps will enable you to download a Visual Studio solution that is 100% ready to run and you can see how the basic todos app runs.&#160; It’s not necessary for proceeding with the Android client, but it means that you can already have a few todos in your database.&#160; Either way, we can proceed to the Android client now.</p>  <p>&#160;</p>  <p><strong>The Android Client</strong></p>  <p>Go ahead and start up Eclipse.&#160; Go to the File menu and choose New and then Android Application Project.&#160; Name the project something like “MyMobileService” and give it a project name and a package:</p>  <p align="center"><img title="New Android Project" alt="New Android Project" src="http://chrisrisner.com/upload/todos-new-android-project.jpg" /></p>  <p>When you get to the <strong>Create Activity </strong>page in the wizard, just choose <strong>Blank Activity</strong>.&#160; Name the activity something like <strong>TodoListActivity</strong>:</p>  <p align="center"><img title="new list activity" alt="new list activity" src="http://chrisrisner.com/upload/todos-list-activity.jpg" /></p>  <p>&#160;</p>  <p>When you’re done, click the Finish button and create your project.&#160; Before we start editing our activity, let’s take care of our constants.&#160; Right click on your package in <strong>Package Explorer</strong> and go to New and choose Class.&#160; Name the class <strong>Constants</strong>.&#160; In this class, we’ll add a few variables to hold the URLs we’ll use to access our mobile service as well as the mobile service key mentioned earlier. </p>  <p><script src="https://gist.github.com/3549489.js?file=Constants"></script></p>  <p>&#160;</p>  <p>Make sure you fill in your subdomain and your app ID before proceeding.&#160; These URLs follow REST standards and the only interesting thing is the filter query applied at the end of the Get URL.&#160; That prevents us from retrieving todos that are already complete.&#160; If we take that filter off, we would get all of the todos.&#160; Now let’s return to our <strong>TodoListActivity.java </strong>file.&#160; We’re going to change the class that our activity extends from <strong>Activity</strong> to <strong>ListActivity</strong>.&#160; This activity will just display a list of our todo items.&#160; In addition, we’re going to implement a new object we’ll create in a few minutes, <strong><a title="Service Intents" href="http://chrisrisner.com/31-Days-of-Android--Day-28%E2%80%93Intents-Part-3--Service-Intents">ServiceResult.Receiver</a></strong>.&#160; Finally, we’ll add a few private variables.</p>  <p><script src="https://gist.github.com/3549489.js?file=TodoListActivity Start"></script></p>  <p>&#160;</p>  <p>Let’s move on to the <strong>onCreate</strong> method and remove the call to <strong>setContentView</strong> (this is only used for tying the activity to a layout).&#160; After we get rid of that, we can create an instance of our receiver and call a method to start a service to fetch our todos.</p>  <p><script src="https://gist.github.com/3549489.js?file=TodoListActivity onCreate"></script></p>  <p>&#160;</p>  <p>Let’s look at the <strong>startTodoFetchService</strong> now:</p>  <p><script src="https://gist.github.com/3549489.js?file=startTodoFetchService"></script></p>  <p>&#160;</p>  <p>Here we create a new <strong>Intent</strong> and reference a <strong>TodosFetchService</strong> that we’ll write in a few minutes.&#160; We’ll pass, as extras, to this intent a reference to our receiver and then start the service.&#160; The receiver will be used by the service to call back into our activity and update the UI.&#160; In order for it to do so, we need to expose a method for it to call.&#160; Specifically, we need to add an <strong>onReceiveResult</strong> method.&#160; </p>  <p><script src="https://gist.github.com/3549489.js?file=onReceiveResult"></script></p>  <p>&#160;</p>  <p>This method does a switch off of the result code sent by to the receiver.&#160; If it’s running or finished, we don’t do anything.&#160; If it’s an error, we show a <strong><a title="Android Toasts" href="http://chrisrisner.com/31-Days-of-Android--Day-15%E2%80%93Toasts">Toast</a></strong>.&#160; If it’s a success, we store a JSONObject array that is returned by the service and call a method to show the todos in the list view.&#160; Let’s look at this method before we move out of this class:</p>  <p><script src="https://gist.github.com/3549489.js?file=showTodosInListView"></script></p>  <p>&#160;</p>  <p>Here, we’re pulling the text value out of each <strong>JSONObject</strong> and putting them into a TreeSet.&#160; We use this to create an array and use that as the datasource for an ArrayAdapter for our list view.&#160; Once this method is called, we will display all of the todos in our list view.&#160; Let’s right click on our package in <strong>Package Explorer</strong> again and go to New and choose Class.&#160; Name your class <strong>ServiceResultReceiver</strong> and set the <strong>Superclass </strong>to be <strong>android.os.ResultReceiver</strong>.&#160; This is a bit of a generic class which can be used to handle messages sent by any <strong>IntentService</strong>:</p>  <p><script src="https://gist.github.com/3549489.js?file=ServiceResultReceiver"></script></p>  <p>&#160;</p>  <p>Now we can implement our service.&#160; Right click again on your project and go to New and choose Class.&#160; Name your class <strong>TodosFetchService</strong> and set it’s <strong>Superclass</strong> to <strong>android.app.IntentService.&#160; </strong>Let’s look at the first part of the class before we talk about it:</p>  <p><script src="https://gist.github.com/3549489.js?file=TodosFetchService One"></script></p>  <p>&#160;</p>  <p>All of the constants at the beginning of the class are used for communications between the class that starts the service (<strong>TodoListActivity</strong>) and the service (we’ve already seen some of them in our activity).&#160; We then have a reference to the receiver that is sent over by the activity.&#160; In the <strong>onHandle Intent </strong>method, we tell the receiver that the service is running and then we kick off the <strong>fetchTodos</strong> method.&#160; </p>  <p><script src="https://gist.github.com/3549489.js?file=fetchTodos"></script></p>  <p>&#160;</p>  <p>We create an instance of the <strong>URL </strong>class and then use that to generate a <strong>HttpURLConnection</strong>.&#160; A few headers are set on the connection including <strong>ACCEPT</strong>, <strong>Content-Type</strong>, and <strong>X-ZUMO-APPLICATION</strong>.&#160; The last one is required for any method that calls into Mobile Services.&#160; Without it, we’ll receive a 401.&#160; The data is read from the response and put into a <strong>JSONArray</strong>.&#160; <strong>JSONObjects</strong> are then pulled out and put into an array which is sent back using the receiver as a bundle.&#160; You should be able to compile and run your app right now, however, it won’t work terribly well because we need to edit the <strong>AndroidManifest.xml</strong> first:</p>  <p><script src="https://gist.github.com/3549696.js?file=AndroidManifestOne"></script></p>  <p>&#160;</p>  <p>Of importance here, is the <strong>INTERNET </strong>permission (required for hitting Mobile Services) and the addition of the service.&#160; With that done, you can run the app, but, unless you already ran it in Windows 8 and added todo items, you won’t see anything.&#160; We’re going to add a new activity which we’ll use to add new todos as well as to mark todos complete.&#160; Right click on your project and go to New and choose Other.&#160; From the wizard, select <strong>Android Activity</strong>.&#160; We’ll use a <strong>Blank Activity</strong> for this.&#160; We’ll name this <strong>TodoDetailsActivity</strong>.&#160; Everything else can stay as the default and you can click finish.&#160; Before we get into the code, let’s address our layout.&#160; Expand the <strong>res/layout</strong> folder and open the <strong>activity_todo_details.xml</strong> file.&#160; We’re going to add a <strong>TextView</strong>, an <strong>EditText</strong>, and two buttons to our layout.&#160; When we’re done, the XML should look something like this:</p>  <p><script src="https://gist.github.com/3549696.js?file=Details XML"></script></p>  <p>&#160;</p>  <p>The buttons will be shown and hidden depending on if we’re adding a new todo or marking an existing one complete.&#160; Let’s open up <strong>TodoDetailsActivity.java</strong> now.&#160; The first thing we’ll do is add some private variables to our class:</p>  <p><script src="https://gist.github.com/3549696.js?file=TodoDetails Private fields"></script></p>  <p>&#160;</p>  <p>These variables will keep references to our UI controls, the text and ID of a todo, and a flag indicating if we’re adding a todo or editing an existing one.&#160; Next let’s go over the <strong>onCreate</strong> method.&#160; </p>  <p><script src="https://gist.github.com/3549696.js?file=TodoDetails onCreate"></script></p>  <p>&#160;</p>  <p>First we set the content view and get references to the UI controls.&#160; Next we pull out whether or not it’s a new todo from the intent extras.&#160; Depending on this value, we hide fields, set text values, and prevent the <strong>EditText</strong> from getting focus (so it can’t be edited).&#160; Lastly, we add <strong>onClickListeners</strong> to our buttons.&#160; Let’s look at those next, starting with adding a new todo.&#160; </p>  <p><script src="https://gist.github.com/3549696.js?file=SaveTodo"></script></p>  <p>&#160;</p>  <p>This is quite a bit of code.&#160; First we have the <strong>saveTodo</strong> method.&#160; This is really just a pass through to starting the <strong>SaveTodoTask</strong> <strong>AsyncTask</strong>.&#160; We first want to look at the <strong>doInBackground </strong>method of this member class.&#160; First, we are putting the data we want to send to the server into a <strong>JSONObject</strong>.&#160; This contains the text of the todo and a complete flag to indicate that it isn’t completed yet.&#160; We then generate a <strong>HttpURLConnection </strong>and set the headers on it (again for <strong>Content-Type</strong>, <strong>ACCEPT</strong>, and <strong>X-ZUMO-APPLICATION</strong>).&#160; We write our data to the server and read the response back. If we got a 201 response code, we return “SUCCESS”.&#160; Otherwise we return “FAIL” or an error message.&#160; The <strong>onPostExecute</strong> method is called when return is called from <strong>doInBackground</strong>.&#160; Here, if we received a success, we call finish and pass a code of 1 back.&#160; If it wasn’t a success, we show a <strong>Toast</strong> with an error.&#160; </p>  <p>Before we move on to updating an item, there is a problem we have to deal with.&#160; When updating an item in Mobile Services, a <strong>PATCH</strong> HTTP request is expected.&#160; Unfortunately, out of the box, Android does not support the <strong>PATCH</strong> HTTP method.&#160; After a lot of experimenting, and the helpful assistance of <a title="Stack Overflow on HTTP Patch" href="http://stackoverflow.com/questions/12207373/http-patch-request-from-android">Stack Overflow</a>, I found a solution to this problem that isn’t ridiculously intense.&#160; First, you’ll need to <a title="HTTPClient libs on apache" href="http://archive.apache.org/dist/httpcomponents/httpclient/binary/">download httpclient-4.0.3.jar from Apache</a> (or just hop to the bottom and download the source for this project and get it from there).&#160; Drop this file in the <strong>libs</strong> folder and then in the <strong>Project Navigator</strong> refresh this folder to make sure it shows up.&#160; Right click on your package and go to New and choose Class.&#160; Name your class <strong>HttpPatch</strong> and make it match the following:</p>  <p><script src="https://gist.github.com/3549696.js?file=HttpPatch"></script></p>  <p>&#160;</p>  <p>To make a long story short, this is a copy of the <strong>HttpPatch </strong>file from the 4.2 (and later) version of Apache’s HTTP client.&#160; I don’t know why you can’t use patch in the Android SDK but with this work around, we can keep moving.&#160; With that done, let’s return to <strong>TodoDetailsActivity.java</strong>.&#160; Let’s tackle updating a todo:</p>  <p><script src="https://gist.github.com/3549696.js?file=tododetails update todo"></script></p>  <p>&#160;</p>  <p>Again we have a pass through method in <strong>markTodoComplete</strong>.&#160; Moving on to the <strong>doInBackground </strong>method, we build our <strong>JSONObject</strong>, and then build an <strong>HttpPatch</strong> object.&#160; To this we apply the same headers as before.&#160; We write the data to the server a little differently but the effect is the same.&#160; The JSON is written to the server and then we check the response code.&#160; If we get back a 200 we return “SUCCESS”.&#160; Otherwise, we return a “FAIL” or an error message.&#160; In <strong>onPostExecute</strong> if we had a success, we finish the activity with a code of 1, otherwise we show a <strong>Toast</strong> to let the user know it failed.&#160; Next, let’s open the <strong>res/menu/activity_todo_list.xml</strong> file and add a few menu options:</p>  <p><script src="https://gist.github.com/3549696.js?file=Menu"></script></p>  <p>&#160;</p>  <p>We’ll use these menu options to either refresh our todos list or add a new one.&#160; We’re nearly done.&#160; Let’s hop back over to <strong>TodoListActivity</strong> and tie our two activities together.&#160; In the <strong>onCreate method</strong>, let’s add an <strong>onClickListener</strong>:</p>  <p><script src="https://gist.github.com/3549696.js?file=list oncreate2"></script></p>  <p>&#160;</p>  <p>This will get fired when a user taps on a todo item and shows the details view and allows the user to mark an item complete.&#160; It will handle creating an <strong>Intent</strong> tied to the details view, send over details about the todo tapped, and start the intent.&#160; Last, and finally, we’ll add the method to handle our menu options and handle the result of the details activity from being run.</p>  <p>&#160;</p>  <p>&#160;</p>  <p>The options menu is pretty simple. If the user taps refresh, we just restart the fetch todo service.&#160; If add todo is tapped, we fire off the details intent and tell it we’re adding a new todo.&#160; Lastly, in <strong>onActivityResult</strong>, if the result code is 1 (which is what is returned by the details activity, we reload the list of todos.&#160; That’s it.&#160; If you run the app, you should now be able to add and mark todos complete.&#160; </p>  <p align="center"><img title="Todo Items" alt="Todo Items" src="http://chrisrisner.com/upload/todos-android-one.jpg" width="234" height="344" /><img title="todos - marking items complete" alt="todos - marking items complete" src="http://chrisrisner.com/upload/todos-android-two.jpg" width="234" height="344" /></p>  <p>&#160;</p>  <p><strong>Source Code</strong></p>  <p>You can access the <a title="Mobile Services and Android Source Code" href="https://github.com/WindowsAzure-Samples/MobileServices-Android-Client">source code from this walkthrough on GitHub</a>.&#160; Just remember that after you’ve pulled it down, you’ll need to change a few things in the <strong>Constants.java </strong>file.&#160; Specifically, you need to enter your subdomain in the three URLs and your app ID in the fourth constants.</p>  <p>&#160;</p>  <p><strong>Conclusion</strong></p>  <p>While official support for anything except Windows 8 is coming, you don’t have to wait to make use of Windows Azure Mobile Services.&#160; As seen here, the Mobile Services end points are just looking for data to come across in JSON format and only expect you to send over a single additional header (X-ZUMO-APPLICATION).&#160; Today we’ve only looked at a small piece of what you can do with data, as there is much more.&#160; I’ll tackle some of those more advanced things in the coming weeks.&#160; I’ll also go through how to inspect the HTTP traffic going across the wire from a Windows 8 app so you can see what’s going and how to call into Mobile Services.&#160; As a reminder, if you’re looking to test out Mobile Services, <a title="Free Windows Azure Trial" href="http://aka.ms/MobileServicesAndAndroid">sign up for a free Windows Azure account here</a>.</p>