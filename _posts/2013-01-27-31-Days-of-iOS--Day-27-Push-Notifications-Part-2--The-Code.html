---
layout: post
title: "31 Days of iOS: Day 27-Push Notifications Part 2: The Code"
date: Sun Jan 27 2013 08:31:00 GMT-0800 (PST)
comments: true
status: publish
type: post
published: true
categories: [Apple, Azure, Mobile, Mobile Services, Objective-C, iOS, XCode]
excerpt: "In day 27 of the 31 Days of iOS we continue talking about sending and receiving push notifications with APNS.  In this post we walk through registering from the device, sending a push notification from Mobile Services, and receiving it on the device."
logoUrl: null
keywords: iOS,31 days of iOS,Apple,Apple iOS,push notifications,Apple Dev Portal,certificate,provisioning profile,APNS,Apple Push Notification ServiceApp ID,Windows Azure,Mobile Services,registerForRemoteNotificationsTypes,UIRemoteNotificationType,didRegisterForRemoteNotifications,didReceiveRemoteNotification
filepath: 2013-01-27-31-Days-of-iOS--Day-27-Push-Notifications-Part-2--The-Code.html
disqus_identifier: 31-Days-of-iOS--Day-27–Push-Notifications-Part-2--The-Code
redirect_from:
  - /2013-01-27-31-Days-of-iOS--Day-27%E2%80%93Push-Notifications-Part-2--The-Code/
  - /2013-01-27-31-Days-of-iOS--Day-27–Push-Notifications-Part-2--The-Code/
  - /31-Days-of-iOS--Day-27–Push-Notifications-Part-2--The-Code/
---
{% include special/mobile_services_to_apps.html %}

<p><img style="margin: 0px 0px 5px 5px; display: inline; float: right" align="right" src="http://chrisrisner.com/upload/200px-Apple-logo.png" width="170" height="208" />Welcome to Day 27 of the <a title="31 Days of iOS" href="http://chrisrisner.com/31-Days-of-iOS">31 Days of iOS</a>.&#160; <a title="Day 26: Setting Up Push Notifications" href="http://chrisrisner.com/31-Days-of-iOS--Day-26%E2%80%93Push-Notifications-Part-1--The-Setup">Yesterday</a>, we started a two part series on <strong>Push Notifications</strong>.&#160; Yesterday was all about getting things set up.&#160; For push notifications getting set up is a particularly complex matter.&#160; Provided you had no issues with yesterday though, you should be ready to continue on and actually code and test your push notifications.&#160; One <strong>VERY IMPORTANT</strong> thing I’d like to point out is that you NEED to be a registered iOS developer in order to follow along today.&#160; There are steps you can’t take (like moving the app to a device) unless you are.&#160; Also, you can’t test push notifications on the simulator, you’ll need to have an iOS device in order to test this out.&#160; We won’t be doing any coding today as there is a lengthy set up process we need to go through first involving the Apple developer portal.&#160; Tomorrow we’ll implement all of the code and actually test out our push notifications.&#160; We’ll be starting with a brand new project, but if you’d like to <a title="iOS Day 27 source code" href="http://storage.chrisrisner.com/codesamples/iOSDayTwentySix.zip">follow along with the completed code, you can access it here</a>.</p>  <p><strong>A bit about client server stuff</strong></p>  <p>In order to test and demonstrate push notifications, we have to have some way to send those push notifications. Unfortunately, there isn’t a way to do that from the Apple dev portal. What we really need is a computer that can send information to <strong>Apple’s Push Notification Service (APNS)</strong> in order to have it deliver the push notification. I could always run something locally or deploy something somewhere but in order to make things as easy on me as possible and not focus on the server side today, I’m going to use something I am familiar with, <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Windows Azure Mobile Services</a>. This will allow me to easily test out sending a push notification without us getting into specifics of how it’s done. Once you’re done reading this, if you’re interested I have a <a title="Windows Azure Mobile Services articles" href="http://chrisrisner.com/Category/Mobile%20Services">bunch of other articles on what you can accomplish with Mobile Services</a> besides just testing push which we’ll do today. </p>  <p><strong>Creating our project</strong></p>  <p>Open up Xcode and choose <strong>File</strong>, <strong>New</strong>, <strong>Project</strong>.&#160; We’ll use a <strong>Single View Application </strong>and name it <strong>DayTwentySix </strong>(I realize it’s DayTwentySeven but will explain the naming next):</p>  <p align="center"><img title="new project for day 27" alt="new project for day 27" src="http://storage.chrisrisner.com/images/31iosday27-new-project.jpg" width="501" height="421" /></p>  <p>Note the <strong>Bundle Identifier</strong> is set to the <strong>Company Identifier </strong>with the <strong>Product Name</strong> appended.&#160; This is the same <strong>Bundle Identifier</strong> that I entered during the last article when creating an <strong>App ID</strong>.&#160; These <strong>MUST </strong>match in order for our push notifications to work correctly.&#160; For today, we don’t need a very fancy UI, but we will need to display some info.&#160; Open up <strong>MainStoryboard.storyboard</strong> and drag a label onto your view.&#160; Once that is done, your UI will look like this:</p>  <p align="center"><img title="Day 27 UI" alt="Day 27 UI" src="http://storage.chrisrisner.com/images/31iosday27-ui.jpg" /></p>  <p>Now, open the <strong>Assistant Editor</strong> from the top right of Xcode and <strong>control + click and drag</strong> from the label to your code behind to create a new outlet.&#160; Now your <strong>ViewController.h</strong> should look like this:</p>  <p><script src="https://gist.github.com/4399249.js?file=ViewController.h"></script></p>  <p>Now we can switch over to the AppDelegate.</p>  <p><strong>Registering for push notifications</strong></p>  <p>Open up <strong>AppDelegate.m</strong> and look at the <strong>application: didFinishLaunchingWithOptions </strong>method.&#160; As you’ll know from reading about the application life cycle, this method is called when your app starts and is a great place to do any global initialization.&#160; It’s also where we want to register our app for push notifications.&#160; We do this by using the <strong>application</strong> object sent into the method and calling it’s <strong>registerForRemoteNotifications </strong>method:</p>  <p><script src="https://gist.github.com/4399249.js?file=didFinishLaunching.m"></script></p>  <p>Notice here that I’ve registered for <strong>UIRemoteNotificationTypeBadge</strong>, <strong>UIRemoteNotificationTypeSound</strong>, and <strong>UIRemoteNotificationTypeAlert</strong>.&#160; These are all three of the notification types that I might use in my application.&#160; There is one other type, <strong>UIRemoteNotificationTypeNewsstandContentAvailability</strong>, that you might be interested in if making an app that resides in the newsstand (such as a magazine) but we’re going to skip it today.&#160; Your app may not want badge, sound, and alert type notifications so you’ll have to decide which types to request.&#160; As a general rule of thumb, only request permissions for things you know you’re going to use.&#160; After putting that code in and running our app, the first thing the user will see when their app runs will be a request for permission to send push notifications:</p>  <p align="center"><img title="Permissions for push requests" alt="Permissions for push requests" src="http://storage.chrisrisner.com/images/31iosday27-request-perms.jpg" /></p>  <p>This brings up a very important caveat to push notifications:&#160; <strong>users DON’T have to allow push notifications for your app</strong>.&#160; That means that they can install your app and allow push notifications or not.&#160; You don’t really have any control over it.&#160; Make sure your app is designed in such a way that if push notifications aren’t working, or aren’t allowed, your app will still function.&#160; Now regardless of if the user taps <strong>Don’t Allow</strong> or <strong>OK</strong> they’ll continue on to your app.&#160; However, behind the scenes something is happening.&#160; First, the user’s choice is being saved in the Notification options under the <strong>Settings</strong> app (we’ll look more at this later).&#160; Second, if they did hit <strong>OK </strong>to allow push notifications, the device is communicating with the <strong>APNS </strong>servers to get a device token.</p>  <p><strong>Getting the device token</strong></p>  <p>The next method we need to handle is <strong>application: didRegisterForRemoteNotificationsWithDeviceToken</strong>.&#160; This method will automatically be called when the device hears back from <strong>APNS</strong> with a token.&#160; This token uniquely identifies the user’s device and your app running on their device.&#160; This is how it’s ensured that the token is sent to the right place.&#160; So let’s implement that method and just have it log the token:</p>  <p><script src="https://gist.github.com/4399249.js?file=didRegister1.m"></script></p>  <p>When we run our app now, we print out a token that looks like this: <strong>&lt;867ee0d4 9b979be4 bd5e7155 57900f38 6d2d366f 1ff9263f bb26cb76 4254f483&gt;</strong>.&#160; To you and me that is a meaningless string of numbers and letters.&#160; However, <strong>APNS</strong> can use it to direct a message back to your device.&#160; The next step would be to do something with that token.&#160; Normally, this is where we would want to send our push notification to a server for saving so that the server could then use the token to send a message to our device.&#160; Since we’re less concerned with the server implementation today, we’re going to skip this part.&#160; Later on, once we’re finished with the app side, we will test a push by manually pulling the token that is getting logged out and using it.</p>  <p><strong>Receiving a push</strong></p>  <p>When our app receives a push notification, if the app is running in the background, the notification is displayed according to what type of notification it was (badge, sound, alert) and what the user has selected in their Notification settings (still to come).&#160; If the app is in the foreground though, the <strong>application: didReceiveRemoteNotification</strong> will be called.&#160; We’ll implement that method to just log the info sent over:</p>  <p><script src="https://gist.github.com/4399249.js?file=didReceiveRemote1.m"></script></p>  <p>Now we need to do some app settings changes.</p>  <p><strong>App settings changes</strong></p>  <p>In Xcode, click on your project in the <strong>Project Navigator</strong> (top left of Xcode) to view the <strong>Project </strong>and <strong>Target</strong> settings.&#160; You’ll want to make sure you have the <strong>Target </strong>selected and then check that the <strong>Bundle Identifier</strong> matches what you set up earlier and what you used in the Apple dev portal:</p>  <p align="center"><img title="Target Bundle Identifier" alt="Target Bundle Identifier" src="http://storage.chrisrisner.com/images/31iosday27-target-bundle.jpg" /></p>  <p>Once that is done, switch to the <strong>Build Settings </strong>column (two down from <strong>Summary)</strong>.&#160; Here, you want to look for the <strong>Code Signing </strong>section and change the <strong>Code Signing Identity</strong>:</p>  <p align="center"><img title="Code signing identity" alt="Code signing identity" src="http://storage.chrisrisner.com/images/31iosday27-code-signing.jpg" /></p>  <p>Here I’ll select the drop down next to <strong>Code Signing Identity</strong> and choose the one I created yesterday: <strong>Day Twenty Six Push</strong>.&#160; If you have multiple profiles available, notice that you can only choose ones that are set up with the wildcard (such as the team provisioning profile) or ones that specifically match your app’s bundle identifier.&#160; Now we can test out sending a push notification.</p>  <p><strong>What you’re not seeing (the server stuff)</strong></p>  <p>As I mentioned at the top of this article, you really need to have some way to communicate with the <strong>APNS</strong> servers to tell them to send a push notification to a token in order to test out push notifications.&#160; There are many services out there that can handle push notifications for you in addition to code bases that you could use to deploy your own push server (just check GitHub).&#160; Today I’m going to use Windows Azure Mobile Services to do the actual push notification because it’s very simple to get set up and use.&#160; I don’t want to focus on how to do this today because that isn’t really the goal though.&#160; Essentially, what I’m skipping showing you is the following:</p>  <ul>   <li>Logging in (or <a title="Free Windows Azure Trial" href="http://aka.ms/WA-MobileServices">signing up for free</a>) to <a title="Windows Azure Portal" href="http://manage.windowsazure.com">Windows Azure</a> </li>    <li><a title="Creating a new mobile service walkthrough" href="http://chrisrisner.com/Windows-Azure-Mobile-Services-and-iOS">Creating a new Mobile Service</a> </li>    <li><a title="Scheduled script walkthrough" href="http://chrisrisner.com/Announcing-Scheduled-Scripts-with-Windows-Azure-Mobile-Services">Creating a new scheduled script</a> </li>    <li>Making the script send a push notification to my device using the token we pull from the logs </li> </ul>  <p>Those steps aren’t complicated but outside the scope and focus of this article.</p>  <p><strong>Receiving the push in the app</strong></p>  <p>If our app is running and we send the push notification, the <strong>application: didReceiveRemoteNotification </strong>method is called on the AppDelegate.&#160; Currently we’re just logging that message.&#160; So, if I send an alert over, this is what I’ll see in the logs:</p>  <p><script src="https://gist.github.com/4399249.js?file=pushreceived.m"></script></p>  <p>It would be up to me to inspect the data that came over and figure out what I wanted to do from within my app.&#160; Let’s take a look and see what happens if our app isn’t in the foreground when we receive the push.</p>  <p><strong>Receiving the push out of the app</strong></p>  <p>There are a few different ways an <strong>Alert</strong> message might be received.&#160; If my settings for an alert is to show a banner, we’d see this:</p>  <p align="center"><img title="Alert as banner" alt="Alert as banner" src="http://storage.chrisrisner.com/images/31iosday27-banner-alert.jpg" /></p>  <p>If alerts are setup to show full alerts, we’d see this:</p>  <p align="center"><img title="Alert as an alert" alt="Alert as an alert" src="http://storage.chrisrisner.com/images/31iosday27-alert-alert.jpg" /></p>  <p>If the user were to tap <strong>Launch</strong> from this alert, a special option would be sent into the <strong>application: didFinishLaunchingWithOptions</strong> method if your app wasn’t currently running.&#160; If alerts aren’t set up to show as alerts or as banners, or even if they are, the alert will also show up in the <strong>Notification Center</strong> which you can access by dragging down from the top of the screen:</p>  <p align="center"><img title="iOS Notification Center" alt="iOS Notification Center" src="http://storage.chrisrisner.com/images/31iosday27-notification-center.jpg" /></p>  <p>You can also (or just) send over a <strong>badge</strong> field with a number to put a numbered badge on top of your app icon:</p>  <p align="center"><img title="app icon with badge" alt="app icon with badge" src="http://storage.chrisrisner.com/images/31iosday27-badge.jpg" /></p>  <p>This is very common with messaging apps as a way of indicating how many unread messages the user has.&#160; Other data fields you can send over include <strong>sound</strong> if you want to play a sound file, <strong>payload</strong> if you just want to send over some form of data, and <strong>expiry</strong>.&#160; The Way <strong>expiry </strong>works is that it specifies what date and time your message should no longer be delivered on.&#160; If the device is off or not receiving a signal, a push notification can’t be delivered at that time.&#160; <strong>APNS</strong> will continue to try though.&#160; However, some push notifications may be time sensitive and you may not want to deliver them past a certain time.&#160; For example, if I was building a deal-a-day app (like Groupon) and I was delivering an alert notification each day to tell you about that day’s deal, I probably wouldn’t want to tell you about yesterday’s deal if you just turned your phone on today.&#160; You can use <strong>expiry</strong> to make sure that doesn’t happen.&#160; </p>  <p><strong>Updating the UI when a push is received</strong></p>  <p>One important thing you’re probably going to want to do is know how to trigger different areas of your application when a push notification is received and the app is in the foreground.&#160; We’ll take a look at one way to do that right now.&#160; Our goal is to update the label on our view when a push is received.&#160; To do this, we’ll modify the <strong>application: didReceiveRemoteNotification</strong> method:</p>  <p><script src="https://gist.github.com/4399249.js?file=didReceiveRemote2.m"></script></p>  <p>Here we’re getting a reference to the <strong>app</strong>’s <strong>window</strong>’s <strong>rootViewController</strong> and casting that to our <strong>ViewController</strong> class.&#160; We can then use that to directly update the label’s text.&#160; Now when we run our app and receive a push notification, the text will be updated:</p>  <p align="center"><img title="Update UI on push received" alt="Update UI on push received" src="http://storage.chrisrisner.com/images/31iosday27-push-received-update-ui.jpg" /></p>  <p><strong>Notification settings</strong></p>  <p>If you launch the <strong>Settings </strong>application from the home screen and go to the <strong>Notifications </strong>area, you can edit how push notifications are handled for each application.&#160; You can choose whether or not to show things for the app in the <strong>Notification Center</strong> and if so, how many.&#160; You can change the <strong>Alert Style</strong> from banner, to normal alert, or nothing.&#160; You can also choose whether badges or sounds work as well as if alerts should be visible from the lock screen.</p>  <p align="center"><img title="Notification Settings" alt="Notification Settings" src="http://storage.chrisrisner.com/images/31iosday27-notification-settings.jpg" /></p>  <p><strong>Remember</strong> that every user has access to this and can turn on and off push notifications for your app.&#160; Make sure your app is capable of handling things with no push notifications allowed.</p>  <p><strong>Other important things</strong></p>  <p>There are a few other server side considerations you should be aware of.&#160; First, when we set up our certificates and profiles yesterday, we did it for the developer version.&#160; You’ll need to go through the same steps again to create a production version of those things.&#160; Additionally, the <strong>p12</strong> file you end up with is used to sign all of your requests for push notifications so whatever server is doing that for you (in my case, <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Windows Azure Mobile Services</a>), will need to have that uploaded to it.&#160; Additionally, those certs you get for pushing expire after a year, so keep the date in mind so you can generate new certs before your old ones expire.&#160; Lastly, the tokens you get on your device and then send to the server can expire or be marked invalid by <strong>APNS</strong>.&#160; Fortunately, <strong>APNS</strong> will tell your server that they have expired so you can stop trying to send to them.</p>  <p><strong>Conclusion</strong></p>  <p>Today we went through all the code necessary for push notifications with <strong>APNS</strong>.&#160; Additionally, we looked at the different kinds of notifications you can receive on the client as well as how they can be turned on and off by users.&#160; We touched on the server side without getting our hands too dirty there.&#160; You should now have a good understanding of how push notifications work with iOS and how you can implement them yourself.&#160; You can <a title="iOS day 27 source code" href="http://storage.chrisrisner.com/codesamples/iOSDayTwentySix.zip">download the completed code from today’s walkthrough here</a> (remember it will be named Day Twenty Six).</p>