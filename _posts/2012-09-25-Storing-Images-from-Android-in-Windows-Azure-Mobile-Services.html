---
layout: post
title: "Storing Images from Android in Windows Azure Mobile Services"
date: Tue Sep 25 2012 09:04:00 GMT-0700 (PDT)
comments: true
status: publish
type: post
published: true
categories: [Android, Azure, Mobile Services, Java]
excerpt: "This article demonstrates one technique for using Windows Azure Mobile Services to store image data from an Android application. Here we will show how to base 64 encode an image file into a string and save that into a varchar column in Mobile Services. When our app pulls that data back out, we'll base 64 decode it to remake the image."
logoUrl: null
keywords: Windows Azure Mobile Services,Windows Azure,Mobile Services,Android,Android and Mobile Services,Todo app example,Java,Eclipse,image storage,storing images,base 64,android encoding base 64
filepath: 2012-09-25-Storing-Images-from-Android-in-Windows-Azure-Mobile-Services.html
disqus_identifier: Storing-Images-from-Android-in-Windows-Azure-Mobile-Services
---
{% include special/mobile_services_to_apps.html %}

<p>
<strong>Update 3-7-2015: While this approach does work, the most recommended way to store image files in conjunction with Mobile Services is to use Blob Storage.  You can read a walkthrough of how that works <a href="http://chrisrisner.com/Android-and-Mobile-Services-and-Windows-Azure-Storage">here</a>.
</strong>
</p><p><a title="Windows Azure Mobile Services" href="https://www.windowsazure.com/en-us/develop/mobile/"><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 5px 5px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" border="0" align="right" src="http://chrisrisner.com/upload/mobile-service-logo-3.png" />Windows Azure Mobile Services</a> have been blowing up in popularity since the release a few weeks ago. One of the questions I’ve received most frequently is if there is anyway to store images in Mobile Services. The answer to this is a little bit yes and a little bit no. Before proceeding, if you haven’t already taken a walk through of Mobile Services, I’d highly recommend reading through <a title="Windows Azure Mobile Services and Android" href="http://chrisrisner.com/Windows-Azure-Mobile-Services-and-Android">my earlier post on connecting Android to Windows Azure Mobile Services</a>. The code I’ll show later in this article will build off the sample built in that post. If you want to skip all of the explanation, you can <a title="Saving Images branch in GitHub" href="https://github.com/WindowsAzure-Samples/MobileServices-Android-Client/tree/savingImages">download the code for this sample from the savingImages branch in GitHub</a>. If you decide to go right to the code, I would HIGHLY recommend reading the <strong>Disclaimer</strong> first.</p>  

<p><strong>Update:</strong> I finally had the time to create a sample that connects Mobile Services to Blob Storage which is a much better approach for storing images with Mobile Services.  The way this works is that you request a Shared Access Signature (SAS) URL from your Mobile Service, the service talks to blob storage to generate the SAS and then returns it to your app, and then your app can upload the image bytes to the SAS URL safely.  I'm leaving this post up for posterity but going forward I would highly recommend you follow the approach explained <a href="http://chrisrisner.com/Mobile-Services-and-Windows-Azure-Storage">here (the Android client is linked from this article)</a>.</p>

<p><strong><font size="3">JSON and Binary Data</font></strong></p>  <p><a title="JSON Format" href="http://www.json.org/">JSON</a>, the data format that Mobile Services uses to send data across the wire, does not natively support binary data types so you can’t post JSON as a column in the JSON you send to the server. If you try, you’ll get back this from your post to the server:</p>  <blockquote>   <p><strong>&quot;code&quot;:400,&quot;error&quot;:&quot;The value of property 'columnName' is of an unsupported type.&quot;</strong></p> </blockquote>  <p>What is interesting is that if you manually connect to the SQL database that stores the data for you mobile service (using either <strong>SQL Server Management Studio </strong>or the <strong>Manage </strong>button in the Windows Azure portal) there isn’t anything to stop you from adding columns of unsupported types to the database. When I first wanted to look at storing an image in the database for Mobile Services, the first thing I tried was adding a Varbinary column to my table and pulling that down into my client. This actually works, kind of. When you query the table from your Android app the Varbinary column comes back looking like this in the JSON:</p>  <blockquote>   <p>{&quot;0&quot;:1,&quot;1&quot;:35,&quot;2&quot;:0,&quot;3&quot;:0,&quot;4&quot;:0,&quot;5&quot;:0,&quot;6&quot;:0,&quot;7&quot;:0,&quot;8&quot;:0,&quot;9&quot;:0,&quot;10&quot;:0}</p> </blockquote>  <p>So you’re literally getting an array back of the bytes. As you can imagine, this wouldn’t really be ideal for taking and then reconstructing into an image. The bigger problem, though, is that you can’t post image data back to the server in the same format (you’ll get the error mentioned above). However, in trying this, I struck on another idea which does work.</p>  <p><strong><font size="3">Disclaimer</font></strong></p>  <p>While the method I’m about to describe will work, I wouldn’t recommend it unless you know what you’re doing. You’re better off with hosting a service in Windows Azure Websites which will get you a Shared Access Signature (SAS) for secure uploading to Windows Azure Blob Storage and then saving the blob’s URL to your Mobile Services database. If you’d like to take a look at doing this, you can <a title="Mobile Geolocation apps and Shared Access Signatures" href="http://chrisrisner.com/Mobile-Geolocation-Apps-with-Windows-Azure-Websites">read this series about mobile geolocation apps</a> which talks about getting a SAS URL from a PHP service (running in Windows Azure Websites) and then uploading the image. The debate about whether or not you should even store image data in a database is much to large to even be touched upon here but hopefully with this disclaimer in mind, you’ll know how to proceed.</p>  <p><strong><font size="3">The Solution</font></strong></p>  <p>The solution I’m going to explain today is to use a varchar (string) column to store the base 64 encoded string representation of an image in the Mobile Services database. Since Mobile Services is more than capable of handling string type data, it will treat this as such and now even realize it’s storing image data. We’re going to be basing our code off of the <a title="Windows Azure Mobile Services" href="http://chrisrisner.com/Windows-Azure-Mobile-Services-and-Android">sample mentioned above</a>. You can grab the code without any of the changes we’re about to do from the <a title="Mobile Services Android client in GitHub" href="https://github.com/WindowsAzure-Samples/MobileServices-Android-Client">master branch of this GitHub repository</a>.</p>  <p><strong><font size="3">Changing the UI</font></strong></p>  <p>The first thing we need to do is alter our user interface to facilitate the images. Open up <strong>res/layout/activity_todo_details.xml</strong>.&#160; We’re going to add an ImageView to the bottom of the xml and a new button for selecting images right above the “Mark Todo Complete” button.&#160; When you’re done, the XML will look like this:</p>  <p><script src="https://gist.github.com/3777705.js?file=activity_todo_details.xml"></script></p>  <p>With that done, we just need to wire things up in the backend.&#160; </p>  <p><strong><font size="3">Picking an Image</font></strong></p>  <p>Open <strong>src/com.msdpe.mymobileservice/TodoDetailsActivity.java</strong>.&#160; Let’s start by adding private variables to our class to store a reference to the new button and ImageView as well as something to track the image URI:</p>  <p><script src="https://gist.github.com/3777705.js?file=activity_details_vars.java"></script></p>  <p>After that we can go into <strong>onCreate</strong> and set those variables.</p>  <p><script src="https://gist.github.com/3777705.js?file=todo_details_oncreate.java"></script></p>  <p>We’re also checking to see if we should hide the “Pick Image” button (when the user views a todo item that was previously created).&#160; Next let’s add an <strong>onClickListener</strong> to the “Pick Image” button to make it call another method:</p>  <p>&#160;</p>  <p>The <strong>pickImage</strong> method creates an <strong>ACTION_GET_CONTENT </strong>intent and tells it we’re looking for “image/*”.&#160; We start this using <strong>startActivityForResult</strong> so it knows that we expect to do some processing when it’s done.&#160; This will load the gallery so the user can select an image.&#160; When they’re done, we’re going to need to handle it in the <strong>onActivityResult</strong> method:</p>  <p><script src="https://gist.github.com/3777705.js?file=image_picked.java"></script></p>  <p>Here we check to make sure the <strong>requestCode</strong> matches what was sent in previously (you’d probably want to define a constant for this instead of using an in-place number).&#160; After that, we get the URI for the image selected and use that to set our private variable as well as the URI of the ImageView (which will cause the image to appear).&#160; Now when we run our app and hit “Pick Image” and select something, we should see it appear:</p>  <p align="center"><img title="Mobile service android app showing image" alt="Mobile service android app showing image" src="http://chrisrisner.com/upload/mobile-services-android-select-image.jpg" width="256" height="370" /></p>  <p><strong><font size="3">Saving images</font></strong></p>  <p>Now that we’re able to select images, let’s save them.&#160; Go to the <strong>saveTodo</strong> method.&#160; Here we want to get the bytes for the image and base 64 encode it before sending it over to the <strong>SaveTodoTask, </strong>if there was an image selected of course.&#160; </p>  <p><script src="https://gist.github.com/3777705.js?file=saveTodo.java"></script></p>  <p>Note that we have to use a <strong>contentResolver</strong> in order to get access to the file’s absolute path and then it’s bytes.&#160; Once we do, we can read that into a byte array and then encode it using the <strong>Base64</strong> library.&#160; The next method we need to look at (and the last for saving) is the <strong>doInBackground</strong> method in the <strong>SaveTodoTask </strong>class.&#160; We’re just going to modify the beginning of this method to handle adding the image data into the JSON object we send to the server, if necessary:</p>  <p><script src="https://gist.github.com/3777705.js?file=save_inbackground.java"></script></p>  <p>We’re using the column name “coltest” here though you could name this anything you want (thanks to Mobile Service’s dynamic schema).&#160; Now if you run your app and select an image prior to saving a new todo item, you shouldn’t see anything function any differently as before.&#160; Let’s fix that by showing the images.</p>  <p><strong><font size="3">Loading images</font></strong></p>  <p>To load images, we need to first jump over to <strong>TodoListActivity.java</strong>.&#160; In the <strong>onCreate</strong> method, alter the list view’s <strong>onClickListener</strong> so that when it creates the intent to open <strong>TodoDetailsActivity</strong>, it also sends over whatever is in the “coltest” column:</p>  <p><script src="https://gist.github.com/3777705.js?file=todo_list_add_image.java"></script></p>  <p>One important thing to note here is that there is a size limitation to how much data you can send over in an intent.&#160; If you try to send over to much, you may see an error in your console that says “FAILED BINDER TRANSACTION”.&#160; If this happens, try using a smaller image.&#160; If you did need a way to use larger images, you could use a static field on the activity class or look at storing the data in a custom <strong>Application </strong>class.&#160; Let’s hop back over to <strong>TodoDetailsActivity.java</strong> and finish loading the image.&#160; The only thing left to do is alter the <strong>onCreate</strong> method so that if an existing todo is being loaded, we attempt to set the image if necessary:</p>  <p><script src="https://gist.github.com/3777705.js?file=setting_image.java"></script></p>  <p>If the “image” extra was sent over, we using <strong>Base64</strong> to decode it into a byte array.&#160; We then create a bitmap using the <strong>BitmapFactory</strong> and use that to set the ImageView.</p>  <p><strong><font size="3">Running the app</font></strong></p>  <p>When you run your app, you should be able to select an image and then save your todo item. When you tap back into that todo item, you should see the image along with the title:</p>  <p align="center"><img src="http://chrisrisner.com/upload/mobile-services-android-saved-image.jpg" width="509" height="364" /></p>  <p>Additionally, if we log into the Windows Azure portal and go to our mobile service’s data page and view our table data, we can see that the string representation of our data is showing up in “coltest”:</p>  <p align="center"><img src="http://chrisrisner.com/upload/mobile-services-database-with-images.jpg" width="789" height="211" /></p>  <p><strong><font size="3">Conclusion</font></strong></p>  <p>Today we walked through one way to store images with Windows Azure Mobile Services. As noted in the disclaimer, this technique shouldn’t be used without some consideration. If you do decide to use it, one way you could mitigate long load times (you may have noticed this sample running slower due to the data being returned when it selects all of the todos) is to only select the non-image columns when you are pulling data for the TableView and select the full todo item (including the image) when the user taps into a todo. This still doesn’t solve some of the problems like increased database bandwidth and size, but it is a way of solving the problem. You can access the <a title="savingImages branch of Android Geolocation" href="https://github.com/WindowsAzure-Samples/MobileServices-Android-Client/tree/savingImages">completed source code for this demo under the savingImages branch of this GitHub repository</a> (just remember that you’ll need to configure your app in the <strong>Constants.java</strong> file).</p>