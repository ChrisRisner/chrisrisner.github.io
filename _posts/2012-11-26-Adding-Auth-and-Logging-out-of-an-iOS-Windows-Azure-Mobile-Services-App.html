---
layout: post
title: "Adding Auth and Logging out of an iOS Windows Azure Mobile Services App"
date: Mon Nov 26 2012 08:42:00 GMT-0800 (PST)
comments: true
status: publish
type: post
published: true
categories: [Azure, Mobile Services, Mobile, Objective-C, XCode, iOS]
excerpt: "This article walks through the process of adding an authentication provider to a Windows Azure Mobile Service (in this case Twitter).  After doing so, it will then explain to users the difficulty with logging out and a proper way to do it from the code behind."
logoUrl: null
keywords: Mobile Services,iOS,Windows Azure Mobile Services,Azure,Authentication,Twitter,Logout,Logging out of Mobile Services,Logging out,walkthrough,tutorial,cloud
filepath: 2012-11-26-Adding-Auth-and-Logging-out-of-an-iOS-Windows-Azure-Mobile-Services-App.html
disqus_identifier: Adding-Auth-and-Logging-out-of-an-iOS-Windows-Azure-Mobile-Services-App
---
<p>I recently ran into an issue while working on an iOS app using <a title="Windows Azure Mobile Services" href="https://www.windowsazure.com/en-us/develop/mobile/">Windows Azure Mobile Services</a>.&#160; The problem was that I wanted multiple users to be able to log into the same app on the same device, one after another.&#160; Now, if you don’t tell the provider your logging into to <strong>Remember You</strong>, this isn’t as much of an issue.&#160; If you restart the app or call login again, you’ll be prompted for the user’s credentials.&#160; However, if the first user to login does select the <strong>Remember Me</strong> checkbox, then when you start the app again or call login again, the app will open the authentication web view and see that the user has already authenticated.&#160; Today I’m going to walk you through adding Twitter authentication to an app and then explain how to properly log a user out.&#160; </p>  <p><strong>Setting up the app</strong></p>  <p>Since I haven’t walked through this process on my site before, I’ll do it now so you can see how to set up a new app and enable authentication in it.&#160; First log in to the <a title="Windows Azure Portal" href="http://manage.windowsazure.com">Windows Azure portal</a> and select <strong>Mobile Services</strong> from the left side navigation.&#160; Once you’ve done that, you can select <strong>New</strong> from the bottom left and navigate from <strong>Compute</strong> to <strong>Mobile Service</strong> and select <strong>Create</strong>:</p>  <p align="center"><img title="Creating a new mobile service" alt="Creating a new mobile service" src="http://storage.chrisrisner.com/images/pick-new-zumo-app.jpg" width="619" height="227" /></p>  <p>After that, you’ll be presented with the <strong>New Mobile Service </strong>wizard.&#160; Here I’ve named my app <strong>logouttest</strong> and chosen to create a new database:</p>  <p align="center"><img title="new mobile service" alt="new mobile service" src="https://crcomcstorage.blob.core.windows.net/images/logout-test-new-app.jpg" width="397" height="240" /></p>  <p>Next we can either create a new database server or choose an existing one.&#160; I’m going to use an existing one and use the default database name:</p>  <p align="center"><img title="new db" alt="new db" src="http://storage.chrisrisner.com/images/logout-mobile-service-db.jpg" width="260" height="273" /></p>  <p>After that, click the checkmark and your mobile service will start getting set up.&#160; Less than a minute later, your mobile service should switch from <strong>Creating</strong> to <strong>Ready</strong> and you can click on it in the list of your mobile services.&#160; The first page you’ll see is the <strong>Getting Started </strong>section which enables you to download quickstart applications in the available platforms as well as to get instruction on connecting an existing app to mobile services.&#160; We’re going to bypass this for now and set up authentication first.&#160; </p>  <p><strong>Adding Twitter authentication</strong></p>  <p>First, go to the <strong>Identity </strong>tab in your app:</p>  <p align="center"><img title="Identity in Mobile Services" alt="Identity in Mobile Services" src="http://storage.chrisrisner.com/images/logout-test-identity.jpg" width="472" height="77" /></p>  <p>Once you’re here, you’ll see several different providers and areas to enter IDs / Keys and Secrets for them.&#160; This is where you enter the information that will enable your app to authenticate through any of these providers.&#160; Today we’ll look at adding Twitter auth but the steps are very similar depending on which provider you choose.&#160; We first need to create a twitter app by going to <a title="Twitter Developer Portal" href="https://dev.twitter.com/">Twitter’s dev portal</a>.&#160; Once here click the <strong>Sign in </strong>link in the top right.&#160; This will prompt you for your Twitter credentials.&#160; If you don’t already have an account, create one now.&#160; After logging in, you’ll be at the main developer dashboard.&#160; Hover over your username in the top right and select <strong>My Applications:</strong></p>  <p align="center"><strong><img title="My Apps in Twitter" alt="My Apps in Twitter" src="http://storage.chrisrisner.com/images/twitter-my-applications.jpg" /></strong></p>  <p>From there, you’ll click the <strong>Create a new application</strong> button in the top right.&#160; You’ll then need to enter a <strong>Name</strong>, <strong>Description</strong>, <strong>Website</strong>, and <strong>Callback URL</strong>.&#160; The name and description can be anything (though they are visible to users so you’ll want to make sure they make sense).&#160; For mine, I’ll enter <strong>Logout Mobile Services Test</strong>.&#160; The website and callback URL will need to be the URL of your mobile service.&#160; To access this, return to the portal and go to the <strong>Dashboard</strong> tab:</p>  <p align="center"><img title="Dashboard" alt="Dashboard" src="http://storage.chrisrisner.com/images/logout-test-dashboard.jpg" width="281" height="71" /></p>  <p>Once there about midway down on the right you’ll see the URL of your mobile service:</p>  <p align="center"><img title="Mobile Service URL" alt="Mobile Service URL" src="http://storage.chrisrisner.com/images/logout-test-url.jpg" /></p>  <p>Copy that and return to the Twitter portal and enter it for your website and callback URL.&#160; When you’re done, it should look something like this:</p>  <p align="center"><img title="Logout Twitter App" alt="Logout Twitter App" src="http://storage.chrisrisner.com/images/logout-twitter-app.jpg" width="196" height="316" /></p>  <p>After that, agree to the terms of service, enter the captcha, and save.&#160; You should then see the <strong>OAuth Settings </strong>for your app:</p>  <p align="center"><img title="Twitter app keys" alt="Twitter app keys" src="http://storage.chrisrisner.com/images/logout-test-twitter-keys.jpg" /></p>  <p>Copy the <strong>key </strong>and <strong>secret</strong> and return to the <strong>Identity</strong> tab in the mobile services portal.&#160; Enter the key and secret you copied into the Twitter boxes:</p>  <p align="center"><img title="Twitter account" alt="Twitter account" src="http://storage.chrisrisner.com/images/twitter-keys-in-portal.jpg" /></p>  <p>After that, hit the save button at the bottom and confirm saving your changes.&#160; Now you can test that authenticating with Twitter will work by going to <a title="https://logouttest.azure-mobile.net/login/twitter" href="https://yourmobileservice.azure-mobile.net/login/twitter">https://yourmobileservice.azure-mobile.net/login/twitter</a> (after you’ve changed it to use your service’s URL).&#160; You should see a Twitter authentication page appear.</p>  <p><strong>Downloading the quickstart app</strong></p>  <p>Today, to do things quickly, we’ll use the Quickstart application.&#160; Return to the getting started section by clicking the cloud icon under your mobile service’s name:</p>  <p align="center"><img title="Getting started Tab" alt="Getting started Tab" src="http://storage.chrisrisner.com/images/logout-test-getting-started-tab.jpg" /></p>  <p>After this, make sure iOS is chosen for the platform:</p>  <p align="center"><img title="iOS Platform" alt="iOS Platform" src="http://storage.chrisrisner.com/images/mobile-services-ios-platform.jpg" /></p>  <p>Expand the <strong>Create a new iOS app </strong>section and click the <strong>Create TodoItem Table</strong> button.&#160; This will take a few seconds to run and will then say the table has been created.&#160; Next click the <strong>Download</strong> button and download the zip that comes up.&#160; Extract that and open the <strong>QuickStart.xcodeproj</strong> that is inside of it.&#160; You can run the app now and see that it’s a simple todo list application that allows you to add items and mark them complete (by swiping on the item as though you were going to delete it).&#160; </p>  <p><strong>Adding authentication</strong></p>  <p>Adding auth to our project is very straightforward and only requires us to edit the <strong>TodoListController.m </strong>file.&#160; Open that file and go to the <strong>viewDidLoad</strong> method.&#160; At the bottom of this method we see the following code:</p>  <p><script src="https://gist.github.com/4127917.js?file=viewDidLoad.m"></script></p>  <p>We want to comment those lines of code out.&#160; They’re telling our app to pull down all of the todo items as soon as the view loads.&#160;&#160; Since we want to authenticate the user before showing any items, we need to handle this a little differently.&#160; After the <strong>viewDidLoad </strong>method, paste in the following code:</p>  <p><script src="https://gist.github.com/4127917.js?file=login.m"></script></p>  <p>The <strong>viewDidAppear</strong> method is checking to see if the <strong>currentUser </strong>property is nil.&#160; If it is, it will then call the <strong>login </strong>method.&#160; The <strong>login</strong> method creates a login view controller with the <strong>loginViewControllerWithProvider</strong> method.&#160; Here we’re passing in <strong>twitter</strong> but if we wanted the user to login through a different provider we could change what is sent into that method (provided we had configured the other provider in the portal).&#160; After that we present the controller to the user.&#160; When that controller comes back, we either log an error if there was one, or refresh the data like we were before in <strong>viewDidLoad</strong>.&#160; Finally we dismiss the view controller.&#160; If we run our app now, we should see the Twitter auth window:</p>  <p align="center"><img title="Twitter login" alt="Twitter login" src="http://storage.chrisrisner.com/images/logout-test-twitter-login.jpg" width="251" height="372" /></p>  <p>Enter the credentials from your twitter account and <strong>DON’T</strong> hit the <strong>Remember me</strong> checkbox before signing in.&#160; Provided you entered your credentials correctly, you should see the todo list show up again and pull down the items.&#160; Now return to Xcode and rerun your application.&#160; You should see the Twitter login pop up again.&#160; This is fine because the user didn’t ask to be remembered and we reinstalled the app from Xcode.&#160; Login again and this time hit <strong>Remember me</strong>.&#160; Now, if you return to the home screen and kill the app (double tap the home button after you’ve returned to the home screen.&#160; Tap and hold down on the Quickstart app.&#160; Finally tap the red minus above the QUickstart icon and hit home again), and then run the app again, you’ll see that it has remembered your user.&#160; However, let’s say you want to handle logging out.</p>  <p><strong>Logging out</strong></p>  <p>To facilitate logging out, we need to add a little bit to our UI.&#160; Open up the <strong>MainStoryboard_iPhone.storyboard</strong> (we’re just going to change the iPhone version today).&#160; Select the <strong>Todo List Controller</strong> in the storyboard and go to the <strong>Editor</strong> menu and select <strong>Embed In</strong> and <strong>Navigation Controller</strong>.&#160; This will add a navigation bar to our app and give us a great place to put a logout button.&#160; Drag a <strong>bar button item</strong> from the UI elements in the bottom right and put it in the top right of your navbar.&#160; We’ll change the <strong>Title</strong> property of this button to be <strong>Logout</strong>.&#160; When you’re done, the UI should look like this:</p>  <p align="center"><img src="http://storage.chrisrisner.com/images/quickstart-logout.jpg" width="253" height="199" /></p>  <p>Next open the <strong>Assistant Editor</strong>&#160; in the top right of Xcode and <strong>control + click and drag</strong> from the <strong>Logout</strong> button into your code and create an <strong>Action</strong>.&#160; This should add a line to your header file that looks like this:</p>  <p><script src="https://gist.github.com/4127917.js?file=logout.h"></script></p>  <p>Now we just need to implement this.&#160; Let’s open up the <strong>TodoListController.m </strong>file and find our logout method.&#160; The first thing we’ll try doing is calling <strong>logout</strong> on the <strong>MSClient</strong>:</p>  <p><script src="https://gist.github.com/4127917.js?file=logout1.m"></script></p>  <p>If you do this and rerun your app, you’ll see that it doesn’t prompt you for your Twitter credentials like you might think it would.&#160; The reason this happens is that when you check the <strong>Remember me</strong> box, cookies are placed in your app that will be sent across to Twitter in the webview.&#160; This means that the cookies aren’t tied to the specific webview, but instead to your app.&#160; We can see this by changing the logout method to log all of the cookies for our application like this:</p>  <p><script src="https://gist.github.com/4127917.js?file=logout2.m"></script></p>  <p>Now when we run our app and tap <strong>logout</strong> we should see the following printed to the console:</p>  <p><script src="https://gist.github.com/4127917.js?file=cookies"></script></p>  <p>That’s a lot of cookies.&#160; Since our webview was already dismissed, we know that these cookies aren’t tied to the specific webview that logged the user in.&#160; So, the only way to solve this problem and fully log out our user, is to get rid of the cookies.&#160; Now, depending on what your app does, you may want to ONLY remove the cookies for Twitter (or whatever auth provider you are using).&#160; For today, we’re going to remove all of the cookies:</p>  <p><script src="https://gist.github.com/4127917.js?file=logout3.m"></script></p>  <p>Now when we run our app and tap <strong>Logout </strong>and then run the app again, we should get prompted for our credentials.&#160; In reality, we’d probably want to also clear the items on the screen and give the user an option to login (perhaps by changing the <strong>Logout</strong> button to <strong>Login</strong> and then handling it there) but for clarity’s sake, I’ve skipped that in this walkthrough.</p>  <p><strong>Conclusion</strong></p>  <p>Frequently users will never make use of logout functionality (how often do you logout of the Facebook or Twitter app on your phone?).&#160; However, it’s important to provide it in the situations they can (such as wanting multiple people to be able to login after each other).&#160; In the future, we may look at adding this ability into the SDK itself so that when you call <strong>logout</strong> on your <strong>MSClient</strong>, it removes the cookies for you.&#160; However, the danger here is that the provider can change their cookies and mess with how this logging out works.&#160; This is also a consideration you should have if you decide to try to only delete the provider specific cookies in your app.&#160; You can <a title="Source code to iOS Log Out with Twitter Auth" href="http://storage.chrisrisner.com/codesamples/iOS-logouttest.zip">view the full app sample code for the application here</a>.&#160; You will have to edit the <strong>TodoService.m</strong> file and enter your mobile service URL and application key before the application will run correctly (as well as set up the Twitter authentication as described above).&#160; If you need a Windows Azure account, you can <a title="Free Windows Azure Trial" href="http://aka.ms/MobileServices-iOS-SDK">sign up for a free trial here</a>.</p>