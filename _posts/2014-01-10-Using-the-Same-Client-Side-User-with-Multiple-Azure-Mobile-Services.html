---
layout: post
title: "Using the Same Client-Side User with Multiple Azure Mobile Services"
date: Fri Jan 10 2014 10:13:00
commentsOn: true
status: publish
type: post
published: true
categories: [Azure, Mobile Services]
excerpt: "This post talks about how you can set a Mobile Service's master key.  This allows you to authenticate and access resources with the exact same user across multiple Mobile Services."
logoUrl: null
keywords: Azure,Mobile Services,Azure mobile services,user,authentication,master key,key,config
filepath: 2014-01-10-Using-the-Same-Client-Side-User-with-Multiple-Azure-Mobile-Services.html
disqus_identifier: Using-the-Same-Client-Side-User-with-Multiple-Azure-Mobile-Services
---
{% include special/mobile_services_to_apps.html %}

<p><img style="float: right; margin: 0px 0px 5px 5px; display: inline" src="http://storage.chrisrisner.com/images/WAMobileServicesblue.png" align="right" />I recently had someone come to me with an interesting use case for Windows Azure Mobile Services.&#160; They planned to create several different applications, all using Mobile Services.&#160; Nothing tricky here.&#160; However, what made their case interesting was that they wanted a single datastore for their users.&#160; In other words, create one account and then use that same account to login / store data for multiple apps.&#160; I’ll first explain why this is complicated and then talk about some solutions.</p>  <p><strong>Identifying users</strong></p>  <p>When using the built in authentication with Mobile Services (Facebook, Google, Microsoft, and Twitter) the hard parts (handling the OAuth dance and generating a token to identify the user) are done for you.&#160; Once the user authenticates, the application locally has access to a <strong>UserId</strong> and any request made to your Mobile Service (through the SDKs) automatically includes that <strong>UserId</strong> (and an auth token).&#160; In the server side scripts, that <strong>UserId</strong> can be used to save data connected to the user, filter search queries, etc.&#160; Prior to actually getting through to the scripting layer though (whether it’s for tables or custom APIs), Mobile Services has a security layer that checks to make sure the authentication token and the <strong>UserId </strong>match up.&#160; If they don’t a 401 is returned to the calling application.&#160; In all of the examples I’ve done with <a title="Custom Auth with PikShare" href="http://chrisrisner.com/Custom-Authentication-with-Azure-Mobile-Services-and-PikShare">custom authentication</a>, the same is true (it’s just more work on the developer’s side in the server side scripting).&#160; The way this security layer is able to match up the <strong>UserId </strong>to the token is that the <strong>Master Key</strong> for a Mobile Service is used to generate the token.&#160; That generation actually uses the <strong>UserId</strong>.&#160; So, on the server side, you can take the <strong>User Id </strong>that comes in with a request and compare it to what was used to generate the auth token.&#160; You can read more about how <a title="Generating ZUMO Auth Tokens by Josh" href="http://www.thejoyofcode.com/Generating_your_own_ZUMO_auth_token_Day_8_.aspx">the token’s (called JSON Web Tokens) are generated in Josh Twist’s article here</a>.</p>  <p><strong>So what’s wrong?</strong></p>  <p>The <strong>Master Key</strong> is a unique alphanumeric key that is tied to your Mobile Service.&#160; Since each specific Mobile Service’s tokens are signed with each specific Mobile Service’s <strong>Master Key</strong>, the auth token I might get for my user from one service would be different from the token I would get for the same user with another Mobile Service.&#160; Meaning that the security check would block access / deny a request made to a Mobile Service other than the one that generated the token!&#160; This problem becomes even more serious if you’re doing custom authentication where there isn’t really a concept of the “same user” like there would be if you used the same Facebook or Twitter user credentials to authenticate.</p>  <p><strong>How can we solve this?</strong></p>  <p>There are a few different tactics we can take to get around this issue if we want to have the same users across multiple apps.&#160; Let’s look at those different methods.</p>  <p><strong>Just rely on the User Id</strong></p>  <p>If you’re doing auth with Facebook, Google, Microsoft or Twitter accounts, then the <strong>User Id</strong> you get handed back (in the from of <strong>provider : providerId </strong>so ex: <strong>facebook : 12345678</strong>) will be the same no matter which app you authenticate with.&#160; So, behind the scenes, I can look at MobileServiceA’s database and MobileServiceB’s database and say “These two users are the same user”.&#160; This kind of falls apart when you look at doing custom authentication because you have to build the <strong>User Id</strong> for custom auth.&#160; You could do something clever such as set build the ID based off information the user supplies but then you’re assuming they provide the same info for each provider and that there is no way to fake things.&#160; Not exactly safe.&#160; Additionally, your users will have to authenticate and grant permission to each individual app.&#160; Probably not the experience you’re looking for.</p>  <p><strong>What else can we do?</strong></p>  <p>The approach I recommended them to take ended up being much simpler than I had originally thought.&#160; The whole problem with using the same <strong>User Id</strong> and auth token on multiple Mobile Services was that the security layer would block a request if the <strong>User Id</strong> and auth token didn’t match up.&#160; What if we could prevent this from being an issue?&#160; Enter the <a title="Command Line Interface tools for Azure" href="http://www.windowsazure.com/en-us/manage/install-and-configure-cli/">CLI tools</a>.</p>  <p><strong>Using the same Master Key</strong></p>  <p>One of the great things about the <a title="Command Line Interface tools for Azure" href="http://www.windowsazure.com/en-us/manage/install-and-configure-cli/">CLI tools</a> is that it’s easier for new features to be added to these than it is for them to be added to the portal.&#160; This means that there are some features and capabilities that the CLI has that the portal hasn’t yet received.&#160; One such feature is the ability to set the application and master key values.&#160; It’s also possible to just regenerate these keys (as it is possible to do in the portal) but setting is only allowed in the CLI (as of writing).&#160; What this means is that with the CLI we can set the master key of whatever Mobile Services we want to be the same thing.&#160; This means that the security check won’t be an issue because the master keys will match.</p>  <p><strong>What can we do with this?</strong></p>  <p>In the above mentioned person’s case, they wanted to store some information for a user in a single place and then only application (or user-application) specific data in each Mobile Service’s database.&#160; Now that we can use the same <strong>master key</strong>, they can use one single Mobile Service as their user registration and login system as well as to store any user (non-application specific) data.&#160; From a client perspective, they would just need to code the ability to register new users and authenticated to the one Mobile Service, and then use that <strong>User Id</strong> and auth token when talking to any other services.&#160; Furthermore, since the user ID will be the exact same across all of the Mobile Services, it’s easy to run any backend jobs that need to touch all of a user’s data.&#160; Specifically, this is the command you’d want to use:</p>  <blockquote>   <p><strong><font size="4">azure mobile key set &lt;SERVICENAME&gt; master &lt;NEWVALUE&gt;</font></strong></p> </blockquote>  <p><strong>Is this dangerous?</strong></p>  <p>Like everything else in development, there are risks everywhere.&#160; In this scenario, someone that has access to a user’s account has access across all of the different applications.&#160; It’s possible, though a bit more complex, to use different passwords for each app but the same account, however, this reintroduces some of the complexity we were trying to get rid of.&#160; The other risk is that the <strong>Master Key</strong> is not something that you want to spread around too much.&#160; When you make a request through the Mobile Service API with the <strong>Master Key</strong> you’re treated like an <strong>Admin </strong>user.&#160; Now, even with that being said, it doesn’t necessarily mean you can access anything you want.&#160; It depends on the permissions set on each table / API as well as what the custom scripts say.&#160; Chances are good though that unless you’ve hardened your scripts against Admins having permission to do anything though, it’s risky to lose your <strong>Master Key</strong>.&#160; Using the same <strong>Master Key</strong> for multiple Mobile Services doesn’t mean you’re more likely to lose the key, it just means there are more applications for a potentially nefarious person to get into if you did accidentally let your key slip out.&#160; </p>  <p><strong>Summary</strong></p>  <p>Today we looked at how it’s possible to bridge user accounts across multiple Mobile Services.&#160; Provided you have a way to ensure a user will have the same ID from one app to another (i.e. getting their Facebook, Google, Microsoft or Twitter ID or making a very intelligent custom auth user ID system) it’s possible to connect users in the backend.&#160; However, this system doesn’t offer any ease from the client perspective.&#160; Alternatively, using the same <strong>Master Key</strong> across Mobile Services makes it possible to go from one Mobile Service to another with the same user information.</p>