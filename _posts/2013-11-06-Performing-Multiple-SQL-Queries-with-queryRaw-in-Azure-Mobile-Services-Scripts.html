---
layout: post
title: "Performing Multiple SQL Queries with queryRaw in Azure Mobile Services Scripts"
date: Wed Nov 06 2013 07:30:00 GMT-0800 (PST)
comments: true
status: publish
type: post
published: true
categories: [Javascript, Mobile Services, SQL, Azure]
excerpt: "This post shows how you can use the mssql module to perform custom SQL queries against your database in Azure Mobile Services.  Specifically it will go over how to handle performing multiple queries with one call to queryRaw."
logoUrl: http://storage.chrisrisner.com/images/WAMobileServicesblue.png
keywords: azure,mobile services,mobile,sql,mssql,queryraw,query,multiple queries,response,respond
filepath: 2013-11-06-Performing-Multiple-SQL-Queries-with-queryRaw-in-Azure-Mobile-Services-Scripts.html
disqus_identifier: Performing-Multiple-SQL-Queries-with-queryRaw-in-Azure-Mobile-Services-Scripts
---
{% include special/mobile_services_to_apps.html %}

<p><img title="Mobile Services" style="float: right; margin: 0px 0px 5px 5px; display: inline" alt="Mobile Services" align="right" src="http://storage.chrisrisner.com/images/WAMobileServicesblue.png" width="72" height="106" />I was recently working on a sample application where I wanted to perform a few SQL queries directly against my Mobile Services’ SQL Database.&#160; This is easy enough to do with the <strong>MSSQL </strong>module provided as part of the scripting runtime.&#160; You can see an example of doing this here:</p>  <p><script src="https://gist.github.com/ChrisRisner/7327381.js?file=updateOne.js"></script></p>  <p>This does nearly exactly what you think it does.&#160; It takes the query text, mixes it with the parameters and executes it against the database connected to our Mobile Service.&#160; The tricky thing here is that if you put multiple queries in your SQL statement (here I have TWO update statements) your call back handler actually get’s called twice!&#160; This means that if you had your script like the one above and you respond to the calling application using <strong>request.respond</strong>, you’ll end up seeing an error in the logs that looks like this:</p>  <blockquote>   <p><strong>Respond cannot be called more than once.</strong></p> </blockquote>  <p>From the client side, you wouldn’t notice anything.&#160; The client gets the initial response that says “we updated the tables successfully” so it will continue on happy.&#160; even though that is true, we really want to only respond back to our client when we’re done on the server side.&#160; We can do that by altering our code to keep track of how many queries we’re performing:</p>  <p><script src="https://gist.github.com/ChrisRisner/7327381.js?file=updateTrack.js"></script></p>  <p>Here, we’re creating a <strong>var</strong> named <strong>responseCount</strong> which we use to track the number of callbacks we’ve received.&#160; In each callback, we’re incrementing that variable and checking to see if we’ve had at least one callback already.&#160; If we were doing more than 2 queries, we’d have to update that number as well.&#160; One issue we could run into is that the error block is done the same way as our success block.&#160; So if the first query fails and the second query is successful, we’ll respond to the calling application that we were successful.&#160; We’d probably want to keep track and tell the calling application that there was an issue if this occurred.&#160; </p>  <p><strong>Summary</strong></p>  <p>It’s easy enough to execute a custom SQL query against your database in a Mobile Services script.&#160; It’s also quite easy to execute multiple queries in a single call to the database.&#160; If we do perform multiple queries we do need to plan out how we’re going to appropriately reply to the calling application.&#160; We could alternatively call a stored procedure that would handle doing the updates (where we could also use a transaction) or we could execute the queries one at a time if we wanted to (with the second query being called in the first’s success block).</p>