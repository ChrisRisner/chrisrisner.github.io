---
layout: post
title: "Authentication with Windows Azure Mobile Services"
date: Mon Apr 22 2013 13:08:00 GMT-0700 (PDT)
comments: true
status: publish
type: post
published: true
categories: [Azure, Mobile Services, Javascript]
excerpt: "This post walks through how to set up a Windows Azure Mobile Service to handle authentication with Facebook, Google, Microsoft, and Twitter, as well as how to provide the ability to do custom authentication and allow your users to create their own login credentials."
logoUrl: null
keywords: Mobile Services,Azure,authentication,facebook,google,twitter,microsoft,custom auth,social,identity,login,logout,token,userid,caching auth
filepath: 2013-04-22-Authentication-with-Windows-Azure-Mobile-Services.html
disqus_identifier: Authentication-with-Windows-Azure-Mobile-Services
---
{% include special/mobile_services_to_apps.html %}

<p><img title="Mobile Services with Android" style="float: right; margin: 0px 0px 5px 5px; display: inline" alt="Mobile Services with Android" align="right" src="http://storage.chrisrisner.com/images/WAMobileServicesblue.png" />
<p>
<strong>Update 4/22/2014: Version 1 JWTs have been deprecated.  Make sure you <a href="http://chrisrisner.com/Version-1-of-the-Mobile-Services-JWT-token-has-been-deprecated" title="Update to JWT Creation">check out this post</a> to see how the script for JWT creation needs to be changed.</strong>
</p>
<p>
<strong>Update 5-9-2013</strong>: With <a href="https://dev.twitter.com/blog/api-v1-retirement-date-extended-to-june-11">Twitter retiring their version 1.0 API on June 11, 2013</a>, I thought it would be a good idea to let people know how to update the script that pulls out the username to support v1.1.  The script necessary for this is a good deal more complicated but I've walked through it in a new blog post you can find <a href="http://chrisrisner.com/Accessing-Twitter-API-v1-1-from-Mobile-Services-Scripts" Title="Accessing Twitter API v1.1">here</a>.
</p>

One of the most powerful capabilities of <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Windows Azure Mobile Services</a> is how easy it is to add user authentication to your mobile apps.&#160; Mobile Services does this by providing a super easy way to connect your app with Facebook, Google, Microsoft, and Twitter.&#160; For each provider, you go to their developer site and create an application which yields a key / id and a secret.&#160; You then take thoose pieces of information and put them in the portal for your Mobile Service and now your app can use that provider as a way of authenticating.&#160; Behind the scenes, things are a lot more complex because when you use these providers to authenticate, you’re using something called <a title="OAuth" href="http://oauth.net/">OAuth</a>.&#160; Explaining how OAuth works is far beyond the scope of this article.&#160; Fortunately you don’t need to know how it works to take advantage of it in your mobile applications.&#160; I wanted to build an application that demonstrated how you could put authentication with all four of these providers into the same app but got a little ambitious and decided to do more.&#160; This article and the two that follow will cover how to set up your Mobile Service for auth with all four providers as well as how to generate custom accounts (users select their own usernames and passwords and can then login with them) and then how to connect to that Mobile Service from an iOS and an Android client.&#160; In addition, I’ll show you how to cache the user’s identity locally on the device and then how to deal with token expiration.&#160; These samples should show you how you can build the “front end” of your application leaving the actual functionality of “what happens after my user is logged in” up to you!&#160; In this article, we’ll go over how to set everything up on the server side.&#160; We’ll start by addressing how to hook into each of the providers mentioned above (Facebook, Google, Microsoft, and Twitter) and then we’ll talk about how you can use custom auth.&#160; Lastly, we’ll go over how you can poll each provider (or our custom one) for more information (like the user’s username).</p>  <p><strong>A bit of thanks</strong></p>  <p>Before I get into things, I would be remiss to not thank <a title="Josh Twist&#39;s blog" href="http://www.thejoyofcode.com/">Josh Twist</a>.&#160; Josh is a Program Manager that works on Mobile Services and I made use of several of the blog posts he did as part of the <a title="12 Days of Zumo" href="http://www.thejoyofcode.com/The_twelve_days_of_ZUMO.aspx">12 Days of Zumo</a> series.&#160; While I will talk through all of the points I borrowed from Josh, I highly recommend paying attention to his site if you’re working with Mobile Services</p>  <p><strong>Create a Mobile Service</strong></p>  <p>The first step is to sign up for a Windows Azure account if you don’t already have one.&#160; You can sign up for a&#160; <a title="Free Windows Azure Trial" href="https://www.windowsazure.com/en-us/pricing/free-trial/">free 90 day trial here</a>.&#160; Next, as opposed to walking through the steps to create a new Mobile Service yet again, you can reference the <strong>Setting up the app</strong> portion of <a title="Creating a new Windows Azure Mobile Service" href="http://chrisrisner.com/Adding-Auth-and-Logging-out-of-an-iOS-Windows-Azure-Mobile-Services-App">this article</a>.&#160; Now that that is done, we can start setting up our authentication providers.</p>  <p><strong>Setting up Facebook auth</strong></p>  <p>We’ll set up Facebook for our first auth provider.&#160; To do this, you’ll definitely need a Facebook account (the same is true of for each provider).&#160; First navigate to <a title="https://developers.facebook.com/" href="https://developers.facebook.com/">https://developers.facebook.com/</a>.&#160; If you’re not currently logged in, you’ll see a <strong>Log In</strong> link at the top right.&#160; Click that and login with your Facebook account.&#160; Afterwards you should be at the developers home page again.&#160; Click on the <strong>Apps </strong>link at the top:</p>  <p align="center"><img title="Facebook apps link" alt="Facebook apps link" src="http://storage.chrisrisner.com/images/facebook-auth-apps-link.jpg" /></p>  <p>You’ll then be taken to your Apps dashboard.&#160; If you have already created apps, one may be selected, however today we’re going to click the <strong>+ Create New App</strong> button in the top right:</p>  <p align="center"><img title="Create new facebook app button" alt="Create new facebook app button" src="http://storage.chrisrisner.com/images/facebook-create-new-app-button.jpg" /></p>  <p>On the next page, we can name our app. We’ll just name this <strong>AuthenticationDemo</strong>:</p>  <p align="center"><img title="name facebook app" alt="name facebook app" src="http://storage.chrisrisner.com/images/facebook-name-app.jpg" /></p>  <p>Click <strong>Continue</strong> to proceed.&#160; Facebook will then prompt you to fill in a captcha and you can then continue.&#160; In the next screen, we’ll see our <strong>App ID</strong> and <strong>App Secret</strong> at the top.&#160; We’re going to need this information, but not yet.&#160; First, return to your Mobile Service in the Windows Azure Portal and go to the <strong>DASHBOARD</strong> link at the top:</p>  <p align="center"><img title="WAMS - Auth Dashboard" alt="WAMS - Auth Dashboard" src="http://storage.chrisrisner.com/images/wams-auth-dashboard.jpg" /></p>  <p>On the right side of the Dashboard, you’ll see <strong>MOBILE SERVICE URL</strong> about midway down.&#160; Remember where this is at as you’ll need it again for the other providers but for now, copy that URL:</p>  <p align="center"><img title="Mobile Service URL" alt="Mobile Service URL" src="http://storage.chrisrisner.com/images/wams-auth-url.jpg" /></p>  <p>Return to the Facebook developers site and click the checkmark next to <strong>Website with Facebook Login</strong>.&#160; Where it says <strong>Site URL</strong> paste in the URL of your Mobile Service and then click <strong>Save Changes </strong>at the bottom:</p>  <p align="center"><img title="Facebook site URL" alt="Facebook site URL" src="http://storage.chrisrisner.com/images/facebook-auth-site-url.jpg" /></p>  <p>Now copy the <strong>App ID </strong>and <strong>App Secret</strong> values and return to the Mobile Services portal.&#160; This time click on the <strong>IDENTITY</strong> link at the top:</p>  <p align="center"><img title="WAMS Identity Link" alt="WAMS Identity Link" src="http://storage.chrisrisner.com/images/wams-auth-identity.jpg" /></p>  <p>Find the area for <strong>facebook settings</strong> and paste in your ID and secret:</p>  <p align="center"><img title="Facebook auth settings" alt="Facebook auth settings" src="http://storage.chrisrisner.com/images/wams-facebook-settings.jpg" /></p>  <p>Now click the <strong>SAVE</strong> button at the bottom and confirm that you want to save the changes.&#160; On the server side we’ve done everything we need to do for Facebook.&#160; I’ll continue to walk you through the rest of the providers but I’m going to skip the sections that are going to be nearly the exact same.&#160; You can refer back to this Facebook section if you need screenshots for any of those things.</p>  <p><strong>Setting up Google auth</strong></p>  <p>To start with Google Auth, navigate to the <a title="Google API Console" href="https://code.google.com/apis/console">Google API Console</a>.&#160; If you haven’t been here before, the first thing you’ll need to do is accept some terms of service (this may also happen as you follow the steps below, just agree to everything).&#160; After you’ve gotten into the console, click the drop down in the top left under <strong>Google apis</strong> and select <strong>Create</strong> near the bottom under <strong>Other projects</strong>:</p>  <p align="center"><img title="Google APIs Console" alt="Google APIs Console" src="http://storage.chrisrisner.com/images/google-apis-console-dropdown.jpg" /></p>  <p>In the next window, give you project a name (i.e <strong>AuthDemo</strong>) and click <strong>Create Project</strong>.&#160; Once your project is created, you’ll be taken to a very long list of APIs that you can connect to if you want.&#160; Today we’re going to skip all of these.&#160; In the top left, click the <strong>API Access</strong> link:</p>  <p align="center"><img title="API Access" alt="API Access" src="http://storage.chrisrisner.com/images/google-api-access.jpg" /></p>  <p>In the next screen, all you’ll have access to do is click the <strong>Create an OAuth 2.0 client ID…</strong> button:</p>  <p align="center"><img title="Google OAuth Client creation" alt="Google OAuth Client creation" src="http://storage.chrisrisner.com/images/google-auth-api-access.jpg" /></p>  <p>In the next screen, you’ll be required to enter a <strong>Product name</strong> before you can click <strong>Next</strong>.&#160; We can just name ours <strong>AuthDemo</strong>:</p>  <p align="center"><img title="Google create client ID" alt="Google create client ID" src="http://storage.chrisrisner.com/images/google-create-client-id.jpg" width="483" height="337" /></p>  <p>On the next page, you’ll need to enter the URL of your Mobile Service (which we got from the <strong>Dashboard</strong> earlier) into a text box near the bottom of the popup.&#160; Make sure you take off the <strong>https://</strong> part of your URL and, before proceeding, add <strong>/login/google</strong> to the end of the URL.&#160; Once you leave the textbox (or hit tab) you should see the <strong>Redirect URI</strong> at the bottom become the URL for your Mobile Service with <strong>/login/google</strong> at the end (and the <strong>/login/google</strong> part will be taken off in the textbox):</p>  <p align="center"><img title="Google Auth URI" alt="Google Auth URI" src="http://storage.chrisrisner.com/images/google-authdemo-url.jpg" width="278" height="377" /></p>  <p>While the picture shows <strong>/login/google</strong> still in the textbox, it will <strong>AUTOMATICALLY </strong>be taken off, this is what you want.&#160; Hi the <strong>Create client ID</strong> button when you’re done.&#160; In the next screen, you’ll have the <strong>Client ID </strong>and <strong>Client secret</strong> which you’ll need to copy over to the <strong>google settings</strong> area of the Mobile Services portal’s Identity area:</p>  <p align="center"><img title="Google ID and Secret" alt="Google ID and Secret" src="http://storage.chrisrisner.com/images/google-auth-demo-id-key.jpg" /></p>  <p>While I’ve only blurred the leading number here, make sure you copy the WHOLE string for <strong>Client ID</strong> over.&#160; If you just copy the number, it won’t work.</p>  <p><strong>Adding Microsoft auth</strong></p>  <p>Start by navigating to the <a title="Microsoft My Applications" href="http://go.microsoft.com/fwlink/p/?linkid=262039&amp;clcid=0x409">My Applications</a> page.&#160; Here you’ll need to login to your Microsoft account.&#160; At the top of the Applications page, there will be a link to <strong>Create application</strong>:</p>  <p align="center"><img title="Create Microsoft App" alt="Create Microsoft App" src="http://storage.chrisrisner.com/images/microsoft-auth-create-app.jpg" /></p>  <p>In the next page, give your application a name, choose a language, and click the <strong>I accept</strong> button:</p>  <p align="center"><img title="Naming Microsoft App" alt="Naming Microsoft App" src="http://storage.chrisrisner.com/images/microsoft-auth-name-app.jpg" /></p>  <p>In the next page, you’ll have access to the <strong>Client ID</strong> and <strong>Client secret</strong> but before you grab these, paste your Mobile Service URL into the <strong>Redirect domain</strong> and click the <strong>Save </strong>button at the bottom:</p>  <p align="center"><img title="Microsot Redirect Domain" alt="Microsot Redirect Domain" src="http://storage.chrisrisner.com/images/microsoft-auth-redirect-domain.jpg" width="260" height="294" /></p>  <p>Make sure you leave the <strong>Mobile client app</strong> radio box at <strong>No</strong>.&#160; Copy and paste your ID and Secret over to the <strong>microsoft settings</strong> in the portal and save.</p>  <p><strong>Adding Twitter auth</strong></p>  <p>Twitter is the last of the provided identity providers we’re going to add.&#160; Start by going to the <a title="Twitter Dev" href="https://dev.twitter.com">Twitter dev portal</a>.&#160; If you aren’t already signed in, click the <strong>Sign in </strong>button at the top right and sign in.&#160; Once you are logged in, you’ll see your icon in the top right with an arrow pointing down.&#160; Click that and go to the <strong>My applications</strong> link:</p>  <p align="center"><img title="Twitter my apps" alt="Twitter my apps" src="http://storage.chrisrisner.com/images/twitter-my-applications.jpg" /></p>  <p>Once there, click the <strong>Create a new application</strong> button in the top right (a little ways under your icon).&#160; You’ll then need to enter a <strong>Name </strong>and <strong>Description</strong> for your app.&#160; These can be whatever you want (as long as they meet the requirements described under the textboxes).&#160; Next, paste the Mobile Service URL into the <strong>Website</strong> and <strong>Callback URL</strong> textboxes.&#160; Scroll down to agree to their terms and conditions, enter their captcha, and finally click the <strong>Create your twitter application </strong>button.&#160; On the next page you’ll have access to your <strong>Consumer key</strong> and <strong>Consumer secret</strong>:</p>  <p align="center"><img title="twitter key and secret" alt="twitter key and secret" src="http://storage.chrisrisner.com/images/twitter-auth-key-secret.jpg" /></p>  <p>Before you put that into the Windows Azure portal, go to the <strong>Settings</strong> link at the top of the page under your app name.&#160; On this page, under the <strong>Application Type </strong>header there is a checkbox to <strong>Allow this application to be used to Sign in with Twitter</strong>.&#160; Check that and click the <strong>Update this Twitter application’s settings</strong> button at the bottom:</p>  <p align="center"><img title="Twitter allow login" alt="Twitter allow login" src="http://storage.chrisrisner.com/images/twitter-allow-login.jpg" /></p>  <p>With that done, copy the key and secret over to the <strong>twitter settings</strong> area in the Identity section.</p>  <p><strong>Creating our Mobile Service tables</strong></p>  <p>We’re not going to store very much data with our application, however, we are going to use the script layer that is generated for tables to do a few different things.&#160; Return to the Windows Azure Portal and click on the <strong>DATA</strong> tab at the top.&#160; Currently your Mobile Service will have no tables.&#160; Click the <strong>+ Create </strong>button at the bottom of the screen and create a table named <strong>Accounts</strong> with the default permissions.&#160; Do the same thing and create tables named <strong>AuthData</strong> and <strong>BadAuth</strong>.&#160; Now it’s time to set a few scripts for these tables.&#160; </p>  <p><strong>Accounts</strong></p>  <p>The first script we’ll look at is the most complicated as it handles creating custom auth accounts and facilitating logging in those users (you can read more about this from Josh who first <a title="Josh&#39;s post on custom identity" href="http://www.thejoyofcode.com/Exploring_custom_identity_in_Mobile_Services_Day_12_.aspx">blogged about it</a> in December):</p>  <p><script src="https://gist.github.com/ChrisRisner/5398281.js?file=accounts.insert.js"></script></p>  <p>The first thing we have are several variables we’ll use throughout the script.&#160; Make sure you set the <strong>masterKey</strong> variable equal to your own Mobile Service’s master key (which you can access from the <strong>MANAGE KEYS</strong> button on the <strong>Dashboard</strong>).&#160; Once we’re in the <strong>insert</strong> method, we first check to see if <strong>login</strong> is a parameter that was sent over in the query string.&#160; If it was, we know that the user is trying to login with an already created custom auth account.&#160; If not, we go down to create an account.&#160; If we’re logging in, we first pull the data from the <strong>Accounts</strong> table where the username is equal to the username sent in.&#160; If that can’t be found, we respond with a 401.&#160; Provided we did find a user, we then hash the password using the <strong>salt</strong> that was originally used when the account was created.&#160; After that, we check that our has of the password sent into the service is the same as what’s in the database.&#160; If they are equal, we return the userId and a custom JWT token we generate using the <strong>zumoJwt </strong>method.&#160; You can read more about JSON Web Token (JWT) and generating them with Mobile Services on <a title="Generating JWT Tokens" href="http://www.thejoyofcode.com/Generating_your_own_ZUMO_auth_token_Day_8_.aspx">Josh’s blog</a>.&#160; If the hashs didn’t match, we return a 401.&#160; </p>  <p>Now if the login parameter did not come across, we know we’re creating an account.&#160; First we’ll check to make sure the username and password match a few validation requirements (length and characters inside of them).&#160; This logic could be whatever you want it to be for your application.&#160; We then check to see if the username is already in use and return a 400 if it is.&#160; If it isn’t, we generate a new random <strong>salt</strong> to be saved with our account and then use that <strong>salt </strong>to has our password.&#160; We can then insert our record to the database.&#160; Finally, we remove the <strong>salt</strong> and <strong>password</strong> from the JSON item before it’s returned, add the userId and generate a JWT token.&#160; All of this is then returned to the application.&#160; Note that we could then require the user to login and NOT return a token here.&#160; In this, we’re just bypassing making them login after they create their account.</p>  <p><strong>AuthData</strong></p>  <p>We only have one script for the <strong>AuthData</strong> table and that is for the <strong>Read</strong> method:</p>  <p><script src="https://gist.github.com/ChrisRisner/5398281.js?file=authdata.read.js"></script></p>  <p>This script handles trying to pull out the user’s username from whatever provider they logged in with.&#160; The majority of this script is owed to Carlos Figueira (another PM on Mobile Services) and his blog post on <a title="Carlos&#39; post on getting user information with Mobile Services" href="http://blogs.msdn.com/b/carlosfigueira/archive/2012/10/25/getting-user-information-on-azure-mobile-services.aspx">getting user information on Azure Mobile Services</a>.&#160; This script first creates a <strong>result </strong>object that will be sent back to the calling application.&#160; We then check the provider the user is logged in with.&#160; This will be one of five things:&#160; facebook, google, microsoft, twitter, or custom.&#160; If it’s <strong>custom</strong> we know they created an account through our app and we can check the <strong>Accounts</strong> table for their username.&#160; Otherwise, we construct a URL specific to whichever provider they logged in with.&#160; Notice that Facebook, Google, and Microsoft all make use of whatever access token they handed back in the original authentication (which you can get from the <strong>user.getIdentities()</strong> object).&#160; Twitter, however, requires us to get the Twitter ID out of the user’s userId and put that in the URL.&#160; Once we have the URL, we use the <strong>request</strong> module to make a web request to the provider and try to parse the username out of the body.&#160; Finally we return our results to the calling application.</p>  <p><strong>BadAuth</strong></p>  <p>The <strong>BadAuth</strong> table exists so that we can test out using expired tokens from the client.&#160; We’re only going to implement the <strong>Insert</strong> script for this table:</p>  <p><script src="https://gist.github.com/ChrisRisner/5398281.js?file=badauth.insert.js"></script></p>  <p>This is extremely simple compared to the other scripts.&#160; We check for a parameter named <strong>bypass</strong> in the query string.&#160; If it’s there, we respond with a 200.&#160; If it isn’t, we respond with a 401.&#160; This way we can call the method without the parameter to signal an expired token and then call it again with the parameter to act like it’s not expired.&#160; This will be useful on the client when we want to test using cached user tokens and then handling expired tokens.</p>  <p><strong>The Client</strong></p>  <p>Now that we’ve covered everything on the server side, we’re ready to tackle the clients.&#160; I’ve split things up so there is one article that will cover everything for Android and one for iOS.&#160; It’s important to remember though that we’re using the same Mobile Service for BOTH clients.&#160; There is no need to create a different Mobile Service for each client.&#160; You can find the specific articles for each client here:</p>  <ul>   <li><a title="Android auth and Mobile Services" href="http://chrisrisner.com/Authentication-with-Android-and-Windows-Azure-Mobile-Services">the Android client</a> </li>    <li><a title="iOS authentication and Mobile Services" href="http://chrisrisner.com/Authentication-with-iOS-and-Windows-Azure-Mobile-Services">the iOS Client</a> </li> </ul>  <p><strong>Conclusion</strong></p>  <p>Today we looked at how you can easily set up a Mobile Service to handle several different methods of authenticating your users.&#160; In addition to the built in support for Facebook, Google, Microsoft, and Twitter account auth, we’ve seen that from the server side, it isn’t very complicated to add custom user auth so we can make users generate their own accounts.&#160; In the next series of articles we’ll talk about things from a client perspective including logging in with each of those providers, creating new accounts, caching user tokens so users don’t have to log in every time the app starts, and handling expired tokens as well.</p>