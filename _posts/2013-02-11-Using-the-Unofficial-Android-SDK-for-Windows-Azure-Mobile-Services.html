---
layout: post
title: "Using the Unofficial Android SDK for Windows Azure Mobile Services"
date: Sun Feb 10 2013 17:54:00
commentsOn: true
status: publish
type: post
published: true
categories: [Android, Azure, Mobile Services, Java]
excerpt: "This walkthrough guides you through connecting an Android application to Windows Azure Mobile Services using an unofficial SDK created by Sasha Goldshtein.  Using the SDK we'll store our apps data in the cloud, push notifications to our app using Google Cloud Messaging, as well as authenticate our users using Twitter."
logoUrl: null
keywords: Android,Mobile Services,Windows Azure,Azure,Windows Azure Mobile Services,BAAS,Data,Push notifications,push,authentication,twitter auth,oauth,sdk,unofficial
filepath: 2013-02-11-Using-the-Unofficial-Android-SDK-for-Windows-Azure-Mobile-Services.html
disqus_identifier: Using-the-Unofficial-Android-SDK-for-Windows-Azure-Mobile-Services
---
{% include special/mobile_services_to_apps.html %}

<p><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 5px 5px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Windows Azure Mobile Services" border="0" alt="Windows Azure Mobile Services" align="right" src="http://storage.chrisrisner.com/images/WAMobileServicesblue.png" width="165" height="244" />
<strong>Since this was posted, Microsoft has released the official Android SDK and support for Mobile Services.  You can read more about the release and how to use the <a href="http://chrisrisner.com/Announcing-Android-Support-for-Mobile-Services">Android SDK here</a>.</strong><br /><br />

As of writing, we’re still working on the official Android SDK for <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Windows Azure Mobile Services</a>.&#160; However, as I pointed out during a presentation at <a title="CodeMash 2013" href="http://chrisrisner.com/CodeMash-2013-Complete!">CodeMash</a> earlier this year, one of the Microsoft MVPs, <a title="Sasha Goldshtein: The Man, the Myth, the Legend" href="http://blogs.microsoft.co.il/blogs/sasha/">Sasha Goldshtein</a>, created an unofficial Android SDK.&#160; This SDK, which is <a title="Unofficial WAMS Android SDK" href="https://github.com/goldshtn/wams-android">available on GitHub</a>, includes some sample documentation to get you started with data storage, authentication, as well as push notifications.&#160; In fact, just about everything you can do with the official iOS, Windows Store, and Windows Phone SDKs can be done with Sasha’s SDK.&#160; He really has done a great job of putting together something that can be used right now.&#160; Today I’m going to take you through taking an existing project and adding support for data storage, authentication, and push notifications into it.&#160; If you want to go straight into the finished code, you can <a title="GitHub Repo" href="https://github.com/ChrisRisner/Android-TodoList-Unofficial-MobileServices-SDK">download the GitHub repo here</a>.&#160; Once you have it, take a look at the <strong>source/end</strong> directory for the completed code.&#160; Just make sure you set the proper settings (URL, Application Key, push token, etc) to match your Mobile Service and Google API info before running.</p>  <p><strong>Getting the SDK</strong></p>  <p>The first step today will be to pull down Sasha’s SDK from GitHub.&#160; I recommend doing this by cloning the <a title="Clone Repo URL" href="git@github.com:goldshtn/wams-android.git">URL for his repo</a>.&#160; Once you’ve pulled down the repo, go into Eclipse and go to <strong>File</strong> and then <strong>Import</strong>.&#160; In the window that comes up next, choose <strong>Existing Projects into Workspace</strong> and hit <strong>Next</strong>.&#160; <strong>Browse</strong> to the directory containing the SDK and click <strong>Finish</strong>.&#160; You should now see <strong>WAMS-Android</strong> as a project in Eclipse.&#160; If you expand the project and it’s <strong>src </strong>folder, you should see Sasha’s namespace <strong>net.sashag.wams.android</strong>.&#160; Now you’re ready to start with the app.</p>  <p><strong>The starter app</strong></p>  <p>In order to make things line up with the tutorials we already have for the other platforms, I’ve actually created a Todo List application that will run on Android but doesn’t persist data at all.&#160; You can pull this Todo List application from the <a title="GitHub Repo for TodoList" href="https://github.com/ChrisRisner/Android-TodoList-Unofficial-MobileServices-SDK">GitHub repo</a> I created for this post.&#160; Once you pull it down, you’ll want to look in the <strong>source/start</strong> directory for the initial project.&#160; Running this app will give you a very simple todo list that let’s you add new items:</p>  <p align="center"><img title="Todo List before using WAMS" alt="Todo List before using WAMS" src="http://storage.chrisrisner.com/images/wams-unoff-android-pre-sdk.jpg" /></p>  <p>There is also a <strong>complete </strong>button next to each item but that currently doesn’t do anything.&#160; If you shut down and rerun the application, you’ll notice that your todo list is blank again.&#160; This is because we’re not currently persisting this data anywhere.&#160; Handling that will be the first step in using Mobile Services.&#160; </p>  <p><strong>What if we were starting with our own project</strong></p>  <p>Using the sample project skips one very important step: adding a reference to the <strong>WAMS-Android </strong>library.&#160; If you were going to start with your own project, you’d want to right click on your project in the <strong>Package Explorer</strong> and go to <strong>Build Path</strong> and choose <strong>Configure Build Path</strong>.&#160; In the build path window, select the <strong>Projects </strong>tab and then hit <strong>Add</strong>.&#160; Find <strong>WAMS-Android</strong> and check it and click <strong>OK</strong>.&#160; Before closing the properties for your project, click <strong>Android</strong> on the left side and at the bottom of the panel, next to where it says <strong>Library</strong> click the <strong>Add</strong> button.&#160; Select <strong>WAMS-Android </strong>in the window that comes up.&#160; Click <strong>OK</strong> and now the Library panel should look like this:</p>  <p align="center"><img title="Adding sdk as library" alt="Adding sdk as library" src="http://storage.chrisrisner.com/images/wams-unoff-adding-sdk-library.jpg" /></p>  <p><strong>Creating your Mobile Service</strong></p>  <p>If you haven’t already done so, make sure you spin up a new Mobile Service in the Windows Azure portal.&#160; I’m not going to talk a lot about doing this in this post because I already have.&#160; If you need assistance with creating a new Mobile Service, or where to get the Application Key or create the Todo Item table we’ll need later on, <a title="Original article on connecting Android to Mobile Services" href="http://chrisrisner.com/Windows-Azure-Mobile-Services-and-Android">check out this post</a> from a few months ago.&#160; You can ignore all of the code parts of that post and just focus on the process to create a new Mobile Service, get the key, and create the table.&#160; When you’ve done with that, proceed on.</p>  <p><strong>Adding Mobile Services settings</strong></p>  <p>The next step we need to take is to add a few configuration settings needed just to connect to our Mobile Service.&#160; Open up the <strong>res/values/strings.xml</strong> file.&#160; We already have a number of values in here that are used for text display in our app.&#160; We’re going to add two new string values that the SDK automatically looks for: the Mobile Services URL and the Application Key.&#160; Following the step above this, you should be able to get both of those values and then enter them into your file like this:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=stringsKeys.xml"></script></p>  <p>Now that that’s done, we can move on to working with data.</p>  <p><strong>Data annotations</strong></p>  <p>In order for the SDK to understand how to serialize and deserialize our data, we need to put some annotations on our <strong>TodoItem</strong> class.&#160; Open up <strong>src/com.cmr.wams_test.TodoItem.java</strong>.&#160; Currently, this class is just a simple representation of a todo item.&#160; We need to mark it so we know what table it matches up with on the server side, what the column names should be, as well as adding in an ID member which is added by default to every table in Mobile Services.&#160; When we’re done, our <strong>TodoItem </strong>class will look like this:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?File=TodoItem.java"></script></p>  <p>The first annotation is the <strong>DataTable </strong>one.&#160; This tells the SDK what table this class matches up with in Mobile Services.&#160; We then have two <strong>DataMember</strong>s.&#160; This is how we tell it what the field names should be when they are sent to, and received from, our Mobile Service.&#160; Lastly, we have <strong>Key</strong> which is needed for all classes that are tied to a table in Mobile Services.</p>  <p><strong>Adding a client and inserting items</strong></p>  <p>Now let’s actually instantiate the objects we’ll use to talk to Mobile Services and insert some items.&#160; Open up <strong>src/com.cmr.wams_test/TodoList.java</strong>.&#160;&#160; The first thing we’re going to do is add some new private variables:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=newTypes.java"></script></p>  <p>Here we’ve created a <strong>MobileService</strong> to get access into our Mobile Service and a <strong>MobileTable</strong> (that is tied to our <strong>TodoItem </strong>class) to handle all of the operations on our table.&#160; Now let’s jump down to the <strong>onCreate</strong> method and instantiate those variables:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=instantiate.java"></script></p>  <p>Nothing complex going on here.&#160; Finally, let’s alter the <strong>onClick </strong>method that is assigned to the <strong>+ </strong>button:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=addOnClick.java"></script></p>  <p>First we’ve removed the calls to <strong>notifyDataSetChanged</strong> and to clear the <strong>EditText</strong>.&#160; We’ve then added a call to <strong>todoTable</strong>’s <strong>insertAsync</strong> method.&#160; This call takes in the new <strong>TodoItem</strong> instance and a <strong>MobileServiceCallback</strong>.&#160; The callback has a <strong>errorOccurred </strong>method that is called if there is an error and a <strong>completedSuccessfully</strong> that is called on success.&#160; Notice that the success method has a <strong>TodoItem </strong>as a parametere.&#160; This is because any calls to insert will return to you the updated item from the server.&#160; We can then add that updated item to our local <strong>ArrayList</strong> and then notify the dataset that it’s data has changed and finally clear the <strong>EditText</strong>.&#160; Now when you run your application and add some todo items, you should be able to go to the data tab in the Windows Azure portal and see those items:</p>  <p align="center"><img title="Saved items in emluator" alt="Saved items in emluator" src="http://storage.chrisrisner.com/images/wams-unoff-saved-items.jpg" width="369" height="325" /></p>  <p>And if we look in the portal:</p>  <p align="center"><img title="Saved Items in Portal" alt="Saved Items in Portal" src="http://storage.chrisrisner.com/images/wams-unoff-saved-items-in-portal.jpg" /></p>  <p>Now we can work on loading the items back in on launch.</p>  <p><strong>Loading data</strong></p>  <p>We’ll start by adding a new method, <strong>LoadTodoItems</strong>, to our class:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=LoadTodoItems.java"></script></p>  <p>This method calls the <strong>todoTable</strong>’s <strong>where</strong> method and says that we want to select all of the items where the <strong>complete</strong> field is <strong>false</strong> and says we want to do it asynchronously.&#160; We are passing into that a <strong>MobileServiceCallbackWithResults</strong> that also has an error and success method.&#160; In the success method, we are setting our internal array (<strong>todoItems</strong>), creating a new <strong>TodoArrayAdapter</strong>, and then setting that as the adapter for our <strong>ListView</strong>.&#160; The last thing you’ll need to do is add a call to this method into your <strong>onCreate </strong>method.&#160; Now when you run your app, after a second or two you should see the todo items you added before reappear.</p>  <p><strong>Updating data</strong></p>  <p>Now that we’re able to save and load data, let’s take a crack and updating the todo items when the user taps the <strong>complete</strong> button.&#160; Add the following method into the <strong>TodoList</strong> class:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=markItemComplete.java"></script></p>  <p>This method will loop through the todo array and find the correct item by it’s text.&#160; It will then call the <strong>todoTable</strong>’s <strong>updateAsync</strong> method.&#160; When that call returns successfully, we remove the item from the array and then notify the adapter that the data set has changed.&#160; Now, open up the <strong>TodoArrayAdapter</strong> and add a call to <strong>todoList.markItemComplete(text1.getText());</strong> to the <strong>OnClickListener</strong> near the bottom.&#160; Now when you run your app and tap the <strong>complete </strong>button, it should update the record on the server and remove it locally.&#160; </p>  <p><strong>Adding push notifications</strong></p>  <p>The next feature we’re going to implement is push notifications using <strong>Google Cloud Messages</strong>.&#160; Doing so requires us to do a little work in the <strong>Google API Console</strong>.&#160; Start by navigating to <a title="https://code.google.com/apis/console" href="https://code.google.com/apis/console">https://code.google.com/apis/console</a>.&#160; If you already have projects set up, then you should see a drop down in the top left (right under the <strong>Google apis</strong> text) that will allow you to create a project.&#160; I’ll name my project <strong>Android-WAMS </strong>and hit <strong>Create Project</strong>.&#160; The next screen you see should be a list of <strong>Google Services</strong> (if it isn’t, hit the <strong>Services</strong> link on the left side).&#160; Find <strong>Google Cloud Messaging for Andorid</strong> in the list of services and click the <strong>OFF</strong> button so it switches to <strong>ON</strong>.&#160; With that done, go back to the top left and click on <strong>API Access</strong>.&#160; In the next screen, click the <strong>Create new Server key… </strong>button and leave the IP addresses box blank hit click <strong>Create</strong>.&#160; This will create a new key with <strong>Any IP allowed</strong> below it’s <strong>API Key</strong>.&#160; You’re going to need this key in a little bit.&#160; Additionally, you’ll need to make a note of the project ID which you can get from the URL of the browser you’re in.&#160; For example, the project I just created has this URL: https://code.google.com/apis/console/b/0/?pli=1#project:64846990266:access.&#160; So my project ID is 64846990266.&#160; Return to Eclipse and open the <strong>res/values/strings.xml </strong>file.&#160; We’re going to add a new value with the name <strong>mobileServicePushSenderId</strong> and the project ID as it’s value:</p>  <blockquote>   <p>&lt;string name=&quot;mobileServicePushSenderId&quot;&gt;64846990266&lt;/string&gt;</p> </blockquote>  <p>Next open up the <strong>AndroidManifest.xml </strong>file and add the following in above the <strong>Internet </strong>permission:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=manifest1.xml"></script></p>  <p>Here we’ve requested the necessary permissions to use <strong>GCM</strong> (they are still using the old name <strong>C2DM</strong>) as well as requested <strong>WAKE_LOCK</strong> permission.&#160; Notice that I’ve put my app’s package name in several spots where it shows up as <strong>com.cmr.wams_test</strong>.&#160; If you are putting this into your own application, make sure this matches your package.&#160; Now put the following below the <strong>&lt;/activity&gt;</strong> and before the <strong>&lt;/application&gt;</strong> tag:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=manifest2.xml"></script></p>  <p>Here we’re creating a <strong>receiver</strong> to handle receiving registration messages and the actual messages.&#160; Sasha has done some great work here in that we don’t have to implement our own receiver but can just use the one he built in (or override it if we choose to).&#160; Again, notice that I have used my package name in the <strong>category</strong>.&#160; The last thing we need to do in our application’s code is to add a call to register for push notifications.&#160; I’ve done this by putting the following code into <strong>TodoList</strong>’s <strong>onCreate</strong> method before I’m calling the method to load the todo items:</p>  <blockquote>   <p>msClient.registerPush();</p> </blockquote>  <p>Now let’s go back to the Windows Azure Portal and make the necessary changes there.</p>  <p><strong>Setting up the server side</strong></p>  <p>In the portal go to the <strong>Data </strong>tab and click the <strong>CREATE</strong> button at the bottom to make a new table.&#160; Name this table <strong>pushChannel</strong> and leave all of it’s permissions as the defaults.&#160; Now open the <strong>pushChannel</strong> table and go to it’s <strong>SCRIPT</strong> tab and drop this script in for it’s <strong>Insert</strong> method:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=pushChannelInsert.js"></script></p>  <p>This script will handle deduplicating registration IDs so that we don’t end up with the same registration ID in the table multiple times.&#160; Now, save that and then switch over to the <strong>TodoItem</strong> table and set it’s insert script to be this:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=itemInsertPush.js"></script></p>  <p>This script will first insert into the database and then, on success, will call the <strong>sendGcmPush</strong> method.&#160; The push method will pull all of the registration IDs from the <strong>pushChannel</strong> table and loop through them and send a push to each one.&#160; Notice that I’ve put my API key (as I mentioned above) in for the <strong>Authorization Key</strong>.&#160; While there isn’t the same “one line” push code we’ll eventually have with official support later on, we can still trigger a push by just doing a web request to the <strong>Google API</strong>.&#160; Now run your app again and add a new Todo Item.&#160; You should see a toast popup at the bottom of the app:</p>  <p align="center"><img title="Pushing with Android" alt="Pushing with Android" src="http://storage.chrisrisner.com/images/wams-unoff-push.jpg" width="369" height="607" /></p>  <p>Here we can see that the push notification that came back had the text I put in, <strong>test push</strong>, along with the <strong>from push</strong> text we added in the insert script.</p>  <p><strong>Adding authentication</strong></p>  <p>The last feature we’re going to add into our application is authentication.&#160; We’ll do this to facilitate making sure every user has their own todo list.&#160; Let’s start by returning to the portal and going to the <strong>TodoItem </strong>table and then going to it’s <strong>Permissions </strong>tab.&#160; Currently, all of the permissions are set to <strong>Anybody with the application key</strong>. Change all of these to be <strong>Only Authenticated Users</strong> and save.&#160; Now, rerun your application.&#160; After a moment, you should see an error message saying <strong>Error Fetching Objects</strong>.&#160; This is happening because we’ve told our Mobile Service that any calls to <strong>TodoItem</strong> need to have an authenticated user token coming across in it’s headers.&#160; We’re going to solve this today by adding in Twitter authentication.&#160; To start, we need to go to the Twitter Development portal at <a href="http://dev.twitter.com">http://dev.twitter.com</a>.&#160; After logging in, use the drop down in the top right to select <strong>My Applications</strong>.&#160; In the top right of the next window, click the <strong>Create a new application</strong> button.&#160; In the next page’s form, enter whatever you want for the <strong>Name </strong>and <strong>Description</strong> of your app.&#160; For the <strong>Website </strong>and <strong>Callback URL</strong>, enter the URL of your mobile service.&#160; You can get this by going to the <strong>Dashboard</strong> tab in the portal.&#160; Once there, the URL will be available on the right side.&#160; For my service, it’s <a href="http://unofficial-android.azure-mobile.net">http://unofficial-android.azure-mobile.net</a>.&#160; After you fill out the captcha and agree to the terms of service, you’ll be taken to the <strong>details</strong> page for your app.&#160; On this page you’ll see a <strong>Consumer key</strong> and <strong>Consumer secret</strong>.&#160; Copy these values and go back to the portal and open the <strong>Identity </strong>tab.&#160; Under the <strong>twitter settings</strong>, paste these values in and save your changes.&#160; Your mobile service is all set on the server side to allow authentication.&#160; Now we just need to handle things in our app.&#160; Open up <strong>TodoList </strong>and go to the <strong>onCreate</strong> method.&#160; We’re going to replace the call to <strong>LoadTodoItems()</strong> with the following block of code:</p>  <p><script src="https://gist.github.com/ChrisRisner/4726642.js?file=login.java"></script></p>  <p>Here we’re checking the <strong>msClient</strong> to see if the user is logged in.&#160; If they are already logged in, we just call the load method.&#160; If not, then we call the <strong>login </strong>method on <strong>msClient</strong> and specify that we want to login to Twitter using the <strong>MobileServiceAuthenticationProvider.Twitter </strong>variable.&#160; When the success method is called we then load the todo items.&#160; Now when you run your app, you’ll see the Twitter web login show up in a web view:</p>  <p align="center"><img title="Twitter Login" alt="Twitter Login" src="http://storage.chrisrisner.com/images/wams-unoff-login.jpg" width="360" height="593" /></p>  <p>After logging in, you should see the todo items load up.&#160; </p>  <p><strong>Tying items to users</strong></p>  <p>The next step we need to take in order to make the todo lists custom for each person is to make a server side script change.&#160; Go to the portal and open the <strong>Data </strong>tab.&#160; Go to the <strong>TodoItem</strong> table and go to the <strong>Insert </strong>script.&#160; Add this to the first line of your <strong>insert</strong> method:</p>  <blockquote>   <p>item.userId = user.userId;</p> </blockquote>  <p>Now when you save a todo item, you’ll see a new column has been added to the table and my Twitter ID is saved:</p>  <p align="center"><img title="Saved User IDs" alt="Saved User IDs" src="http://storage.chrisrisner.com/images/wams-unoff-save-user-id.jpg" /></p>  <p><strong>Querying by user ID</strong></p>  <p>The last step today, is to only pull down the todo items for my user ID.&#160; We can do this in two ways: from the client or from the server.&#160; We could always put another where clause on the call to <strong>todoTable.where()</strong> in the <strong>LoadTodoItems</strong> method, however, we don’t want to trust the client.&#160; It’s always possible could figure out the calls that are being made and alter them to not include that where clause.&#160; So instead, we’ll make the change on the server.&#160; Go to the portal and open the <strong>TodoItem</strong> table’s <strong>Read</strong> script. Before the call to <strong>request.execute()</strong>, put this line of code in:</p>  <blockquote>   <p>query.where({userId : user.userId});</p> </blockquote>  <p>Save that and rerun your app.&#160; Now you should only see the single todo item that was saved with my Twitter ID.&#160; If I were to run the app under a different user, I wouldn’t see any todo items.</p>  <p><strong>Conclusion</strong></p>  <p>Today we walked through quite a bit and learned how to use <a title="Unofficial Android SDK for Mobile Services" href="https://github.com/ChrisRisner/Android-TodoList-Unofficial-MobileServices-SDK">Sasha’s unofficial Android SDK for Windows Azure Mobile Services</a>.&#160; We went through saving and loading data, handling push notifications, and authenticating.&#160; Thanks to Sasha’s herculean efforts, you have access to everything that the unofficial SDKs can do with Mobile Services.&#160; In time, an official SDK will be released and I’ll update this article to point you in that direction.&#160; For now though, you can use this SDK and rest assured that things won’t change on the server side even if you have to modify a few things for the official SDK (plus the calls to GCM will be made easier).&#160; You can access the <a title="App Source Code" href="https://github.com/ChrisRisner/Android-TodoList-Unofficial-MobileServices-SDK">completed application source code at this GitHub repository</a>.&#160; The finished app is under <strong>source/end</strong> and the server side scripts we used are available under <strong>source/scripts</strong>.&#160; You’ll need to set the API settings in the <strong>strings.xml</strong> file in addition to setting up your Mobile Service for Twitter auth.&#160; Lastly, make sure you put your own Google API key in the push script.</p>