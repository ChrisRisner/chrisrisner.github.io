---
layout: post
title: "Mobile Geolocation Apps with Windows Azure Websites Part 2: Displaying Points of Interest in iOS"
date: Wed Sep 19 2012 08:48:00
commentsOn: true
status: publish
type: post
published: true
categories: [Azure, Mobile, Objective-C, XCode, iOS]
excerpt: "This article goes over how to create an iOS client with geolocation capabilities.  We'll review how to show a map in an iOS app with the device's current location as well as how to pull points of interest from a PHP service running in Windows Azure Websites."
logoUrl: null
keywords: Xcode,Objective C,iOS,iPhone,Windows Azure,Azure,PHP on Azure,Mobile connectivity to Windows Azure,Geolocation,Geospatial
filepath: 2012-09-19-Mobile-Geolocation-Apps-with-Windows-Azure-Websites-Part-2--Displaying-Points-of-Interest-in-iOS.html
disqus_identifier: Mobile-Geolocation-Apps-with-Windows-Azure-Websites-Part-2--Displaying-Points-of-Interest-in-iOS
---
<p><img style="margin: 0px 0px 5px 5px; display: inline; float: right" title="Windows Azure and iOS Mapping" alt="Windows Azure and iOS Mapping" align="right" src="http://chrisrisner.com/upload/windowsazure-apple-maps.jpg" width="266" height="114" />In the <a title="The Geolocation PHP Service" href="http://chrisrisner.com/Mobile-Geolocation-Apps-with-Windows-Azure-Websites-Part-1--The-PHP-Code">previous article</a> in this <a title="Geolocation backends for iOS and Android" href="http://chrisrisner.com/Mobile-Geolocation-Apps-with-Windows-Azure-Websites">series</a>, we walked through creating a site in Windows Azure Websites and deploying a PHP web service to it.&#160; This PHP service exposed three important endpoints:&#160; getting a collection of points of interest, getting a shared access signature (for uploading files), and adding new points of interest.&#160; Today we’re going to build an iOS client that is capable of displaying a map with these points of interest on it.&#160; We’ll also poll the user’s current location in the application so they will see all the points of interest around their current position.&#160; In the next article, we’ll continue to talk about how to add new points of interest.&#160; </p>  <p>If you haven’t already done so, you’ll need to go through <a title="Setting up the PHP Geolocation Service" href="http://chrisrisner.com/Mobile-Geolocation-Apps-with-Windows-Azure-Websites-Part-1--The-PHP-Code">part 1 in this series</a> to set up a Windows Azure Website running the PHP service.&#160; To do this you will need to have a Windows Azure account.&#160; If you don’t already have a Windows Azure account, you can <a title="Free Windows Azure Trial" href="http://aka.ms/MobileGeolocationWithWindowsAzureWebsites">sign up for a free trial here</a>.&#160; Once you’ve deployed that site, you can come back and proceed with this walkthrough.</p>  <p>If you would like to jump ahead and just pull down the source code, you can access it in <a title="Geolocation iOS Client GitHub Repository" href="https://github.com/WindowsAzure-Samples/Geolocation-iOS-Client">this GitHub repository</a>. Note that you’ll still need to follow the instructions in the readme and configure your app.&#160; One final note: this walkthrough was done with iOS 5 and the Map View element provided by it.&#160; I haven’t tried running it on an iOS6 beta yet and that does have new mapping capabilities.&#160; This steps described below may need to be altered slightly to work with iOS 6 maps.     <br /></p>  <p><strong>Creating an iOS App</strong></p>  <p>The first step is going to be easy if you’ve developed in iOS before, we’re just going to generate a new application.&#160; Open up Xcode and go to <strong>File --&gt; New -&gt; Project </strong>(or choose “Create a new Xcode project” if you are at the Welcome screen).&#160; Choose a <strong>Single-View Application</strong> from the first page in the create dialog.&#160; In the next page, enter an App name and an identifier (here we’ve used “geodemo”).</p>  <p align="center"><img title="New project for geodemo" alt="New project for geodemo" src="http://chrisrisner.com/upload/geodemo-new-ios-project.jpg" /></p>  <p>Leave the rest of the settings as is for this project.&#160; In the last page you can choose where you want to save your files.</p>  <p><strong>Creating the UI</strong></p>  <p>Let’s first open <strong>MainStoryboard.storyboard</strong> and set up our user interface.&#160; You should be viewing a blank view when you first open the storyboard:</p>  <p align="center"><img src="http://chrisrisner.com/upload/storyboard-default-view-controller.jpg" width="216" height="322" /></p>  <p>In the bottom right of the utilities pane, find the <strong>Map View </strong>element and drag it onto your view so it fills up the whole view. After dropping it, you’re going to want to drag the top end of the mapview down so it only covers about three-fourths of the screen.&#160; The reason we’re doing this is that we’re going to add a few other elements to our view.&#160; Drag two <strong>Label</strong> elements to the top left of your view (one on top of the other) and drag a <strong>Round Rect Button</strong> to the top right.&#160; Give your button a title of “Refresh” and you should see something like this:</p>  <p align="center"><img src="http://chrisrisner.com/upload/geodemo-mapview-with-elements.jpg" width="233" height="343" /></p>  <p>The next step is to open the <strong>Assistant Editor</strong> (via the button near the top right of Xcode that looks like a tuxedo or alien face).&#160; Then control click and drag from each label, button, and mapview element.&#160; For the labels and mapview,&#160; you want to generate <strong>Outlets</strong> and for the button you want to generate an <strong>Action</strong>.&#160; The two labels are going to be used to display the current latitude and longitude.&#160; It doesn’t matter which order you put them in (in my example I have the latitude at the top with longitude under it) as long as they are tied to separate outlets.&#160; One thing you may notice is that after creating the mapview outlet, you will see an error that says “<strong>Unknown type name ‘MKMapView’”</strong>.&#160; The reason for this is that the import statement for <strong>MapKit/Mapkit.h</strong> needs to be manually put into your file.&#160; When you’re done, the code will look like this:</p>  <p><script src="https://gist.github.com/3720038.js?file=ViewController.h 1"></script></p>  <p>&#160;</p>  <p>Now close the <strong>Assistant Editor</strong>.&#160; </p>  <p><strong>Doing some plumbing</strong></p>  <p>Prior to coding up the backend of our view controller, we need to create a few helper classes.&#160; Go to the <strong>File </strong>menu and choose <strong>New</strong>.&#160; Choose <strong>Objective-C class</strong> and proceed.&#160; Name your class <strong>CoreLocationController</strong> (taken from <a title="Core Location GPS Tutorial" href="http://www.vellios.com/2010/08/16/core-location-gps-tutorial/">this walkthrough</a>) and have it subclass <strong>NSObject</strong>.&#160; Let’s take a look at the code and then walk through it:</p>  <p><script src="https://gist.github.com/3720038.js?file=CoreLocationController.h"></script></p>  <p>&#160;</p>  <p>First we establish a delegate (<strong>CoreLocationControllerDelegate</strong>) with two methods for reporting a location update and a location error.&#160; We then define our class and given a <strong>CLLocationManager</strong> variable.&#160; Notice the class implements the <strong>CLLocationMangerDelegate </strong>protocol.&#160; Now let’s switch over to <strong>CoreLocationController.m</strong>:</p>  <p>&#160;</p>  <p>When we init our class, we also initialize the location manager.&#160; We set the location manager’s delegate to be the <strong>CoreLocationController</strong> so that when it receives either an update or error, we can pass it along to whoever the <strong>CoreLocationController</strong>’s delegate is.&#160; The next two methods, <strong>didUpdateToLocation </strong>and <strong>didFailWithError</strong>, are both delegate methods for <strong>CLLocationManagerDelegate</strong>.&#160; Basically whenever the location manager has an update or an error, it passes that to the <strong>CoreLocationController</strong> which then passes it to whoever was set as it’s delegate.&#160; Next we’re going to implement a map annotation.&#160; Go to the <strong>File</strong> menu and choose <strong>New.&#160; </strong>Select <strong>Objective-C class</strong> and name this one <strong>MapAnnotation </strong>and again have it subclass <strong>NSObject</strong>.&#160; Looking at <strong>MapAnnotation.h</strong>:</p>  <p><script src="https://gist.github.com/3720038.js?file=MapAnnotation.h"></script></p>  <p>&#160;</p>  <p>This class extends <strong>MKAnnotation</strong> and contains a <strong>CLLocationCoordinate2D </strong>object.&#160; Switching to the <strong>MapAnnotation.m</strong>:</p>  <p><script src="https://gist.github.com/3720038.js?file=MapAnnotation.m"></script></p>  <p>&#160;</p>  <p>The only thing here is the method to initialize the class with a coordinate.&#160; The last bit of work we need to do before getting to the good stuff is to create a new class named <strong>Constants</strong> and have it subclass <strong>NSObject</strong>.&#160; The header .h file will contain one field for now:</p>  <p><script src="https://gist.github.com/3720038.js?file=Constants.h"></script></p>  <p>&#160;</p>  <p>The first item in our class is a constant for a background queue.&#160; We’ll use this later to get the points of interest in the background (i.e. not on the UI thread).&#160; Next is a constant string which will contain the URL for fetching points of interest.&#160; In the implementation file we have defined the string:</p>  <p><script src="https://gist.github.com/3720038.js?file=Constants.m"></script></p>  <p>&#160;</p>  <p>Note that it has “yoursubdomain” in the URL.&#160; This should be replaced with the subdomain you set up in Windows Azure Websites in part 1 of this series.</p>  <p><strong>Updating ViewController</strong></p>  <p>Let’s go back to <strong>ViewController.h</strong>.&#160; We need to edit this to use a few of the classes we created:</p>  <p><script src="https://gist.github.com/3720038.js?file=ViewController.h 2"></script></p>  <p>&#160;</p>  <p>First, we’ve set our class to implement the <strong>CoreLocationControllerDelegate </strong>and <strong>MKMapViewDelegate </strong>protocols.&#160; Second, we’ve added a new private <strong>CoreLocationController </strong>variable and <strong>CLLocation </strong>variable.&#160; Now let’s switch over to <strong>ViewController.m </strong>and take a look at the <strong>viewDidLoad</strong> method:</p>  <p>&#160;</p>  <p>In this method we’re initializing the <strong>CLController</strong> variable, setting it’s delegate, and telling it to start updating the location.&#160; We then tell the mapview to show the users current location.&#160;&#160; Note that this will ask the user if you can use their location.&#160; Both of these have their delegates’ set to be the <strong>ViewController</strong>.&#160; Let’s look at the <strong>locationUpdate </strong>method first (remember this is called as part of the <strong>CoreLocationControllerDelegate </strong>protocol):</p>  <p><script src="https://gist.github.com/3720038.js?file=ViewController.m locationUpdated"></script></p>  <p>&#160;</p>  <p>This method does a number of things and starts by pulling the latitude and longitude out of the updated location.&#160; We’re then saving those to preferences (this will help later when we want to create new points of interest).&#160; We then create a new <strong>CLLocationCoordinate2D </strong>with the current location and set the mapview’s center to that location.&#160; We then access the mapview’s coordinate region.&#160; The next check is to ensure we don’t check for points of interest too much and just looks to see how much the latitude and longitude have changed.&#160; If one of the deltas is at least 2, we will scale the map and poll the server for points of interest.&#160; Moving on, we have the <strong>getCurrentPointsOfInterest </strong>method:</p>  <p><script src="https://gist.github.com/3720365.js?file=ViewController.m getCurrentPointsOfInterest"></script></p>  <p>&#160;</p>  <p>This method starts the previously mentioned background queue (from <strong>Constants.h</strong>) and tells it to call <strong>fetchedData </strong>when it’s done&#160; Notice that we are using the URL from <strong>Constants</strong> and are appending the latitude, longitude, and a radius in meters to it.&#160; This tells the server that we want all of the points of interest within that many meters of that point of origin.&#160; FetchedData will handle processing the data returned from the server:</p>  <p><script src="https://gist.github.com/3720365.js?file=ViewController.m fetchedData"></script></p>  <p>&#160;</p>  <p>First we deserialize the Json data returned into a <strong>NSArray</strong>.&#160; We then loop through each point and pull out all the details.&#160; For each point, we also create a new <strong>CLLocationCoordinate2D </strong>using the latitude and longitude from the server.&#160; We then use that point and some other information pulled from the point of interest to generate a <strong>MKPointAnnotation</strong> which is added to our mapview.&#160; When the mapview goes to render an annotation, it needs to call a method so it knows how to show it.&#160; That method is <strong>viewForAnnotation</strong>:</p>  <p><script src="https://gist.github.com/3720365.js?file=ViewController.m viewForAnnotation"></script></p>  <p>&#160;</p>  <p>This method is called for each annotation we try to display.&#160; It tries to get a <strong>MKPinAnnotationView </strong>that has been dequeued and if it can’t, it initializes a new one.&#160; It then set’s that variables annotation property and says it can show a callout (which provides more information when the pin is tapped).&#160; We have a few miscilaneous methods remaining:</p>  <p><script src="https://gist.github.com/3720365.js?file=ViewController.m misc"></script></p>  <p>&#160;</p>  <p>The <strong>tapRefresh</strong> method is called whenever the refresh button is tapped and just gets the current points of interest again.&#160; The <strong>locationError</strong> method is called by the location controller whenever an error occurs and shows the details of the error in the label for latitude.&#160; Lastly, the <strong>viewWillAppear</strong> just tells our view to get the current points of interest (in case the user leaves and returns to the app).&#160; Now let’s run our app!</p>  <p><strong>Running the app</strong></p>  <p>When you run the app it should take you to whatever the current location is set to on the simulator or on your device if you’re testing on a device.&#160; If you are on the simulator, you can change the location the phone thinks it’s at by going to the <strong>Debug -&gt; Location -&gt; Custom Location</strong> menu.&#160; <strong>Custom Location</strong> may already show up with a check mark but click on it and it will open a dialog where you can choose a latitude and longitude.&#160; If you noticed in the <strong>fetchedData </strong>method, you’ll see that we are logging each point of interest as we process them.&#160; The data is logged in this format:</p>  <blockquote>   <p>Description = &quot;My Image&quot;;      <br />Id = &quot;219403BB-283A-4C14-AC0E-ECEBEE74F32B&quot;;       <br />Latitude = &quot;47.610069&quot;;       <br />Longitude = &quot;-122.342941&quot;;       <br />Type = 1;       <br />Url = &quot;http://iostoolkitstorage1.blob.core.windows.net/test/-654608834&quot;;       <br /></p> </blockquote>  <p>Here we have each field that is stored for a point of interest (id, description, latitude, longitude, type, and file URL).&#160; We’ll put a pin on the map for each of these items.</p>  <p align="center"><img title="Running the Geolocation iOS App" alt="Running the Geolocation iOS App" src="http://chrisrisner.com/upload/geodemo-ios-running-poi.jpg" width="215" height="404" /></p>  <p>Here we can see a single point of interest showing up at the same location my phone is at.&#160; If this is the first time you’re running your app, you won’t see the same pin because you haven’t added any points yet.&#160; We’ll tackle adding new points in the next article in the series.</p>  <p><strong>Conclusion</strong></p>  <p>Today we walked through creating a simple iOS application that will connect to a PHP service running in Windows Azure Websites and poll for geographical points of interest.&#160; We then display those points of interest as pins on a map with more information provided when tapped.&#160; As mentioned at the top, you can access the source code for the <a title="iOS Geolocation on GitHub" href="https://github.com/WindowsAzure-Samples/Geolocation-iOS-Client">full version of this app on GitHub</a>.&#160; Remember to configure the subdomains in the <strong>Constants.m</strong> file before trying to run it.</p>