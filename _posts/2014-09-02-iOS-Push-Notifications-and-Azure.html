---
layout: post
title: "iOS, Push Notifications, and Azure"
date: Tue Sep 02 2014 14:42:00
commentsOn: true
status: publish
type: post
published: true
categories: [Apple, Azure, iOS, Mobile, Javascript, Objective-C]
excerpt: "This post walks through using Azure Push Notifications to perform broadcast and targeted push notifications as well as how template based push can ease pushing to different platforms at the same time."
logoUrl: null
keywords: Azure,ios,push notifications,notification hubs,azure notification hubs,push,cross-platform,template,tag,broadcast
filepath: 2014-09-02-iOS-Push-Notifications-and-Azure.html
disqus_identifier: iOS-Push-Notifications-and-Azure
redirect_from: 
  - /iOS,-Push-Notifications,-and-Azure/
---
{% include special/mobile_services_to_apps.html %}

<p><img style="margin: 0px 0px 5px 5px; display: inline" src="http://storage.chrisrisner.com/images/logo_notification_hubs.jpg" width="171" align="right" height="168" />A while back (a year ago counts as awhile back, right?), I <a title="GA of Notification Hubs" href="http://chrisrisner.com/Announcing-Notification-Hubs-General-Availability">posted</a> about the General Availability of <a title="Azure Notification Hubs" href="http://azure.microsoft.com/en-us/documentation/services/notification-hubs/">Azure Notification Hubs</a>.&#160; Since then, I’ve given a few presentations at different conferences (TechEd, AnDevCon, CocoaConf, 360iDev, etc) on how you can make use of Notification Hubs to power your push notifications.&#160; However, I haven’t really posted about it or released sample code demonstrating how it works on the different platforms.&#160; Technically, I did release a very comprehensive app, named <a title="LensRocket for iOS" href="http://chrisrisner.com/LensRocket-for-iOS-Source-Code-Released">LensRocket</a>, that uses Notification Hubs, however, that is a huge sample so if you’re just looking for “how do i do push?” it might be confusing.&#160; Today I’m going to start fixing that by releasing a fairly comprehensive explanation of push focusing on iOS clients.&#160; I’ll follow this up shortly with the same walkthrough for Android.&#160; Note that if you want to pull down the completed app, you can access all of the <a title="iOS and Notification Hubs Source Code" href="https://github.com/ChrisRisner/iOS-Push-Azure-NotificationHubs">source code here in GitHub</a>.</p>  <p><strong>Push Notifications</strong></p>  <p>For those who may not already know, I’ll give a quick overview of what Azure Notification Hubs are and why they exist.&#160; When building client applications (whether they’re iPhone, Android, WinPhone, or WinStore apps) one of the capabilities apps have is to receive Push Notifications.&#160; Push Notifications are a way of delivering information to your app without your app having to go out and request it.&#160; These pushes could inform the user / app of many many different things and just a few examples of them include: you’ve received an email (including increasing a badge number), play a sound, display a message, download some data from a server.&#160; What’s really key here is that you can send this information down to a device without your app needing to request it first, or without your app even running!&#160; This means that push notifications end up being used a LOT.&#160; Fortunately, when you’re building an app (regardless of the platform) it’s pretty simple for you to take advantage of push notifications.&#160; </p>  <p>For each client platform, there is a Push Notification Service (PNS) provided by the vendor primarily responsible for the OS.&#160; So:</p>  <ul>   <li>iOS has Apple Push Notification Service (APNS) </li>    <li>Android has Google Cloud Messaging (GCM) and Amazon Device Messaging (ADM) for Google Android and Amazon Android, respectively </li>    <li>WinPhone has Microsoft Push Notification Service (MPNS) </li>    <li>Windows Store has Windows Notification Service (WNS) </li>    <li>Other OSes provide their own services but are more bit players </li> </ul>  <p>Each of these PNS will provide to your application some identifier that identifies your app and device to the PNS.&#160; Once you get this identifier, you can then use it to talk to the PNS and ask it to deliver a push notification to the device / app.&#160; While you COULD request a push from the same device that you’re running the app on, what is common practice is to have a backend somewhere that you send the identifier to.&#160; This backend can then talk to the PNS and request a push.&#160; This backend could be a website running somewhere, a web service, a virtual machine, a client application, or really anything else capable of making an HTTP request to the PNS.&#160; </p>  <p><strong>Notification Hubs</strong></p>  <p>So far we have a client app, we have a PNS, and we have a backend.&#160; Let’s talk about how Notification Hubs fits into this.&#160; Notification Hubs is basically built to be a pseudo backend / service that will handle talking with the PNSes.&#160; That’s a pretty big simplification though because there is a lot behind that.&#160; First, when your backend asks a PNS to deliver a push notification, every request has to be signed with either an API key or a certificate (depending on which PNS it is).&#160; So not only does NH need to be able to handle taking in the keys / certs and using them for each request, it needs to be capable of updating to new versions as the certs do expire!&#160; While that’s more of administrative details, NH also enables easy targeting of push notifications using Tags (more on this below) as well as enabling single line of code cross-platform push via templates (more on this also below).&#160; Let’s start seeing some code so we understand how this works.</p>  <p><strong>Registering with APNS</strong></p>  <p>The code to register with APNS is all standard Objective-C and doesn’t have anything to do with NH:</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=appdelegate.m"></script></p>  <p>Here we have two methods in the <strong>AppDelegate</strong>.&#160; The first <strong>didFinishLaunchingWithOptions</strong> is the first point in the app’s code that you can start doing things.&#160; Here we call <strong>registerForRemoteNotificationTypes</strong> and pass in the types of push we might want to receive.&#160; The second method, <strong>didRegisterForRemoteNotificationsWithDeviceTokenb </strong>is the callback that is invoked when APNS responds.&#160; Here we’re just saving that as a property on the view controller.&#160; The last method above is the <strong>didReceiveRemoteNotification</strong> method which is called when our app is in the foreground and receives a push notification.&#160; Here we could do anything we want (show something to the user, pull down more data, play a sound, etc) based off the data sent over.&#160; In this case we’re pulling out a value and displaying a <strong>UIAlertView</strong>.</p>  <p><strong>Setting up Notification Hubs and your Project</strong></p>  <p>The next thing you’ll want to do is get the push certificate for your app identifier from the Apple Dev Portal and create a Notification Hub in the Azure portal.&#160; If you haven’t done either of those before, they’re both <a title="Setting up Notification Hubs" href="http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-ios-get-started/">documented in detail here</a>.&#160; Once you’re done with that, go to your Hub in the portal and go to the <strong>CONFIGURE</strong> tab.&#160; Find the area for <strong>apple notification settings</strong> and upload your p12 certificate file.&#160; Be sure to select the <strong>MODE</strong> (either production or sandbox) that corresponds to your cert type (as obtained in the Apple Dev Portal) or pushing won’t work.&#160; After that’s done, you’ll need to download the <a title="Azure Mobile SDK" href="http://go.microsoft.com/fwlink/?linkid=266533&amp;clcid=0x409">Azure Mobile SDK</a>.&#160; Note that this download currently contains two frameworks: one for Mobile Services and one for Notification Hubs.&#160; We’ll only be using the Notification Hubs framework so you can ignore the other.&#160; Copy the <strong>WindowsAzureMessaging.framework</strong> into your project. Before you continue on, make sure the <strong>Bundle Identifier</strong> (Found in your iOS project’s General Settings) matches the one you created in the Apple Dev Portal.&#160; Then go to your project’s Build Settings and set the <strong>Provisioning Profile </strong>and <strong>Code Signing Identity</strong> to the ones generated to match your App ID.</p>  <p><strong>Creating a Notification Hub Instance</strong></p>  <p>The first step in our apps code for talking to our hub is to set up a <strong>SBNotificationHub</strong>.&#160; I’ve added a property to hold this value in my ViewController and then will instantiate it in the <strong>viewDidLoad</strong> method:</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=viewDidLoad.m"></script></p>  <p>You’ll want to get the hub name from the hub you created and the <strong>ListenSharedAccessSignature</strong> can be obtained by going to the <strong>DASHBOARD</strong> tab of your hub in the portal and clicking <strong>CONNECTION INFORMATION </strong>at the bottom.&#160; Make sure you <strong>DO NOT</strong> get the full signature for now.&#160; Now you’re ready to start using your hub.&#160; </p>  <p>Today, we’re going to go over three different ways of registering and the accompanying way to push for that registration.&#160; The first is just plain registration with the hub which will facilitate Broadcast push (i.e. push to all the iOS devices).</p>  <p><strong>Broadcast Push</strong></p>  <p>Broadcast push is a way of doing untargeted push notifications.&#160; In other words, push to all of the iOS devices that have registered with my hub.&#160; Let’s look at the client side code first:</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=tappedRegisterWithNoTags.m"></script></p>  <p>Here we’re calling <strong>registerNativewWithDeviceToken</strong> on the hub we just created.&#160; Note that the first parameter is the push token we receive from APNS and the second parameter is currently <strong>nil</strong>.&#160; When this runs it will contact our hub and basically say “I’m an iOS device that is registered with APNS, here’s my push token.”&#160; Now let’s look at the server side code to trigger a push.</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=broadcastPush.js"></script></p>  <p>Here you’ll replace the strings in call to <strong>createNotificationHubService</strong> with your hub’s name and the <strong>FULL Access Signature</strong>.&#160; We then use the <strong>notificationHubService</strong> object to call <strong>apns.send</strong> where we specify the payload we want to send.&#160; Running this script will trigger our hub to push that payload to any iOS / APNS device that has connected to the hub.&#160; One other thing to note is that these scripts were created to be run as Mobile Service Custom APIs in order to ease testing out (with the permissions set to Everyone, I can trigger this script by going to the endpoint for it in a browser).&#160; I’ll talk more about connecting to Notification Hubs to trigger pushes later, but for now just know that this same Node.JS Script could run anywhere you can run Node.&#160; You’d just need to pull down the Azure Node Package.</p>  <p><strong>Pushing to Tags</strong></p>  <p>Up next we’ll talk about targeted pushes.&#160; So instead of “Broadcast to everyone” we’ll be able to say “Push to user X” or “Push to this group of users”.&#160; The first step in doing this is registering from the client:</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=tappedRegisterWithTags.m"></script></p>  <p>This is identical to the code we had on our client before except now we’re passing in a second parameter, an NSArray of tags.&#160; In this case, my array has three tags: <strong>MyTag, AllUsers, </strong>and <strong>iOSUser</strong>.&#160; When we run this it basically says, “I’m an iOS device that is registered with APNS, here’s my push token.&#160; Also, tie it to these three tags.”&#160; What’s great about this is then from our backend, we can tell our hub to only push to devices that are tied to a specific tag, like this:</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=targetedPush.js"></script></p>  <p>Here we’re doing the same thing on the server, EXCEPT we’re passing in a first parameter (previously it was null).&#160; In this case we’re passing in the tag <strong>MyTag</strong> so only devices registered with my hub, with APNS, will receive the push notification. </p>  <p><strong>Tag Expressions</strong></p>  <p>Pushing based off of tags is pretty cool.&#160; You could use tags for lots of different things (sports teams, stock ticker labels, zipcode (i.e. geopush), etc).&#160; You could even set the user’s username (if they were logged in) as a tag and then you’d have the ability to say “push to all of Chris’ devices” if you wanted.&#160; Another powerful feature of hubs is called Tag Expressions.&#160; This basically enables you to trigger pushes based off logical expressions of tags.&#160; So for example, if I was registering with the username and a group I’m in, I could say “Push to GROUPNAME except ME”.&#160; So push to everyone in the group I’m in but not my devices.&#160; The actual tag string I would use would probably look something like this “Group:ID &amp;&amp; !User:ID” where the tags I register with might be “Group:ID” and “User:ID”.</p>  <p><strong>Templates</strong></p>  <p>So far we’ve looked at broadcast and targeted based push.&#160; However, all of the pushing we’ve done has been constrained to APNS devices.&#160; If I’m building a cross-platform app, I need to be able to handle pushing to other platforms as well.&#160; Now I could have the same code to do a push to Android and WinPhone and WinStore right after my <strong>apns.send</strong> code everywhere I want to do a push, but that’s a decent amount of code.&#160; Especially if I am pushing in many different places.&#160; The alternative to that is using Templates.&#160; When you register with your hub, in addition to sending the push identifier and the tags you want to be tied to, you can also specify a template that indicates the format of the payload you want to receive.&#160; Let’s take a look:</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=tappedRegisterWithTemplates.m"></script></p>  <p>Here we’re creating a template string that contains the <strong>aps JSON </strong>format that we previously saw in our server script.&#160; Inside of that payload is the important bit <strong>$(message)</strong>.&#160; From the server side, when we push, it will use that <strong>message </strong>bit to figure out how to format the payload with the data we want to inject.&#160; The other difference here is that we’re now calling <strong>registerTemplateWithDeviceToken</strong>.&#160; Let’s take a look at the Node script to push to our client now:</p>  <p><script src="https://gist.github.com/ChrisRisner/a6a108ec71ae31705fa7.js?file=templatePush.js"></script></p>  <p>Now we’re creating a <strong>payload</strong> object which is a JSON object with a <strong>message</strong> field in it.&#160; We can then use <strong>notificationHubService.send</strong> (notice there is no <strong>apns</strong> in the middle anymore) and set the payload as the second parameter (we’re not using a tag to do a targeted push here but we could).&#160; When this runs, it will cause the hub to find any device registration that has a payload with the <strong>message</strong> field in it and format the payload with the data from the payload we’re sending in.&#160; So effectively, when we send to our iOS device, we’ll use the <strong>aps </strong>payload format specified on the client.&#160; If i was doing something for Android, we’d send it in the Android specific format, and so on.&#160; So we now have a single line that is capable of handling pushing to any device type!</p>  <p><strong>Talking to Notification Hubs from Your Backend</strong></p>  <p>The idea here is that Notification Hubs can effectively handle all the aspects of Push Notifications for you.&#160; I can have a backend (website or web service) running somewhere, whether its on Azure or not or it’s in .NET or not doesn’t matter at all, and just talk to my Notification Hub whenever I need to trigger a push.&#160; Now in the samples above, I’m trigger my pushes from Node.js scripts which make use of the <a href="https://github.com/Azure/azure-sdk-for-node">Node.js Azure module</a>.&#160; These could be running anywhere but to make things easy, I usually run them from Azure Mobile Services (super quick to get them up and running).&#160; You can also use the <a href="http://azure.microsoft.com/en-us/documentation/articles/mobile-services-javascript-backend-ios-get-started-push/">.NET SDK</a> for triggering push notifications, and their are guides for doing so <a title="Notification Hubs from Java" href="http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-java-backend-how-to/">from Java</a> as well as <a title="Notification Hubs from PHP" href="http://azure.microsoft.com/en-us/documentation/articles/notification-hubs-php-backend-how-to/">from PHP</a>.&#160; Everything in Notification Hubs is also <a title="Notification Hubs REST API" href="http://msdn.microsoft.com/en-us/library/dn223264.aspx">exposed over a REST API</a> so even if there isn’t an SDK or a guide for talking to your hub from your platform of choice to trigger pushes, you can always fall back on the REST API. </p>  <p><strong>Summary</strong></p>  <p>I hope this post proves helpful for anyone looking at using Notification Hubs to handle iOS push notifications.&#160; As I said above, I’ll post a tutorial on doing the same thing from Android (though it will be 90% the exact same post because only the client side code is really different) and you can do everything I’ve described above from any of the other client platforms.&#160; Notification Hubs are a super easy way to get into doing push notifications for your apps and make it super simple to make them working on different platforms.&#160; Add to all these features the fact that you get <a title="Azure Notification Hubs Pricing" href="http://azure.microsoft.com/en-us/pricing/details/notification-hubs/">1 million push notifications for FREE every month (as of Sept. 1, 2014)</a> and it’s a pretty sweet deal!&#160; You can grab both the <a title="Client and Server Source code for iOS Push Notifications with Notification Hubs" href="https://github.com/ChrisRisner/iOS-Push-Azure-NotificationHubs">client and server source code for the app seen above here</a>.</p>