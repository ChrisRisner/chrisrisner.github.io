---
layout: post
title: "Storing Images from iOS in Windows Azure Mobile Services"
date: Mon Sep 24 2012 11:40:00
commentsOn: true
status: publish
type: post
published: true
categories: [Azure, Mobile Services, Objective-C, XCode, iOS]
excerpt: "This article demonstrates one technique for using Windows Azure Mobile Services to store image data.  Here we will show how to base 64 encode an image file into a string and save that into a varchar column in Mobile Services.  When our app pulls that data back out, we'll base 64 decode it to remake the image."
logoUrl: null
keywords: Windows Azure Mobile Services,Windows Azure,Mobile Services,iOS,iOS and Mobile Services,Todo app example,Objective-C,Xcode,image storage,storing images,base64,ios encoding base64
filepath: 2012-09-24-Storing-Images-from-iOS-in-Windows-Azure-Mobile-Services.html
disqus_identifier: Storing-Images-from-iOS-in-Windows-Azure-Mobile-Services
---
{% include special/mobile_services_to_apps.html %}

<p>
<strong>Update 3-7-2015: While this approach does work, the most recommended way to store image files in conjunction with Mobile Services is to use Blob Storage.  You can read a walkthrough of how that works <a href="http://chrisrisner.com/iOS-and-Mobile-Services-and-Windows-Azure-Storage">here</a>.
</strong>
</p>
<p><a title="Windows Azure Mobile Services" href="https://www.windowsazure.com/en-us/develop/mobile/"><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 5px 5px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" border="0" align="right" src="http://chrisrisner.com/upload/mobile-service-logo-3.png" />Windows Azure Mobile Services</a> have been blowing up in popularity since the release a few weeks ago.&#160; One of the questions I’ve received most frequently is if there is anyway to store images in Mobile Services.&#160; The answer to this is a little bit yes and a little bit no. Before proceeding, if you haven’t already taken a walk through of Mobile Services, I’d highly recommend reading through <a title="Windows Azure Mobile Services and iOS" href="http://chrisrisner.com/Windows-Azure-Mobile-Services-and-iOS">my earlier post on connecting iOS to Windows Azure Mobile Services</a>.&#160; The code I’ll show later in this article will build off the sample built in that post.&#160; If you want to skip all of the explanation, you can <a title="Saving Images branch in GitHub" href="https://github.com/WindowsAzure-Samples/MobileServices-iOS-Client/tree/savingImages">download the code for this sample from the savingImages branch in GitHub</a>.&#160; If you decide to go right to the code, I would HIGHLY recommend reading the <strong>Disclaimer</strong> first.</p> 

<p><strong>Update:</strong> I finally had the time to create a sample that connects Mobile Services to Blob Storage which is a much better approach for storing images with Mobile Services.  The way this works is that you request a Shared Access Signature (SAS) URL from your Mobile Service, the service talks to blob storage to generate the SAS and then returns it to your app, and then your app can upload the image bytes to the SAS URL safely.  I'm leaving this post up for posterity but going forward I would highly recommend you follow the approach explained <a href="http://chrisrisner.com/Mobile-Services-and-Windows-Azure-Storage">here (the iOS client is linked from this article)</a>.</p>



<p><strong><font size="3">JSON and Binary Data</font></strong></p>  <p>&#160;<a title="JSON Format" href="http://www.json.org/">JSON</a>, the data format that Mobile Services uses to send data across the wire, does not natively support binary data types so you can’t post JSON as a column in the JSON you send to the server.&#160; If you try, you’ll get back this from your post to the server:</p>  <blockquote>   <p><strong>&quot;code&quot;:400,&quot;error&quot;:&quot;The value of property 'columnName' is of an unsupported type.&quot;</strong></p> </blockquote>  <p>What is interesting is that if you manually connect to the SQL database that stores the data for you mobile service (using either <strong>SQL Server Management Studio </strong>or the <strong>Manage </strong>button in the Windows Azure portal) there isn’t anything to stop you from adding columns of unsupported types to the database.&#160; When I first wanted to look at storing an image in the database for Mobile Services, the first thing I tried was adding a Varbinary column to my table and pulling that down into my client.&#160; This actually works, kind of.&#160; When you query the table from your iOS app the Varbinary column comes back looking like this in the JSON:</p>  <blockquote>   <p>{&quot;0&quot;:1,&quot;1&quot;:35,&quot;2&quot;:0,&quot;3&quot;:0,&quot;4&quot;:0,&quot;5&quot;:0,&quot;6&quot;:0,&quot;7&quot;:0,&quot;8&quot;:0,&quot;9&quot;:0,&quot;10&quot;:0}</p> </blockquote>  <p>So you’re literally getting an array back of the bytes.&#160; As you can imagine, this wouldn’t really be ideal for taking and then reconstructing into an image.&#160; The bigger problem, though, is that you can’t post image data back to the server in the same format (you’ll get the error mentioned above).&#160; However, in trying this, I struck on another idea which does work.</p>  <p><strong><font size="3">Disclaimer</font></strong></p>  <p>While the method I’m about to describe will work, I wouldn’t recommend it unless you know what you’re doing.&#160; You’re better off with hosting a service in Windows Azure Websites which will get you a Shared Access Signature (SAS) for secure uploading to Windows Azure Blob Storage and then saving the blob’s URL to your Mobile Services database.&#160; If you’d like to take a look at doing this, you can <a title="Mobile Geolocation apps and Shared Access Signatures" href="http://chrisrisner.com/Mobile-Geolocation-Apps-with-Windows-Azure-Websites">read this series about mobile geolocation apps</a> which talks about getting a SAS URL from a PHP service (running in Windows Azure Websites) and then uploading the image.&#160; The debate about whether or not you should even store image data in a database is much to large to even be touched upon here but hopefully with this disclaimer in mind, you’ll know how to proceed.</p>  <p><strong><font size="3">The Solution</font></strong></p>  <p>The solution I’m going to explain today is to use a varchar (string) column to store the base 64 encoded string representation of an image in the Mobile Services database.&#160; Since Mobile Services is more than capable of handling string type data, it will treat this as such and now even realize it’s storing image data.&#160; We’re going to be basing our code off of the <a title="Windows Azure Mobile Services" href="http://chrisrisner.com/Windows-Azure-Mobile-Services-and-iOS">sample mentioned above</a>.&#160; You can grab the code without any of the changes we’re about to do from the <a title="Mobile Services iOS client in GitHub" href="https://github.com/WindowsAzure-Samples/MobileServices-iOS-Client">master branch of this GitHub repository</a>.</p>  <p><strong><font size="3">Changing the UI</font></strong></p>  <p>The first thing we need to do is alter our user interface to facilitate the images.&#160; Open up <strong>MainStoryboard.storyboard</strong> and take a look at the view for the <strong>TodoDetailsViewController </strong>(it should be at the far right).&#160; Before we make any changes the view will look like this:</p>  <p align="center"><img src="http://chrisrisner.com/upload/todos-view-details.jpg" width="231" height="337" /></p>  <p>We’re going to compact things a bit so we can keep our simple view and add the new controls. Everything in the top half view should be moved up and a button should be added to the left side and an ImageView to the right side.&#160; In the bottom half view, you can move things up and just add an ImageView beneath the “Mark Todo Complete” button.&#160; When you’re done, the UI should look like this:</p>  <p align="center"><img title="Mobile Services adding images UI" alt="Mobile Services adding images UI" src="http://chrisrisner.com/upload/mobile-services-ios-image-ui.jpg" width="224" height="327" /></p>  <p>Open the assistant editor and control + click and drag the new UI elements over to create an <strong>IBOutlet</strong> for each of the image views and an <strong>IBAction</strong> for the button.&#160; We’re also going to need to change <strong>TodoDetailsViewController.h </strong>so that the class implements the <strong>UIImagePickerControllerDelegate</strong> and <strong>UINavigationControllerDelegate</strong>.&#160; When you’re done, your header file will look something like this:</p>  <p><script src="https://gist.github.com/3763962.js?file=TodoDetailsViewController.h"></script></p>  <p>Now before we code the implementation, let’s solve a problem with encoding our string.</p>  <p><strong><font size="3">Handling Base 64 encoding and decoding</font></strong></p>  <p>Simply put, there isn’t anything built into Objective-C or the iOS Framework to facilitate base 64 encoding and decoding.&#160; Thankfully, a quick <a title="Base 64 encoding and decoding for iOS" href="http://cocoawithlove.com/2009/06/base64-encoding-options-on-mac-and.html">search on the internet turns up this</a>.&#160; You’ll need to <a title="NSData+Base64 Header and Class" href="http://projectswithlove.com/projects/NSData_Base64.zip">download the NSData+Base64 class and header</a> and drop them into your project.&#160; After doing so, make sure you open your project file and go to the <strong>Build Phases</strong> tab.&#160; You’ll need to expand <strong>Compile Sources</strong> and add <strong>NSData+Base64.m.&#160; </strong>When you’re done it will look like this:</p>  <p align="center"><img title="Base 64 added to sources" alt="Base 64 added to sources" src="http://chrisrisner.com/upload/mobile-services-ios-adding-base64-to-sources.jpg" /></p>  <p>Now that we can encode and decode in base 64 to our heart’s content, let’s move on to <strong>TodoDetailsViewController.m</strong>.</p>  <p><strong><font size="3">Implementing the Methods</font></strong></p>  <p>First things first, add the base 64 class to your import statements:</p>  <blockquote>   <p>#import &quot;NSData+Base64.h&quot;</p> </blockquote>  <p>Now let’s implement the <strong>tapSelectImage </strong>method:</p>  <p><script src="https://gist.github.com/3763962.js?file=tapSelectImage.m"></script></p>  <p>Here we’re creating a <strong>UIImagePickerController</strong>, telling it to use the gallery, telling it to use the view controller as it’s delegate, and presenting it to the user.&#160; The <strong>imagePickerController</strong> delegate method will use the image returned to set the image property on our ImageView:</p>  <p><script src="https://gist.github.com/3763962.js?file=imagepickercontroller.m"></script></p>  <p>Now if you run your app and tap select image and pick one from the gallery, it should show up next to the “Select Image” button.</p>  <p align="center"><img title="ios image selected" alt="ios image selected" src="http://chrisrisner.com/upload/mobile-services-ios-tapped-select-image.jpg" /></p>  <p>Let’s handle saving the image next.</p>  <p><strong><font size="3">Saving the image</font></strong></p>  <p>Go to the <strong>tapSaveTodo</strong> method.&#160; After we’ve set headers on <strong>theRequest</strong> we will pull the image property from the ImageView and base 64 encode it (provided there is an image selected).</p>  <p><script src="https://gist.github.com/3763962.js?file=tapSaveTodo.m"></script></p>  <p>Then we add the image field into the NSDictionary we create and serialize to JSON.&#160; The column name I’m using here is “coltest” but since we’re using Mobile Service’s dynamic schema, you could name it anything you want.&#160; In this situation, if there is image data we’ll pass over the encoded string for it and if there isn’t, we’ll send over nil.&#160; Now, you could run your app and try out saving, but why don’t we make loading work as well so we can test it all at once.</p>  <p><strong><font size="3">Loading the image</font></strong></p>  <p>Due to the fact that we’re storing the data that comes back from the server as an NSDictionary with all fields returned left inside it, and since we’re storing that NSDictionary on the app delegate, the change we need to make to load the image for an existing todo item is extremely small:</p>  <p><script src="https://gist.github.com/3763962.js?file=viewDidLoad.m"></script></p>  <p>Here in the <strong>viewDidLoad</strong> method we are pulling the NSString value out for “coltest”.&#160; If that isn’t null, we then base 64 decode it into NSData.&#160; We then create an UIImage from the NSData and use that to set the image property of the ImageView.&#160; Let’s run it.</p>  <p><strong><font size="3">Running the app</font></strong></p>  <p>When you run your app, you should be able to select an image and then save your todo item.&#160; When you tap back into that todo item, you should see the image along with the title:</p>  <p align="center"><img title="saving images in mobile services done" alt="saving images in mobile services done" src="http://chrisrisner.com/upload/mobile-services-ios-images-done.jpg" width="630" height="296" /></p>  <p>Additionally, if we log into the Windows Azure portal and go to our mobile service’s data page and view our table data, we can see that the string representation of our data is showing up in “coltest”:</p>  <p align="center"><img src="http://chrisrisner.com/upload/mobile-services-database-with-images.jpg" width="789" height="211" /></p>  <p><strong><font size="3">Conclusion</font></strong></p>  <p>Today we walked through one way to store images with Windows Azure Mobile Services.&#160; As noted in the disclaimer, this technique shouldn’t be used without some consideration.&#160; If you do decide to use it, one way you could mitigate long load times (you may have noticed this sample running slower due to the data being returned when it selects all of the todos) is to only select the non-image columns when you are pulling data for the TableView and select the full todo item (including the image) when the user taps into a todo.&#160; This still doesn’t solve some of the problems like increased database bandwidth and size, but it is a way of solving the problem.&#160; You can access the <a title="savingImages branch of iOS Geolocation" href="https://github.com/WindowsAzure-Samples/MobileServices-iOS-Client/tree/savingImages">completed source code for this demo under the savingImages branch of this GitHub repository</a> (just remember that you’ll <strong>need to follow the above instructions</strong> for downloading the NSData+Base64 files and including them in your compile sources as well as configure your app in the <strong>Constants.m</strong> file).</p>