---
layout: post
title: "Connecting Google Glass and Windows Azure Mobile Services"
date: Tue Sep 03 2013 09:26:00 GMT-0700 (PDT)
comments: true
status: publish
type: post
published: true
categories: [Azure, Glass, Google, Mobile Services, Javascript]
excerpt: "This post talks about how you can use Azure mobile Services to talk to Google's Mirror API and deliver information to Google Glass.  We'll use Mobile Services for every step of the process including authenticating our users and sending out the information."
logoUrl: null
keywords: Glass,Azure,Mobile Services,Google Glass,wearable,push,mirror,Mirror API,javascript
filepath: 2013-09-03-Connecting-Google-Glass-and-Windows-Azure-Mobile-Services.html
disqus_identifier: Connecting-Google-Glass-and-Windows-Azure-Mobile-Services
---
<p><img title="Me with Glass" style="float: right; margin: 0px 0px 5px 5px; display: inline" alt="Me with Glass" align="right" src="http://storage.chrisrisner.com/images/me-with-glass.jpg" width="219" height="253" />I haven’t posted about it on my blog yet (yeah I’ve meant to and still plan to) but I am a Google Glass Explorer.&#160; I’ve had my glass for just over three months now and it really is incredible.&#160; I don’t want to focus too much on why I think it’s a great device or what I commonly use it for (I’ll try to post about that soon) but instead want to focus on something I’ve spent the last few nights working on.&#160; As you can probably tell if you look at my recent entries on this site, I do a lot with <a title="Windows Azure" href="http://www.windowsazure.com/en-us/pricing/free-trial/?WT.mc_id=A3F51C28C">Windows Azure</a>.&#160; More specifically, I do a lot with <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Windows Azure Mobile Services</a>.&#160; </p>  <p><strong>Windows Azure Mobile Services</strong></p>  <p>Mobile Services is a backend-as-a-service which allows app developers to spend their time where they should: delivering the best client experience they can.&#160; It does this by providing a ton of really great features that most mobile applications need and in such a way that requires very little effort on the part of the devs.&#160; One of the great features of Mobile Services is the ability to implement your own server side logic via scripts.&#160; You can do this in two ways which are then exposed externally (via a client application or a browser): table endpoints and custom API.&#160; Table endpoints are generated whenever you create a table in your Mobile Service.&#160; When you create a table, a REST API is generated that exposes the functionality for reads, inserts, updates, and deletes (via HTTP gets, posts, patches, and deletes respectively).&#160; Each of these endpoints is connected to a script which runs on the server.&#160; These scripts by default just pass the request through to the SQL Database that backs Mobile Services.&#160; However, you can do whatever you want in these scripts.&#160; This works out very well, however, for talking to Glass, custom API is what we’re going to use.&#160; Custom APIs allow you to expose an endpoint that doesn’t map directly to a SQL Database (like the table REST APIs do) and exposes whatever functionality you want for GET, POST, PUT, PATCH, and DELETE requests.&#160; One of the great, though unusual, capabilities of these Custom API endpoints is that they can return HTML (and javascript).&#160; That means we can make a request to a custom API and end up rendering HTML and javascript.&#160; Even more so, we can conditionally do that.&#160; You’ll see what I mean as I demonstrate the authentication portion of getting ready to post to Glass.</p>  <p>You can sign up for a <a title="Free Windwos Azure Trial" href="http://www.windowsazure.com/en-us/pricing/free-trial/?WT.mc_id=A3F51C28C">free Windows Azure trial here</a>.&#160; You can read more about developing with Mobile Services for free (even after the trial) <a title="Cost of Mobile Services" href="http://bjorneriksen.blogspot.com/2013/08/pricing-of-windows-azure-mobile-services.html">here</a>.</p>  <p><strong>The Mirror API</strong></p>  <p>If you haven’t looked at what Glass offers as far as development options go, there are two things that have been announced: the <a title="Google Mirror API" href="https://developers.google.com/glass/about">Google Mirror API</a> and the <a title="Glass Development Kit" href="https://developers.google.com/glass/gdk">Glass Development Kit (GDK)</a>.&#160; The GDK is a forth-coming kit that will enable developers to build applications that run on the actual device itself.&#160; We won’t be touching on the GDK today.&#160; The Mirror API is Google’s way of allowing you to deliver information to Glass.&#160; The way it works it that you get a token when identifies your application and the Glass device you want to interact with.&#160; With that token you can ask the Mirror API to deliver information to that Glass device.&#160; This isn’t all together different from how Push Notifications work (with GCM or any other major push provider).&#160; However, there are many more additional options when it comes to delivering information to Glass.&#160; Today we’re only going to deal with the basics of delivering some text in addition to a few options that we can pass along.</p>  <p><strong>How do I test this myself?</strong></p>  <p>While I can walk everyone through the steps I used to talk to my Google Glass, as of today, not everyone will be able to do the same.&#160; In order to test out development with the Mirror API, you have to request access.&#160; As far as I’m aware, in order to request access, you need to have Glass (or someone that has Glass and access can grant you the ability to use their Google API Project that has access to the Mirror API).&#160; In short, very few people will probably be able to make use of this today.&#160; However, that number will grow and it’s not a bad idea to understand how these things work so down the road you can easily consume them.</p>  <p><strong>Setting up your Google Mirror API Access</strong></p>  <p>You may want to create your Mobile Service first as you will need to know the name of it when you set up your Google Auth Access.&#160; Once you’ve done that, the next step is to go to the <a title="Google API Console" href="http://code.google.com/apis/console">Google API Console</a> and create a new project.&#160; Once you’ve created a project, go to the <strong>Services</strong> (link in the top left of the console).&#160; From there, you’ll need to activate the Google Mirror API:</p>  <p align="center"><img title="Google Mirror API Activation" alt="Google Mirror API Activation" src="http://storage.chrisrisner.com/images/google-mirror-api.jpg" /></p>  <p>You’ll need to have been granted access before you’ll see this of course.&#160; Once that is activated, you can go to the <strong>API Access</strong> link in the top left of the console.&#160; Here you’ll need to click on <strong>Create an OAuth 2.0 client ID...</strong>:</p>  <p align="center"><img title="Create an OAuth client" alt="Create an OAuth client" src="http://storage.chrisrisner.com/images/google-auth-api-access.jpg" /></p>  <p>In the next screen, use whatever name you want and then click <strong>Next</strong>.&#160; Leave the Application Type as <strong>Web Application</strong> and for the site or hostname, you’ll enter something like this:&#160; <a href="http://glasstest.azure-mobile.net/api/glassauth">http://glasstest.azure-mobile.net/api/glassauth</a>.&#160; In this case, <strong>glasstest</strong> is the name of my Mobile Service (so change that to match your Mobile Service).&#160; <strong>glassauth </strong>is the name of the custom API I’m going to use to authenticate.&#160; After entering that, you can click <strong>Create client ID</strong>.&#160; In the screen that follows, you’ll need to copy the <strong>Client ID </strong>and <strong>Client secret</strong>.&#160; With that step done, we can move on to our Mobile Service.</p>  <p><strong>Setting up the Custom API to Redirect</strong></p>  <p>If you haven’t looked at Custom APIs before, take a look at <a title="Custom APIs in Mobile Services" href="http://chrisrisner.com/New-Features-for-Mobile-Services--Custom-API,-Script-Source-Control,-Shared-Scripts,-and-NPM-Support">this blog post</a>.&#160; It should explain some of the details on Custom APIs.&#160; Make sure the name of your first custom API matches the name in the URL you entered for your OAuth 2.0 client (so in the case above, <strong>glassauth</strong>).&#160; We’re only going to use the <strong>GET</strong> request for this API, so set the permissions for the <strong>GET</strong> to <strong>Everyone</strong>.&#160; That way, anything can access the method without needing any other information.&#160; Once this API is created, we can start by handling the first operation, redirecting users to the Google Auth page.&#160; This is done easily enough with the following script:</p>  <p><script src="https://gist.github.com/ChrisRisner/6374682.js?file=InitialRedirect.js"></script></p>  <p>The first thing we do is generate a redirect URL.&#160; This is the URL we will push the user to after they hit the API.&#160; The URL we’re going to use is <strong><a href="https://accounts.google.com/o/oauth2/auth?response_type=code">https://accounts.google.com/o/oauth2/auth?response_type=code</a></strong> and as parameters, we pass:</p>  <ul>   <li>the redirect URI (which is the URI of our custom API since we want to return to it after authenticating) </li>    <li>the client ID (this is the client ID from the Google API Console we just set up) </li>    <li>the scopes (these are the “permissions” we are requesting access to) which include:      <ul>       <li>glass.timeline </li>        <li>glass.location </li>        <li>userinfo.profile </li>     </ul>   </li>    <li>the access type (offline) </li>    <li>approval prompt (forced) </li> </ul>  <p>Next we respond to the request to our custom API (using <strong>response.send</strong>) and specify that the response code is a 200 (everything is OK) and that the response is some HTML with a little javascript mixed in.&#160; specifically we’re just redirecting the browser to the redirect URL we just generated.&#160; Doing so means that when the user goes to our custom API in the browser, they’ll get this:</p>  <p align="center"><img title="Glass Auth Approval" alt="Glass Auth Approval" src="http://storage.chrisrisner.com/images/glass-auth-approval.jpg" /></p>  <p>After the user clicks <strong>Accept</strong> then the user is redirected back to our custom API (due to the redirect_uri property we specified).&#160; </p>  <p><strong>Handling the Auth Response</strong></p>  <p>When the auth page posts back to our custom API, it includes a query string parameter named <strong>code</strong>.&#160; We’re already using the custom API to handle the redirect, so now we need to check if that code parameter is there and if it is, we shouldn’t do the redirect again:</p>  <p><script src="https://gist.github.com/ChrisRisner/6374682.js?file=codeOrRedirect.js"></script></p>  <p>If the <strong>code</strong> parameter is there, we’ll do something else, otherwise we’ll do the redirect.&#160; Once we do have the code, we can pull that out and then post it to another Google URL (<a href="https://accounts.google.com/o/oauth2/token">https://accounts.google.com/o/oauth2/token</a>) and request an <strong>access_token</strong>.&#160; We can do this in our script like this:</p>  <p><script src="https://gist.github.com/ChrisRisner/6374682.js?file=postForToken.js"></script></p>  <p>First we get access to the <strong>request</strong> module and then we post to that URL.&#160; The data we post is the <strong>code</strong>, the URL of our custom API to redirect back to, our client ID, client Secret, and what sort of grant type we want (in this case we’re using <strong>authorization_code</strong>).&#160; The response from that request contains several things including:</p>  <ul>   <li>access_token – we use this to tell the Mirror API what device to deliver to </li>    <li>refresh_token – this token can be used to get new access_tokens (when they expire) without the involvement of the user (only granted because we used the <strong>access_type</strong> of <strong>offline</strong> in our initial auth / permission request. </li>    <li>an expiration (when the access_token expires) </li>    <li>id_token – this is a JSON Web Token that we’ll use to get the user’s ID </li> </ul>  <p>We could stop here and just save the user’s <strong>access_token</strong> and <strong>refresh_token</strong>.&#160; We only need to push to the Mirror API with the <strong>access_token</strong> and get a new token with the <strong>refresh_token</strong> whenever the <strong>access_token </strong>expires.&#160; However, as you might imagine, it would be nice to be able to tie the tokens we have back to a specific user.&#160; In order to do that, we need to get a user ID.</p>  <p><strong>Fetching a User ID</strong></p>  <p>We already have an <strong>id_token </strong>which contains the user ID, we just need some way to extract that information.&#160; Thankfully, Google provides another URL we can do a request to to retrieve it: <a href="https://www.googleapis.com/oauth2/v1/tokeninfo?id_token=my_id_token">https://www.googleapis.com/oauth2/v1/tokeninfo?id_token=my_id_token</a>.&#160; We do a HTTP GET request against this URL and the response back will contain, among other things, the <strong>user_id</strong>.&#160; Once we have this, we can save this information into our Mobile Service’s database (in this case I’ve created a table named <strong>Accounts</strong>) for this and then let the user they are good to go (by returning more HTML).&#160; You can see the full script here:</p>  <p><script src="https://gist.github.com/ChrisRisner/6374682.js?file=glassauth.js"></script></p>  <p><strong>Posting to Glass</strong></p>  <p>Once we’ve done all of the auth stuff, posting to Glass becomes incredibly easy.&#160; We just need to pull the information out of our <strong>Accounts</strong> table and then use the <strong>access_token</strong> as part of the post.&#160; Here’s a custom API script that will post the text “Check this stuff out!” whenever the API is hit with a GET request:</p>  <p><script src="https://gist.github.com/ChrisRisner/6374682.js?file=postToGlass.js"></script></p>  <p>The first thing we’ll point out is that we’re posting to <a href="https://www.googleapis.com/mirror/v1/timeline?access_token=my_token">https://www.googleapis.com/mirror/v1/timeline?access_token=my_token</a>.&#160; If we didn’t want to include the token as a query string parameter, we could also put it in an <strong>Authorization </strong>header (read more about <a title="Auth options when calling an API" href="https://developers.google.com/accounts/docs/OAuth2WebServer#callinganapi">authorization options when calling APIs here</a>).&#160; Next we specify the content type and say that we’ll be sending over JSON.&#160; Finally we specify the body.&#160; Here we’re sending specific text over and then specifying a <strong>notification </strong>and <strong>menuItems</strong>.&#160; Both <strong>notification</strong> and <strong>menuItems</strong> are optional and the post will go through just fine without them.&#160; However, if we don’t include the <strong>notification</strong>, then the device won’t let the user know (via a vibration and a chirp in their ear) that they’ve received a new card.&#160; If we don’t include the&#160; <strong>DELETE</strong> menu item, then the user won’t be able to delete the card from their timeline.&#160; Both the <strong>DEFAULT</strong> notification level and the <strong>DELETE</strong> menu item are built in options that Glass knows what to do with, we just need to specify them.&#160; When we do send this over then we end up seeing this delivered to the device:</p>  <p align="center"><img title="Post to Glass" alt="Post to Glass" src="http://storage.chrisrisner.com/images/glass-post.jpg" /></p>  <p>Sending text over and specifying a notification and the ability to delete really just scratches the surface of what you can send to Glass.&#160; There are tons of different options for what you can send over and how Glass can then interact with your card.&#160; You can read more about the different options for <a title="Inserting to the Glass Timeline" href="https://developers.google.com/glass/v1/reference/timeline/insert">inserting to the Glass timeline here</a>.&#160; One of the great things to note is that, with the exception of sending actual media data over (bytes), everything is just JSON.&#160; This means it’s super simple to send this stuff from a Mobile Service script.&#160; Even the media can be sent over, it’s just a little more work than I’m demonstrating here.</p>  <p><strong>Summary</strong></p>  <p>The Mirror API is the only official way you can currently send information to a Glass device.&#160; Thankfully, interacting with it is pretty straightforward and is built off of very common standards: JSON, OAuth, HTTP, REST.&#160; While there are <a title="Quick Start for talking to Glass" href="https://developers.google.com/glass/quickstart/index">quick starts for interacting with Glass in several languages</a> (currently Go, Java, .NET, PHP, Python, and Ruby), you should be able to talk to Glass from many other languages and platforms if you want.&#160; <a title="Windows Azure Mobile Services" href="http://www.windowsazure.com/mobile">Mobile Services</a> is a backend-as-a-service that exposes tons of great functionality regardless of if you’re building a mobile app for Android, iOS, Windows Phone, or the Windows Store or if you’re building a web site, console app, or anything else.&#160; Being able to talk to Glass from Mobile Services is pretty simple as well.&#160; Maybe one day, down the road, pushing to Glass will be built into Mobile Services just like push notifications are for the other platforms (this is actually quite realistic since you just need to do Google Auth (which is built into Mobile Services) and maintain a token).&#160; I hope this helps you think about new ways of delivering information to different devices and expands what you think Mobile Services is capable of.</p>